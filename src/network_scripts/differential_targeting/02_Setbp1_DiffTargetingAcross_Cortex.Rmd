---
title: "02_Setbp1_DiffTargetingAcross_Cortex"
author: "Jordan Whitlock"
date: '2023-05-15'
output: html_document
---

This analysis determines differential gene targeting scores across cell types between conditions from the PANDA regulatory networks in order to identify cell-specific gene targeting. This analysis provides insight into how targeting is changing at the "tissue" level. All networks below were filtered to only include positive weights. 

Targeting code was adapted from: http://netbooks.networkmedicine.org/user/b04f15be-cbd3-44df-932f-6e9026018fd0/notebooks/netZooR/lioness_tcga_targeting_netbook.ipynb

#load in required libraries & functions
```{r loading-libraries-functions, results='hide'}
set.seed(2178)
library(netZooR)
library(data.table)
library(dplyr)
library(limma)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(magrittr)
library(circlize)
library(readr)
library(gprofiler2)
library(here)
source(here("src/functions/functions.R"))
library(styler)
library(lintr)
```

## load gene set
```{r loading-geneset}
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")
```

## setting heatmap data needed for the rest of the script
```{r heatmap-color-annotation}
# setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory_neurons" = "#DC71FA", "inhibitory_neurons" = "#00BBDB", "oligodendrocytes" = "#7997FF", "astrocytes" = "#6968B4", "microglia" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro_cortex" = "#0a2f6f"))
```

## load in targeting objects:
```{r}
load(here("data/gene_targeting_ctrl.Rdata"))
load(here("data/gene_targeting_het.Rdata"))
```

# Investigate targeting differences across Het cell types:
```{r find-top-targeted-genes-across-het-celltypes}
# identify the maximum for each row
het_max <- do.call(pmax, gene_targeting_all_het[, -1]) # finding max for each gene across cell types

# subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- het_max - gene_targeting_all_het[, -1]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)

#converting het_max to dataframe for differential targeting analysis below
het_max <- as.data.frame(het_max)
rownames(het_max) <- gene_targeting_all_het$gene

# adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_het$gene

# sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq_len(nrow(gene_targeting_ranked))

# adding rank to targeting score dataframe
gene_targeting_all_het <- merge(select(gene_targeting_ranked, c("rank", "gene")), gene_targeting_all_het, by = "gene")
gene_targeting_all_het <- arrange(gene_targeting_all_het, rank)
```

```{r visualize-het-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_het, values_to = "targeting_score", names_to = "cell_type", cols = -c("gene", "rank"))
pivoted


png(
  filename = here("results/diff_targeting/cortex_gene_targeting_dist_het.png"),
  width = 1000,
  height = 500
)
ggplot(data = pivoted, aes(x = targeting_score, group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("cortex Gene Targeting Score Distribution in S858R Mice") +
  theme_bw() +
  scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB", "#C216B7", "#027461", "#7997FF", "#00C1AA"))
dev.off()
```

## plotting targeting heatmaps
```{r visualizing-het-gene-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_het
rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_all_het_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = FALSE)
```

```{r visualizing-het-gene-top100-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_het %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:3)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_targeting_het_top100_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE)
```

```{r visualizing-setbp1-targets-gene-targeting-across-het}
# formatting input data
data <- gene_targeting_all_het[gene_targeting_all_het$gene %in% setbp1_genes, ]

rownames(data) <- data$gene
data <- data[, -c(1:3)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_het_setbp1targets_across_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Gene targeting of Setbp1 and it's targets Across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, width = 1000, height = 2000)
```

# Investigate targeting differences across ctrl cell types:

```{r find-top-targeted-genes-across-ctrl-celltypes}
# identify the maximum for each row
ctrl_max <- do.call(pmax, gene_targeting_all_ctrl[, -1]) # finding max for each gene across cell types

# subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- ctrl_max - gene_targeting_all_ctrl[, -1]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)

# converting ctrl_max to dataframe for differential targeting analysis below
ctrl_max <- as.data.frame(ctrl_max)
rownames(ctrl_max) <- gene_targeting_all_ctrl$gene

# adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_ctrl$gene

# sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq_len(nrow(gene_targeting_ranked))

# adding rank to targeting score dataframe
gene_targeting_all_ctrl <- merge(select(gene_targeting_ranked, c("rank", "gene")), gene_targeting_all_ctrl, by = "gene")
gene_targeting_all_ctrl <- arrange(gene_targeting_all_ctrl, rank)
```

```{r visualize-ctrl-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_ctrl, values_to = "targeting_score", names_to = "cell_type", cols = -c("gene", "rank"))
pivoted

png(
  filename = here("results/diff_targeting/cortex_gene_targeting_dist_ctrl.png"),
  width = 1000,
  height = 500
)
ggplot(data = pivoted, aes(x = targeting_score, group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("cortex Gene Targeting Score Distribution in Ctrl Mice") +
  theme_bw() +
  scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB", "#C216B7", "#027461", "#7997FF", "#00C1AA"))
dev.off()

summary(gene_targeting_all_ctrl)
```

```{r visualizing-ctrl-gene-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_ctrl
rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_all_ctrl_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-gene-top100-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_ctrl %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_targeting_ctrl_top100_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 Ctrl Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE)
```

```{r visualizing-setbp1-targets-genes-targeting-across-ctrl}
data <- gene_targeting_all_ctrl[gene_targeting_all_ctrl$gene %in% setbp1_genes, ]

rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_targeting_ctrl_setbp1targets_across_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Gene targeting of Setbp1 and its targets Across Cell-types in Setbp1 Control Kidey Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE)
```

## Calculate differential gene targeting across cell types
GOAL: ID genes with largest difference in targeting _between conditions within each cell type_:
* Using the combined het/ctrl dataframe for each cell type above, find the cell type with highest targeting score for each gene (row maximum)
* Divide all values in a row by the maximum for that row
* Calculate the difference (het-ctrl) for the targeting weight where the more positive difference indicates higher gene targeting in het. 
* The closer a value is to 0, the less difference in targeting between conditions for that cell type

```{r rearrange-data-calc-diff}
#ensure dataframes are ordered the same and divide every row by its maximum
gene_targeting_all_ctrl <- gene_targeting_all_ctrl[match(rownames(ctrl_max), gene_targeting_all_ctrl$gene), ]
gene_names <- gene_targeting_all_ctrl$gene
gene_targeting_all_ctrl <- subset(gene_targeting_all_ctrl, select = -c(rank, gene))
gene_targeting_all_ctrl <- gene_targeting_all_ctrl / ctrl_max$ctrl_max
gene_targeting_all_ctrl$gene <- gene_names

#ensure dataframes are ordered the same and divide every row by its maximum
gene_targeting_all_het <- gene_targeting_all_het[match(rownames(het_max), gene_targeting_all_het$gene), ]
gene_names <- gene_targeting_all_het$gene
gene_targeting_all_het <- subset(gene_targeting_all_het, select = -c(rank, gene))
gene_targeting_all_het <- gene_targeting_all_het / het_max$het_max
gene_targeting_all_het$gene <- gene_names

# ordering data the same
gene_targeting_all_het <- gene_targeting_all_het[order(gene_targeting_all_het["gene"]), ]
gene_targeting_all_ctrl <- gene_targeting_all_ctrl[order(gene_targeting_all_ctrl["gene"]), ]

# Add suffix to column names except the gene column
new_colnames <- ifelse(names(gene_targeting_all_het) != "gene", paste0(names(gene_targeting_all_het), "_het"), names(gene_targeting_all_het))
names(gene_targeting_all_het) <- new_colnames
print(gene_targeting_all_het) # Print the updated dataframe

new_colnames <- ifelse(names(gene_targeting_all_ctrl) != "gene", paste0(names(gene_targeting_all_ctrl), "_ctrl"), names(gene_targeting_all_ctrl))
names(gene_targeting_all_ctrl) <- new_colnames
print(gene_targeting_all_ctrl) # Print the updated dataframe

# binding data together
combined_gene_targeting <- merge(gene_targeting_all_het, gene_targeting_all_ctrl, by = "gene")
```

```{r calculate-het-enriched-diff-targeting}
# creating empty data frame
diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
colnames(diff_gene_targeting) <- "gene" 
diff_gene_targeting$gene <- combined_gene_targeting$gene # adding gene

# calc diff targeting
cell_names <- colnames(gene_targeting_all_ctrl) %>% .[which(. != "gene")] %>% sub("_ctrl.*", "", .) # all cell type prefixes except gene name, which should be first column in data
for (i in cell_names) {
  selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_gene_targeting[[selected_columns[1]]] - combined_gene_targeting[[selected_columns[2]]] # ensure difference is `het - control` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_gene_targeting[[diff_colname]] <- diff_col
  }
}

het_enriched <- replace(diff_gene_targeting, diff_gene_targeting[, ] < 0, 0) # creating dataframe where the differential is enriched in the het condition
save(het_enriched, file = here("results/diff_targeting/cortex_het_enriched_gene_across.Rdata"))
```

```{r calculate-ctrl-enriched-diff-targeting}
# creating empty data frame
diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
colnames(diff_gene_targeting) <- "gene" 
diff_gene_targeting$gene <- combined_gene_targeting$gene # adding gene

# calc diff targeting
for (i in cell_names) {
  selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_gene_targeting[[selected_columns[2]]] - combined_gene_targeting[[selected_columns[1]]] # ensure difference is `control - het` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_gene_targeting[[diff_colname]] <- diff_col
  }
}

ctrl_enriched <- replace(diff_gene_targeting, diff_gene_targeting[, ] < 0, 0) # creating dataframe where the differential is enriched in the ctrl condition
save(ctrl_enriched, file = here("results/diff_targeting/cortex_ctrl_enriched_gene_within.Rdata"))
```

```{r visualizing-all-diff-gene-het-enriched}
## formatting input data
data <- het_enriched
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_across_across_het_enriched_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of S858R enriched genes across cell-types in Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-all-diff-gene-het-enriched-setbp1genes}
# filtering for gene set
data <- het_enriched[het_enriched$gene %in% setbp1_genes, ]

names <- data$gene # add names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_across_het_Setbp1targets_enriched_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Gene Targeting across cell-types of known targets of Setbp1 in S858R enriched genes of Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 2200)
```

```{r GO-difftargeting-genes-Setbp1Target-het-enriched}
## pathway analysis and plotting
exclude_column <- "gene" # note: this needs to be changed for gene, indicates which columns to pivot longer below,
data <- het_enriched[het_enriched$gene %in% setbp1_genes, ] %>%
  pivot_longer(., cols = which(colnames(.) != exclude_column), names_to = "cell_type", values_to = "targeting_score") %>%
  .[!.$targeting_score == 0, ]

for (i in cell_names) {
  # grab genes from cell type i ----------
  top <- data[data$cell_type == i, ]
  genes <- as.character(top$gene)
  # submit genes to pathway analysis function ----------
  fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
  png(paste0(here("results/diff_targeting/"), "DiffTargeting_across_", i, "genes_ Setbp1targets_het_enriched.png"), width = 1000, height = 1000)
  # plot dotplot and add title based on input variable ----------
  plot <- bubbleplot(fea_result_filt) +
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) across cell-types in Setbp1 S858R ", i)) +
    theme(plot.title = element_text(hjust = 0.5, size = 12)) +
    theme_minimal()
  print(plot)
  dev.off()
  print(paste0("pathways investigated and plotted in ", i))
}
``` 


```{r visualizing-all-diff-gene-ctrl-enriched}
## formatting input data
data <- ctrl_enriched
names <- data$gene # add gene names as rownames
data <- abs(data[, -1])
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_across_ctrl_enriched_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of Control enriched genes across cell-types in Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualize-distribution-of-het-gene-difftargeting-scores}
# het gene distribution
exclude_column <- "gene"

pivoted <- pivot_longer(het_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched) != exclude_column))
ggplot(data = pivoted, aes(x = targeting_score, group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene targeting score distribution across cell types in S8585R") +
  scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB", "#C216B7", "#027461", "#7997FF", "#00C1AA"))
summary(het_enriched)
```


```{r het-diff-gene-targeting-distribution-nonzero}
# het gene distribution nonzero
nonzero <- pivoted[pivoted$targeting_score != 0, ]
png(
  filename = here("results/diff_targeting/cortex_difftargeting_across_het_gene_distribution.png"),
  width = 1000,
  height = 500
)
ggplot(data = nonzero, aes(x = targeting_score, group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene differential targeting score distribution across cell types in S8585R") +
  theme_bw() +
  scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB", "#C216B7", "#027461", "#7997FF", "#00C1AA"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from = cell_type, values_from = targeting_score)
summary(nonzero_long)

exclude_column <- "gene"
pivoted <- pivot_longer(het_enriched_gene, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched_gene) != exclude_column))
summary(het_enriched)
```

```{r control-diff-gene-targeting-distribution}
# control gene distribution
exclude_column <- "gene"
pivoted <- pivot_longer(ctrl_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(ctrl_enriched) != exclude_column))
ggplot(data = pivoted, aes(x = abs(targeting_score), group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene targeting score distribution across cell types in Control") +
  scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB", "#C216B7", "#027461", "#7997FF", "#00C1AA"))

summary(ctrl_enriched)


nonzero <- pivoted[pivoted$targeting_score != 0, ]
png(
  filename = here("results/diff_targeting/cortex_difftargeting_across_ctrl_gene_distribution.png"),
  width = 1000,
  height = 500
)
ggplot(data = nonzero, aes(x = abs(targeting_score), group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene differential targeting score distribution across cell types in Control") +
  theme_bw() +
  scale_color_manual(values = c("#6968B4", "#DC71FA", "#0a2f6f", "#00BBDB", "#C216B7", "#027461", "#7997FF", "#00C1AA"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from = cell_type, values_from = targeting_score)
nonzero_long <- abs(nonzero_long[, which(colnames(nonzero_long) != exclude_column)])
summary(nonzero_long)
```

```{r find-top-diff-targeted-genes-het-celltypes}
cell_names <- colnames(het_enriched) %>% .[which(. != "gene")] # note: need to change for gene, grabbing cell type names
cell_names

# rank genes by targeting for each cell type , find top 20
gene_diff_het <- list() # creating empty list to store within

for (i in cell_names) {
  rank_het <- het_enriched[, names(het_enriched) %in% c("gene", i)] %>% 
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  gene_diff_het[[i]] <- rank_het
}

cortex_het_enriched_top_genes <- do.call(bind_rows, gene_diff_het) # collapsing list into single df using row binding

# rank genes by targeting for each cell type for all data
gene_diff_het <- list() # creating empty list to store within

for (i in cell_names) {
  rank_het <- het_enriched[, names(het_enriched) %in% c("gene", i)] %>% 
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  gene_diff_het[[i]] <- rank_het
}

cortex_het_enriched_all_genes <- do.call(bind_rows, gene_diff_het) # collapsing list into single df using row binding
```

```{r visualize-het-enriched-gene-top20-heatmap}
## formatting input data
data <- cortex_het_enriched_top_genes[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_across_top20_het_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 2000)
```

```{r GO-difftargeting-top20genes-het-enriched}
## pathway analysis and plotting
data <- cortex_het_enriched_top_genes

for (i in cell_names) {
  top <- data[data$cell_type == i, ]
  genes <- as.character(top$gene)
  # submit genes to pathway analysis function ----------
  fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
  png(paste0(here("results/diff_targeting/"), "DiffTargeting_across", i, "_top20_genes_het_enriched.png"), width = 1000, height = 1000)
  # plot dotplot and add title based on input variable ----------
  plot <- bubbleplot(fea_result_filt) +
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes across cell types in Setbp1 S858R ", i)) +
    theme(plot.title = element_text(hjust = 0.5, size = 12)) +
    theme_minimal()
  print(plot)
  dev.off()
  print(paste0("pathways investigated and plotted in ", i))
}
```


```{r find-top-diff-targeted-genes-ctrl-celltypes}
cell_names <- colnames(ctrl_enriched) %>% .[which(. != "gene")] # note: need to change for gene, grabbing cell type names
cell_names

# rank genes by targeting for each cell type , find top 20
gene_diff_ctrl <- list() # creating empty list to store within

for (i in cell_names) {
  rank_ctrl <- ctrl_enriched[, names(ctrl_enriched) %in% c("gene", i)] %>% 
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  gene_diff_ctrl[[i]] <- rank_ctrl
}

cortex_ctrl_enriched_top_genes <- do.call(bind_rows, gene_diff_ctrl) # collapsing list into single df using row binding

# rank genes by targeting for each cell type for all data
gene_diff_ctrl <- list() # creating empty list to store within

for (i in cell_names) {
  rank_ctrl <- ctrl_enriched[, names(ctrl_enriched) %in% c("gene", i)] %>% 
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  gene_diff_ctrl[[i]] <- rank_ctrl
}

cortex_ctrl_enriched_all_genes <- do.call(bind_rows, gene_diff_ctrl) # collapsing list into single df using row binding
```

```{r visualize-ctrl-enriched-gene-top20-heatmap}
## formatting input data
data <- cortex_ctrl_enriched_top_genes[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_across_top20_ctrl_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes across Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 2000)
```

```{r GO-difftargeting-top20genes-ctrl-enriched}
## pathway analysis and plotting
data <- cortex_ctrl_enriched_top_genes

for (i in cell_names) {
  # grab genes from cell type i ----------
  top <- data[data$cell_type == i, ]
  genes <- as.character(top$gene)
  # submit genes to pathway analysis function ----------
  fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
  png(paste0(here("results/diff_targeting/"), "DiffTargeting_across_", i, "_top20_genes_ctrl_enriched.png"), width = 1000, height = 1000)
  # plot dotplot and add title based on input variable ----------
  plot <- bubbleplot(fea_result_filt) +
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted genes across cell-types in Setbp1 S858R ", i)) +
    theme(plot.title = element_text(hjust = 0.5, size = 12)) +
    theme_minimal()
  print(plot)
  dev.off()
  print(paste0("pathways investigated and plotted in ", i))
}
```

```{r}
proc.time()
```
 
```{r}
# run style
style_file(here("src/network_scripts/differential_targeting/02_Setbp1_DiffTargetingAcross_Cortex.Rmd")) #commented out after being run once
# lintr was run as well
```

```{r}
sessionInfo()
```

