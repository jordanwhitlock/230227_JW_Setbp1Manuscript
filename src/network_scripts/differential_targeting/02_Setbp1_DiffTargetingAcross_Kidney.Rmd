---
title: "02_Setbp1_DiffTargetingAcross_Kidney"
author: "Jordan Whitlock"
date: '2023-05-15'
output: html_document
---

This analysis determines differential gene targeting scores across cell types between conditions from the PANDA regulatory networks in order to identify cell-specific gene targeting. This analysis provides insight into how targeting is changing at the "tissue" level. All networks below were filtered to only include positive weights. 

#load in required libraries & functions
```{r loading-libraries-functions, results='hide'}
set.seed(2178)
library(netZooR)
library(data.table)
library(dplyr)
library(limma)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(magrittr)
library(circlize)
library(readr)
library(gprofiler2)
library(here)
source(here("src/functions/functions.R"))
library(styler)
library(lintr)
ptm <- proc.time()
```

## load gene set
```{r loading-geneset}
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")
```

## setting heatmap data needed for the rest of the script
```{r heatmap-color-annotation}
# setting annotation colors
annotation_colors <- list("cell_type" = c("Bcell" = "#FFBE1D",
                                          "CDIC_typeA" = "#4E3801",
                                          "CDIC_typeB" = "#EEDF37",
                                          "CDPC" = "#F03F00",
                                          "DCT" = "#6D0404",
                                          "DLH" = "#AA6320",
                                          "LOH" = "#CF9400",
                                          "PCTS1" = "#FFC8C4",
                                          "PCTS2" = "#AA937E",
                                          "PST" = "#C70F0F",
                                          "PT" = "#A85A5A",
                                          "endothelial" = "#BD085E",
                                          "fibroblasts" = "#948802",
                                          "macrophages" = "#FFE196",
                                          "pericytes" = "#FF7600",
                                          "podocytes" = "#F8766D",
                                          "smcs" = "#FFE196"))
```

## load in targeting objects:
```{r}
load(here("data/kidney_gene_targeting_ctrl.Rdata"))
load(here("data/kidney_gene_targeting_het.Rdata"))
```

# Investigate targeting differences across Het cell types:
```{r find-top-targeted-genes-across-het-celltypes}
# identify the maximum for each row
het_max <- do.call(pmax, gene_targeting_all_het[, -1]) # finding max for each gene across cell types

# subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- het_max - gene_targeting_all_het[, -1]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)

# converting het_max to dataframe for differential targeting analysis below
het_max <- as.data.frame(het_max)
rownames(het_max) <- gene_targeting_all_het$gene

# adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_het$gene

# sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq_len(nrow(gene_targeting_ranked))

# adding rank to targeting score dataframe
gene_targeting_all_het <- merge(select(gene_targeting_ranked, c("rank", "gene")),
                                gene_targeting_all_het,
                                by = "gene")
gene_targeting_all_het <- arrange(gene_targeting_all_het, rank)
```

```{r visualize-het-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_het,
                        values_to = "targeting_score",
                        names_to = "cell_type",
                        cols = -c("gene", "rank"))
pivoted


png(
  filename = here("results/diff_targeting/kidney_gene_targeting_across_dist_het.png"),
  width = 1000,
  height = 500
)
ggplot(data = pivoted, aes(x = targeting_score,
                           group = cell_type,
                           color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("kidney Gene Targeting Score Distribution in S858R Mice") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D",
                                "#4E3801",
                                "#EEDF37",
                                "#F03F00",
                                "#6D0404",
                                "#AA6320",
                                "#CF9400",
                                "#FFC8C4",
                                "#AA937E",
                                "#C70F0F",
                                "#A85A5A",
                                "#BD085E",
                                "#948802",
                                "#FFE196",
                                "#FF7600",
                                "#F8766D",
                                "#FFE196"))
dev.off()
```

## plotting targeting heatmaps
```{r visualizing-het-gene-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_het
rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_across_all_het_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 S858R Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = FALSE)
```

```{r visualizing-het-gene-top100-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_het %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:3)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_targeting_across_het_top100_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 S858R Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE)
```

```{r visualizing-setbp1-targets-gene-targeting-across-het}
# formatting input data
data <- gene_targeting_all_het[gene_targeting_all_het$gene %in% setbp1_genes, ]

rownames(data) <- data$gene
data <- data[, -c(1:3)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_het_setbp1targets_across_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Gene targeting of Setbp1 and it's targets Across Cell-types in Setbp1 S858R Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, width = 1000, height = 2100)
```

# Investigate targeting differences across ctrl cell types:

```{r find-top-targeted-genes-across-ctrl-celltypes}
# identify the maximum for each row
ctrl_max <- do.call(pmax, gene_targeting_all_ctrl[, -1]) # finding max for each gene across cell types

# subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- ctrl_max - gene_targeting_all_ctrl[, -1]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)

# converting ctrl_max to dataframe for differential targeting analysis below
ctrl_max <- as.data.frame(ctrl_max)
rownames(ctrl_max) <- gene_targeting_all_ctrl$gene

# adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_ctrl$gene

# sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq_len(nrow(gene_targeting_ranked))

# adding rank to targeting score dataframe
gene_targeting_all_ctrl <- merge(select(gene_targeting_ranked, c("rank", "gene")), gene_targeting_all_ctrl, by = "gene")
gene_targeting_all_ctrl <- arrange(gene_targeting_all_ctrl, rank)
```

```{r visualize-ctrl-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_ctrl,
                        values_to = "targeting_score",
                        names_to = "cell_type",
                        cols = -c("gene", "rank"))
pivoted

png(
  filename = here("results/diff_targeting/kidney_gene_targeting_across_dist_ctrl.png"),
  width = 1000,
  height = 500
)
ggplot(data = pivoted, aes(x = targeting_score, group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("kidney Gene Targeting Score Distribution in Ctrl Mice") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D",
                                "#4E3801",
                                "#EEDF37",
                                "#F03F00",
                                "#6D0404",
                                "#AA6320",
                                "#CF9400",
                                "#FFC8C4",
                                "#AA937E",
                                "#C70F0F",
                                "#A85A5A",
                                "#BD085E",
                                "#948802",
                                "#FFE196",
                                "#FF7600",
                                "#F8766D",
                                "#FFE196"))
dev.off()

summary(gene_targeting_all_ctrl)
```

```{r visualizing-ctrl-gene-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_ctrl
rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_across_all_ctrl_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 Ctrl Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-gene-top100-rank-with-heatmap}
# formatting input data
data <- gene_targeting_all_ctrl %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_targeting_across_ctrl_top100_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 Ctrl Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE)
```

```{r visualizing-setbp1-targets-genes-targeting-across-ctrl}
data <- gene_targeting_all_ctrl[gene_targeting_all_ctrl$gene %in% setbp1_genes, ]

rownames(data) <- data$gene
data <- data[, -c(1:2)]
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_ctrl_setbp1targets_across_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Gene targeting of Setbp1 and its targets Across Cell-types in Setbp1 Control Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE)
```

## Calculate differential gene targeting across cell types
GOAL: ID genes with largest difference in targeting _between conditions within each cell type_:
* Using the combined het/ctrl dataframe for each cell type above, find the cell type with highest targeting score for each gene (row maximum)
* Divide all values in a row by the maximum for that row
* Calculate the difference (het-ctrl) for the targeting weight where the more positive difference indicates higher gene targeting in het. 
* The closer a value is to 0, the less difference in targeting between conditions for that cell type

```{r rearrange-data-calc-diff}
# ensure dataframes are ordered the same and divide every row by its maximum
gene_targeting_all_ctrl <- gene_targeting_all_ctrl[match(rownames(ctrl_max), gene_targeting_all_ctrl$gene), ]
gene_names <- gene_targeting_all_ctrl$gene
gene_targeting_all_ctrl <- subset(gene_targeting_all_ctrl, select = -c(rank, gene))
gene_targeting_all_ctrl <- gene_targeting_all_ctrl / ctrl_max$ctrl_max
gene_targeting_all_ctrl$gene <- gene_names

# ensure dataframes are ordered the same and divide every row by its maximum
gene_targeting_all_het <- gene_targeting_all_het[match(rownames(het_max), gene_targeting_all_het$gene), ]
gene_names <- gene_targeting_all_het$gene
gene_targeting_all_het <- subset(gene_targeting_all_het, select = -c(rank, gene))
gene_targeting_all_het <- gene_targeting_all_het / het_max$het_max
gene_targeting_all_het$gene <- gene_names

# ordering data the same
gene_targeting_all_het <- gene_targeting_all_het[order(gene_targeting_all_het["gene"]), ]
gene_targeting_all_ctrl <- gene_targeting_all_ctrl[order(gene_targeting_all_ctrl["gene"]), ]

# Add suffix to column names except the gene column
new_colnames <- ifelse(names(gene_targeting_all_het) != "gene",
                       paste0(names(gene_targeting_all_het), "_het"), names(gene_targeting_all_het))
names(gene_targeting_all_het) <- new_colnames
print(gene_targeting_all_het) # Print the updated dataframe

new_colnames <- ifelse(names(gene_targeting_all_ctrl) != "gene",
                       paste0(names(gene_targeting_all_ctrl), "_ctrl"), names(gene_targeting_all_ctrl))
names(gene_targeting_all_ctrl) <- new_colnames
print(gene_targeting_all_ctrl) # Print the updated dataframe

# binding data together
combined_gene_targeting <- merge(gene_targeting_all_het, gene_targeting_all_ctrl, by = "gene")
```

```{r calculate-het-enriched-diff-targeting}
# creating empty data frame
diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
colnames(diff_gene_targeting) <- "gene"
diff_gene_targeting$gene <- combined_gene_targeting$gene # adding gene

# calc diff targeting
cell_names <- colnames(gene_targeting_all_ctrl) %>%
  .[which(. != "gene")] %>%
  sub("_ctrl.*", "", .) # all cell type prefixes except gene name, which should be first column in data
for (i in cell_names) {
  selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_gene_targeting[[selected_columns[1]]] - combined_gene_targeting[[selected_columns[2]]] # ensure difference is `het - control` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_gene_targeting[[diff_colname]] <- diff_col
  }
}

het_enriched <- replace(diff_gene_targeting, diff_gene_targeting[, ] < 0, 0) # creating dataframe where the differential is enriched in the het condition
save(het_enriched, file = here("results/diff_targeting/kidney_het_enriched_gene_across.Rdata"))
```

```{r calculate-ctrl-enriched-diff-targeting}
# creating empty data frame
diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
colnames(diff_gene_targeting) <- "gene"
diff_gene_targeting$gene <- combined_gene_targeting$gene # adding gene

# calc diff targeting
for (i in cell_names) {
  selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_gene_targeting[[selected_columns[2]]] - combined_gene_targeting[[selected_columns[1]]] # ensure difference is `control - het` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_gene_targeting[[diff_colname]] <- diff_col
  }
}

ctrl_enriched <- replace(diff_gene_targeting, diff_gene_targeting[, ] < 0, 0) # creating dataframe where the differential is enriched in the ctrl condition
save(ctrl_enriched, file = here("results/diff_targeting/kidney_ctrl_enriched_gene_across.Rdata"))
```

```{r visualizing-all-diff-gene-het-enriched}
## formatting input data
data <- het_enriched
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_across_across_het_enriched_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of S858R enriched genes across cell-types in Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-all-diff-gene-het-enriched-setbp1genes}
# filtering for gene set
data <- het_enriched[het_enriched$gene %in% setbp1_genes, ]

names <- data$gene # add names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_across_het_Setbp1targets_enriched_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Gene Targeting across cell-types of known targets of Setbp1 in S858R enriched genes of Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 2200)
```

```{r GO-difftargeting-genes-Setbp1Target-het-enriched}
## pathway analysis and plotting
exclude_column <- "gene" # note: this needs to be changed for gene, indicates which columns to pivot longer below,
data <- het_enriched[het_enriched$gene %in% setbp1_genes, ] %>%
  pivot_longer(., cols = which(colnames(.) != exclude_column), names_to = "cell_type", values_to = "targeting_score") %>%
  .[!.$targeting_score == 0, ]

for (i in cell_names) {
  # grab genes from cell type i ----------
  top <- data[data$cell_type == i, ]
  genes <- as.character(top$gene)
  # submit genes to pathway analysis function ----------
  fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
  png(paste0(here("results/diff_targeting/"), "DiffTargeting_across_", i, "genes_ Setbp1targets_het_enriched.png"), width = 1000, height = 1000)
  # plot dotplot and add title based on input variable ----------
  plot <- bubbleplot(fea_result_filt) +
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) across cell-types in Setbp1 S858R ", i)) +
    theme(plot.title = element_text(hjust = 0.5, size = 12)) +
    theme_minimal()
  print(plot)
  dev.off()
  print(paste0("pathways investigated and plotted in ", i))
}
``` 
[1] "pathways investigated and plotted in Bcell"
[1] "pathways investigated and plotted in CDIC_typeA"
[1] "pathways investigated and plotted in CDIC_typeB"
[1] "pathways investigated and plotted in CDPC"
[1] "pathways investigated and plotted in DCT"
[1] "pathways investigated and plotted in DLH"
[1] "pathways investigated and plotted in LOH"
[1] "pathways investigated and plotted in PCTS1"
[1] "pathways investigated and plotted in PCTS2"
[1] "pathways investigated and plotted in PST"
[1] "pathways investigated and plotted in PT"
[1] "pathways investigated and plotted in endothelial"
[1] "pathways investigated and plotted in fibroblasts"
[1] "pathways investigated and plotted in macrophages"
[1] "pathways investigated and plotted in pericytes"
[1] "pathways investigated and plotted in podocytes"
[1] "pathways investigated and plotted in smcs"

```{r visualizing-all-diff-gene-ctrl-enriched}
## formatting input data
data <- ctrl_enriched
names <- data$gene # add gene names as rownames
data <- abs(data[, -1])
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_across_ctrl_enriched_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of Control enriched genes across cell-types in Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualize-distribution-of-het-gene-difftargeting-scores}
# het gene distribution
exclude_column <- "gene"

pivoted <- pivot_longer(het_enriched,
                        values_to = "targeting_score",
                        names_to = "cell_type",
                        cols = which(colnames(het_enriched) != exclude_column))
ggplot(data = pivoted, aes(x = targeting_score, group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene targeting score distribution across cell types in S8585R") +
  scale_color_manual(values = c("#FFBE1D",
                                "#4E3801",
                                "#EEDF37",
                                "#F03F00",
                                "#6D0404",
                                "#AA6320",
                                "#CF9400",
                                "#FFC8C4",
                                "#AA937E",
                                "#C70F0F",
                                "#A85A5A",
                                "#BD085E",
                                "#948802",
                                "#FFE196",
                                "#FF7600",
                                "#F8766D",
                                "#FFE196"))
summary(het_enriched)
```


```{r het-diff-gene-targeting-distribution-nonzero}
# het gene distribution nonzero
nonzero <- pivoted[pivoted$targeting_score != 0, ]
png(
  filename = here("results/diff_targeting/kidney_difftargeting_across_het_gene_distribution.png"),
  width = 1000,
  height = 500
)
ggplot(data = nonzero, aes(x = targeting_score, group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene differential targeting score distribution across cell types in S8585R") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D",
                                "#4E3801",
                                "#EEDF37",
                                "#F03F00",
                                "#6D0404",
                                "#AA6320",
                                "#CF9400",
                                "#FFC8C4",
                                "#AA937E",
                                "#C70F0F",
                                "#A85A5A",
                                "#BD085E",
                                "#948802",
                                "#FFE196",
                                "#FF7600",
                                "#F8766D",
                                "#FFE196"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from = cell_type, values_from = targeting_score)
summary(nonzero_long)

exclude_column <- "gene"
pivoted <- pivot_longer(het_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched) != exclude_column))
summary(het_enriched)
```

```{r control-diff-gene-targeting-distribution}
# control gene distribution
exclude_column <- "gene"
pivoted <- pivot_longer(ctrl_enriched,
                        values_to = "targeting_score",
                        names_to = "cell_type",
                        cols = which(colnames(ctrl_enriched) != exclude_column))
ggplot(data = pivoted, aes(x = abs(targeting_score), group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene targeting score distribution across cell types in Control") +
  scale_color_manual(values = c("#FFBE1D",
                                "#4E3801",
                                "#EEDF37",
                                "#F03F00",
                                "#6D0404",
                                "#AA6320",
                                "#CF9400",
                                "#FFC8C4",
                                "#AA937E",
                                "#C70F0F",
                                "#A85A5A",
                                "#BD085E",
                                "#948802",
                                "#FFE196",
                                "#FF7600",
                                "#F8766D",
                                "#FFE196"))

summary(ctrl_enriched)


nonzero <- pivoted[pivoted$targeting_score != 0, ]
png(
  filename = here("results/diff_targeting/kidney_difftargeting_across_ctrl_gene_distribution.png"),
  width = 1000,
  height = 500
)
ggplot(data = nonzero, aes(x = abs(targeting_score), group = cell_type, color = cell_type)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Gene differential targeting score distribution across cell types in Control") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D",
                                "#4E3801",
                                "#EEDF37",
                                "#F03F00",
                                "#6D0404",
                                "#AA6320",
                                "#CF9400",
                                "#FFC8C4",
                                "#AA937E",
                                "#C70F0F",
                                "#A85A5A",
                                "#BD085E",
                                "#948802",
                                "#FFE196",
                                "#FF7600",
                                "#F8766D",
                                "#FFE196"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from = cell_type, values_from = targeting_score)
nonzero_long <- abs(nonzero_long[, which(colnames(nonzero_long) != exclude_column)])
summary(nonzero_long)
```

```{r find-top-diff-targeted-genes-het-celltypes}
cell_names <- colnames(het_enriched) %>% .[which(. != "gene")] # note: need to change for gene, grabbing cell type names
cell_names

# rank genes by targeting for each cell type , find top 20
gene_diff_het <- list() # creating empty list to store within

for (i in cell_names) {
  rank_het <- het_enriched[, names(het_enriched) %in% c("gene", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  gene_diff_het[[i]] <- rank_het
}

kidney_het_enriched_top_genes <- do.call(bind_rows, gene_diff_het) # collapsing list into single df using row binding

# rank genes by targeting for each cell type for all data
gene_diff_het <- list() # creating empty list to store within

for (i in cell_names) {
  rank_het <- het_enriched[, names(het_enriched) %in% c("gene", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  gene_diff_het[[i]] <- rank_het
}

kidney_het_enriched_all_genes <- do.call(bind_rows, gene_diff_het) # collapsing list into single df using row binding
```

```{r visualize-het-enriched-gene-top20-heatmap}
## formatting input data
data <- kidney_het_enriched_top_genes[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data,
                    names_from = c("cell_type"),
                    values_from = "targeting_score",
                    names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_across_top20_het_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes across Cell-types in Setbp1 S858R Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 2000)
```

```{r GO-difftargeting-top20genes-het-enriched}
## pathway analysis and plotting
data <- kidney_het_enriched_top_genes

for (i in cell_names) {
  if (i == "DLH" || i == "smcs") {
    top <- data[data$cell_type == i, ]
    genes <- as.character(top$gene)
    # submit genes to pathway analysis function ----------
    fea_result_filt <- fea_no_sig(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
    png(paste0(here("results/diff_targeting/"), "DiffTargeting_across", i, "_top20_genes_het_enriched.png"), width = 1000, height = 1000)
    # plot dotplot and add title based on input variable ----------
    plot <- bubbleplot(fea_result_filt) +
      ggtitle(paste0("Non-Sig Pathways Associated with Top 20 Differentially Targeted Genes across cell types in Setbp1 S858R ", i)) +
      theme(plot.title = element_text(hjust = 0.5, size = 12)) +
      theme_minimal()
    print(plot)
    dev.off()
    print(paste0("nonsig pathways investigated and plotted in ", i))
  } else {
    top <- data[data$cell_type == i, ]
    genes <- as.character(top$gene)
    # submit genes to pathway analysis function ----------
    fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
    png(paste0(here("results/diff_targeting/"), "DiffTargeting_across", i, "_top20_genes_het_enriched.png"), width = 1000, height = 1000)
    # plot dotplot and add title based on input variable ----------
    plot <- bubbleplot(fea_result_filt) +
      ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes across cell types in Setbp1 S858R ", i)) +
      theme(plot.title = element_text(hjust = 0.5, size = 12)) +
      theme_minimal()
    print(plot)
    dev.off()
    print(paste0("pathways investigated and plotted in ", i))
  }
}
```
[1] "pathways investigated and plotted in Bcell"
[1] "pathways investigated and plotted in CDIC_typeA"
[1] "pathways investigated and plotted in CDIC_typeB"
[1] "pathways investigated and plotted in CDPC"
[1] "pathways investigated and plotted in DCT"
[1] "nonsig pathways investigated and plotted in DLH"
[1] "pathways investigated and plotted in LOH"
[1] "pathways investigated and plotted in PCTS1"
[1] "pathways investigated and plotted in PCTS2"
[1] "pathways investigated and plotted in PST"
[1] "pathways investigated and plotted in PT"
[1] "pathways investigated and plotted in endothelial"
[1] "pathways investigated and plotted in fibroblasts"
[1] "pathways investigated and plotted in macrophages"
[1] "pathways investigated and plotted in pericytes"
[1] "pathways investigated and plotted in podocytes"
[1] "nonsig pathways investigated and plotted in smcs"

```{r find-top-diff-targeted-genes-ctrl-celltypes}
cell_names <- colnames(ctrl_enriched) %>% .[which(. != "gene")] # note: need to change for gene, grabbing cell type names
cell_names

# rank genes by targeting for each cell type , find top 20
gene_diff_ctrl <- list() # creating empty list to store within

for (i in cell_names) {
  rank_ctrl <- ctrl_enriched[, names(ctrl_enriched) %in% c("gene", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  gene_diff_ctrl[[i]] <- rank_ctrl
}

kidney_ctrl_enriched_top_genes <- do.call(bind_rows, gene_diff_ctrl) # collapsing list into single df using row binding

# rank genes by targeting for each cell type for all data
gene_diff_ctrl <- list() # creating empty list to store within

for (i in cell_names) {
  rank_ctrl <- ctrl_enriched[, names(ctrl_enriched) %in% c("gene", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  gene_diff_ctrl[[i]] <- rank_ctrl
}

kidney_ctrl_enriched_all_genes <- do.call(bind_rows, gene_diff_ctrl) # collapsing list into single df using row binding
```

```{r visualize-ctrl-enriched-gene-top20-heatmap}
## formatting input data
data <- kidney_ctrl_enriched_top_genes[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "cell_type"
# setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_across_top20_ctrl_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes across Cell-types in Setbp1 S858R Kidney"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 2000)
```

```{r GO-difftargeting-top20genes-ctrl-enriched}
## pathway analysis and plotting
data <- kidney_ctrl_enriched_top_genes

for (i in cell_names) {
  if (i == "CDIC_typeA" || i == "CDIC_typeB" || i == "smcs") {
    # grab genes from cell type i ----------
    top <- data[data$cell_type == i, ]
    genes <- as.character(top$gene)
    # submit genes to pathway analysis function ----------
    fea_result_filt <- fea_no_sig(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
    png(paste0(here("results/diff_targeting/"), "DiffTargeting_across_", i, "_top20_genes_ctrl_enriched.png"), width = 1000, height = 1000)
    # plot dotplot and add title based on input variable ----------
    plot <- bubbleplot(fea_result_filt) +
      ggtitle(paste0("Non-sig Pathways Associated with Top 20 Differentially Targeted genes across cell-types in Setbp1 S858R ", i)) +
      theme(plot.title = element_text(hjust = 0.5, size = 12)) +
      theme_minimal()
    print(plot)
    dev.off()
    print(paste0("non-sig pathways investigated and plotted in ", i))
  } else {
    # grab genes from cell type i ----------
    top <- data[data$cell_type == i, ]
    genes <- as.character(top$gene)
    # submit genes to pathway analysis function ----------
    fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
    png(paste0(here("results/diff_targeting/"), "DiffTargeting_across_", i, "_top20_genes_ctrl_enriched.png"), width = 1000, height = 1000)
    # plot dotplot and add title based on input variable ----------
    plot <- bubbleplot(fea_result_filt) +
      ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted genes across cell-types in Setbp1 S858R ", i)) +
      theme(plot.title = element_text(hjust = 0.5, size = 12)) +
      theme_minimal()
    print(plot)
    dev.off()
    print(paste0("pathways investigated and plotted in ", i))
  }
}
```
[1] "pathways investigated and plotted in Bcell"
[1] "non-sig pathways investigated and plotted in CDIC_typeA"
[1] "non-sig pathways investigated and plotted in CDIC_typeB"
[1] "pathways investigated and plotted in CDPC"
[1] "pathways investigated and plotted in DCT"
[1] "pathways investigated and plotted in DLH"
[1] "pathways investigated and plotted in LOH"
[1] "pathways investigated and plotted in PCTS1"
[1] "pathways investigated and plotted in PCTS2"
[1] "pathways investigated and plotted in PST"
[1] "pathways investigated and plotted in PT"
[1] "pathways investigated and plotted in endothelial"
[1] "pathways investigated and plotted in fibroblasts"
[1] "pathways investigated and plotted in macrophages"
[1] "pathways investigated and plotted in pericytes"
[1] "pathways investigated and plotted in podocytes"
[1] "non-sig pathways investigated and plotted in smcs"

```{r}
fptm <- proc.time() - ptm
fptm[3] / 60
```
 elapsed 
18.64615 
 
```{r}
# run style
style_file(here("src/network_scripts/differential_targeting/02_Setbp1_DiffTargetingAcross_Kidney.Rmd")) # commented out after being run once
# lintr was run as well
```

```{r}
sessionInfo()
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.5 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2           styler_1.9.0          here_1.0.1            gprofiler2_0.2.1      readr_2.1.4           circlize_0.4.15      
 [7] magrittr_2.0.3        RColorBrewer_1.1-3    ComplexHeatmap_2.10.0 ggpubr_0.6.0          ggplot2_3.4.1         tidyr_1.3.0          
[13] limma_3.50.3          dplyr_1.1.0           data.table_1.14.8     netZooR_1.2.1         matrixcalc_1.0-6      yarn_1.20.0          
[19] pandaR_1.26.0         Biobase_2.54.0        BiocGenerics_0.40.0   reticulate_1.28       igraph_1.4.1         

loaded via a namespace (and not attached):
  [1] rappdirs_0.3.3              rtracklayer_1.54.0          pbdZMQ_0.3-9                AnnotationForge_1.36.0      R.methodsS3_1.8.2          
  [6] bumphunter_1.36.0           minfi_1.40.0                bit64_4.0.5                 knitr_1.42                  R.utils_2.12.2             
 [11] DelayedArray_0.20.0         KEGGREST_1.34.0             RCurl_1.98-1.10             GEOquery_2.62.2             doParallel_1.0.17          
 [16] generics_0.1.3              GenomicFeatures_1.46.5      preprocessCore_1.56.0       callr_3.7.3                 RSQLite_2.3.0              
 [21] chron_2.3-59                bit_4.0.5                   tzdb_0.3.0                  base64url_1.4               xml2_1.3.3                 
 [26] SummarizedExperiment_1.24.0 assertthat_0.2.1            STRINGdb_2.6.5              xfun_0.37                   hms_1.1.2                  
 [31] evaluate_0.20               fansi_1.0.4                 restfulr_0.0.15             scrime_1.3.5                progress_1.2.2             
 [36] caTools_1.18.2              dbplyr_2.3.1                Rgraphviz_2.38.0            DBI_1.1.3                   htmlwidgets_1.6.1          
 [41] reshape_0.8.9               stats4_4.1.3                purrr_1.0.1                 hash_2.2.6.2                ellipsis_0.3.2             
 [46] backports_1.4.1             permute_0.9-7               annotate_1.72.0             biomaRt_2.50.3              sparseMatrixStats_1.6.0    
 [51] MatrixGenerics_1.6.0        vctrs_0.5.2                 remotes_2.4.2               penalized_0.9-52            abind_1.4-5                
 [56] cachem_1.0.7                withr_2.5.0                 vegan_2.6-4                 GenomicAlignments_1.30.0    prettyunits_1.1.1          
 [61] mclust_6.0.0                cyclocomp_1.1.0             cluster_2.1.2               IRdisplay_1.1               lazyeval_0.2.2             
 [66] crayon_1.5.2                uchardet_1.1.1              genefilter_1.76.0           labeling_0.4.2              edgeR_3.36.0               
 [71] pkgconfig_2.0.3             GenomeInfoDb_1.30.1         nlme_3.1-155                nnet_7.3-17                 rlang_1.0.6                
 [76] RJSONIO_1.3-1.8             lifecycle_1.0.3             downloader_0.4              filelock_1.0.2              BiocFileCache_2.2.1        
 [81] rex_1.2.1                   GOstats_2.60.0              quantro_1.28.0              rprojroot_2.0.3             matrixStats_0.63.0         
 [86] graph_1.72.0                rngtools_1.5.2              base64_2.0.1                Matrix_1.5-3                IRkernel_1.3.2             
 [91] carData_3.0-5               Rhdf5lib_1.16.0             base64enc_0.1-3             processx_3.8.0              GlobalOptions_0.1.2        
 [96] png_0.1-8                   viridisLite_0.4.1           rjson_0.2.21                bitops_1.0-7                R.oo_1.25.0                
[101] KernSmooth_2.23-20          rhdf5filters_1.6.0          Biostrings_2.62.0           blob_1.2.3                  DelayedMatrixStats_1.16.0  
[106] doRNG_1.8.6                 shape_1.4.6                 stringr_1.5.0               nor1mix_1.3-0               R.cache_0.16.0             
[111] rstatix_0.7.2               S4Vectors_0.32.4            ggsignif_0.6.4              scales_1.2.1                memoise_2.0.1              
[116] GSEABase_1.56.0             plyr_1.8.8                  hexbin_1.28.2               gplots_3.1.3                zlibbioc_1.40.0            
[121] compiler_4.1.3              BiocIO_1.4.0                illuminaio_0.36.0           plotrix_3.8-2               clue_0.3-64                
[126] Rsamtools_2.10.0            cli_3.6.0                   XVector_0.34.0              Category_2.60.0             ps_1.7.2                   
[131] MASS_7.3-55                 mgcv_1.8-39                 tidyselect_1.2.0            stringi_1.7.12              yaml_2.3.7                 
[136] askpass_1.1                 locfit_1.5-9.7              tools_4.1.3                 parallel_4.1.3              rstudioapi_0.14            
[141] uuid_1.1-0                  foreach_1.5.2               farver_2.1.1                digest_0.6.31               proto_1.0.0                
[146] quadprog_1.5-8              Rcpp_1.0.10                 GenomicRanges_1.46.1        car_3.1-1                   siggenes_1.68.0            
[151] broom_1.0.3                 org.Hs.eg.db_3.14.0         httr_1.4.5                  ggdendro_0.1.23             AnnotationDbi_1.56.2       
[156] colorspace_2.1-0            XML_3.99-0.13               fs_1.6.1                    IRanges_2.28.0              splines_4.1.3              
[161] RBGL_1.70.0                 multtest_2.50.0             plotly_4.10.1               xtable_1.8-4                jsonlite_1.8.4             
[166] R6_2.5.1                    RUnit_0.4.32                gsubfn_0.7                  pillar_1.8.1                htmltools_0.5.4            
[171] glue_1.6.2                  fastmap_1.1.1               BiocParallel_1.28.3         beanplot_1.3.1              codetools_0.2-18           
[176] utf8_1.2.3                  lattice_0.20-45             tibble_3.1.8                sqldf_0.4-11                curl_5.0.0                 
[181] gtools_3.9.4                GO.db_3.14.0                openssl_2.0.5               survival_3.3-1              rmarkdown_2.20             
[186] repr_1.1.6                  desc_1.4.2                  munsell_0.5.0               GetoptLong_1.0.5            rhdf5_2.38.1               
[191] GenomeInfoDbData_1.2.7      iterators_1.0.14            RCy3_2.14.2                 HDF5Array_1.22.1            reshape2_1.4.4             
[196] gtable_0.3.1 