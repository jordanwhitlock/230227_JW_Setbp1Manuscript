---
title: "Setbp1_DiffTargetingKidney_01"
output: html_document
date: '2023-02-13'
---

This R markdown script is a reanalysis of the gene targeting analysis performed in "Setbp1_AllCortex_PANDAComparison_01.Rmd" in order to determine the impact of edge weight on the gene/TF targeting scores from the regulatory networks. In an effort to determine this, all networks below were filtered to only include positive weights, whereas in the previous script both positives and negatives were included. 

Targeting code was originially implemented here: http://netbooks.networkmedicine.org/user/b04f15be-cbd3-44df-932f-6e9026018fd0/notebooks/netZooR/lioness_tcga_targeting_netbook.ipynb

#load in required libraries & functions
```{r loading-libraries-functions, results='hide'}
set.seed(2178)
library(netZooR)
library(data.table)
library(dplyr)
library(limma)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(magrittr)
library(circlize)
library(readr)
library(gprofiler2)
library(here)
source(here("src/functions/functions.R"))
library(styler)
library(lintr)
```

## load in PANDA object containing list of all cell types from Setbp1 data
Here each item returned by the for loop represents a PANDA object for a given cell type that contains the regNet, coopNet, and coregNet for that cell type.
```{r loading-object, results='hide'}
files <- list.files(here("results/PANDA"), pattern = "kidneyexpression_PANDA.Rdata", full.names = TRUE) #grabbing kidney samples
for (i in files){
 load(i)
  regNet <- pandaResults
  regNet <- regNet@regNet
  name <- sub(here("results/PANDA/"), "", i)
  name <- sub("kidneyexpression_PANDA.Rdata*", "", name)
  assign(paste0(name, ".regNet" ), regNet)
  rm(pandaResults)
  rm(regNet)
}
```

```{r}
files #34 total
```

## Visualizing edge weight distributions filtered and unfiltered
```{r visualize-distribution-of-unfiltered-regNet-scores}
#grabbing object names
merged_list <- list()
networks <- basename(files)
networks <- sub("kidneyexpression_PANDA.Rdata.*","", networks)

#extracting scores 
for (i in networks){
  if (grepl("_heterozygous", i) == TRUE){
    melt <- as.data.frame(reshape2::melt(get(paste0(i, ".regNet")),
                                            varnames = c("TF", "gene"),
                                            value.name = "het_edge_weight"))#melting dataframe
  melt <- as.data.frame(melt[,3])
  colnames(melt) <- "edge_weight"
  melt$cell_type <- sub("_.*","", i)
  merged_list[i] <- melt
  } else if (grepl("_control", i) == TRUE){
        melt <- as.data.frame(reshape2::melt(get(paste0(i, ".regNet")),
                                            varnames = c("TF", "gene"),
                                            value.name = "ctrl_edge_weight"))#melting dataframe
  melt <- as.data.frame(melt[,3])
  colnames(melt) <- "edge_weight"
  melt$cell_type <- sub("_.*","", i)
  merged_list[i] <- melt
  }
  
}

#wrangling data
merged_control <- data.frame(merged_list[grep("_control", names(merged_list))]) %>% pivot_longer(., names_to = "cell_type", values_to = "edge_weight", cols = 1:17) #need to adjust column number for different data

#plotting distribution
png(filename = here("results/diff_targeting/kidney_regNet_edgeweight_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=merged_control, aes(x=edge_weight,
                        group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights in control Kidney Cortex") + theme_bw() + scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()

#wrangling data
merged_het<- data.frame(merged_list[grep("_heterozygous", names(merged_list))]) %>% pivot_longer(., names_to = "cell_type", values_to = "edge_weight", cols = 1:17) #need to adjust column number for different data

#plotting distribution
png(filename = here("results/diff_targeting/kidney_regNet_edgeweight_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=merged_control, aes(x=edge_weight,
                        group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights in S858R Kidney Cortex") + theme_bw() + scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()
```

Note: all negative edge weights were changed to 0
```{r visualize-distribution-of-filtered-het-regNet-scores}
#grabbing only positive edge weights
merged_het_pos <- merged_het[merged_het$edge_weight > 0,]
merged_control_pos <- merged_control[merged_control$edge_weight > 0,]

#plotting only positive het edge weights
png(filename = here("results/diff_targeting/kidney_regNet_edgeweight_filtered_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=merged_het_pos, aes(x=edge_weight, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights > 0 in S858R Kidney Cortex") + theme_bw() + scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()

#plotting only positive ctrl edge weights
png(filename = here("results/diff_targeting/kidney_regNet_edgeweight_filtered_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=merged_control_pos, aes(x=edge_weight, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) + ggtitle("Distribution of regNet edge weights >0 in control Kidney Cortex") + theme_bw() + scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()
```

## wrangling data to proper format, filtering for only positive edge weights, and calculating targeting scores:
Gene targeting score, a numerical score representing the extent to which a gene is targeted by TFs in a given biological context. The gene targeting score is calculated by summing the weights of all inbound regulatory edges for a gene or outbound edges for a TF (https://doi.org/10.3389/fgene.2021.649942). 
* regNetmatrix: The PANDA regNet output matrix of TF and Genes and their edge weights from running pandaR 
* variable_name: Here this is the cell type, or variable you would like the targeting score matrix stored as in your global environment 
* edge_weight_name: This is the name of the edge_weight column in your matrix (options: het_edge_weight, ctrl_edge_weight)
* condition: The group the data is from, in this instance it is ctrl or het.

```{r calc-targeting}
for (i in networks){
  if (grepl("_control", i) == TRUE){
    targetingCalc(regNetmatrix = get(paste0(i, ".regNet")), variable_name = sub("_control.*", "", i), edge_weight_name = ctrl_edge_weight, condition = "ctrl")
  } else if (grepl("_heterozygous", i) == TRUE){
    targetingCalc(regNetmatrix = get(paste0(i, ".regNet")), variable_name = sub("_heterozygous.*", "", i), edge_weight_name = het_edge_weight, condition = "het")
  }
}
```

Confirm targeting is being calculated as suspected by validating with alternate method. Distributions are the same when calculated by aggregate or sums:
```{r comparing-alternate-targeting-score-calc}
pdf(here("results/diff_targeting/kidney_alt_targeting_calc.pdf"))
#HETEROZYGOUS----------------------
#visualize current distribution
hist(Bcell_gene_targeting_het$het_edge_weight_pos)

#checking alt targeting calc method distribution matches
dim(Bcell_heterozygous.regNet) # 1080 20429
pos <- as.data.frame(pmax(Bcell_heterozygous.regNet, 0))
TF_t_het <- as.data.frame(rowSums(pos))
TF_t_het$TF <- rownames(pos)
hist(TF_t_het$`rowSums(pos)`)
G_t_het <- as.data.frame(colSums(pos))
G_t_het$gene <- colnames(pos)
hist(G_t_het$`colSums(pos)`)

#CONTROL----------------------
#visualize current distribution
hist(Bcell_gene_targeting_ctrl$ctrl_edge_weight_pos)

#checking alt targeting calc method distribution matches
dim(Bcell_control.regNet)# 1080 20429
pos <- as.data.frame(pmax(Bcell_control.regNet, 0))
TF_t_ctrl <- as.data.frame(rowSums(pos))
TF_t_ctrl$TF <- rownames(pos)
hist(TF_t_ctrl$`rowSums(pos)`)
G_t_ctrl <- as.data.frame(colSums(pos))
G_t_ctrl$gene <- colnames(pos)
hist(G_t_ctrl$`colSums(pos)`)
dev.off()
```

## combine ctrl and het to into single data frame 
```{r wrangling-data-to-combine}
cell_names <- networks[grep("_control", networks)] %>% sub("_control.*", "", .)
cell_names #17 total for kidney, note: this will not work if your cell types are different across conditions

targeting_list <- list() #generating empty list

for (i in cell_names){
  #TF targeting
  x <- get(paste0(i, "_TF_targeting_ctrl"))
  y <- get(paste0(i, "_TF_targeting_het"))
  TF_targeting <- merge(x, y, by = "TF") #combine dataframes 
  targeting_list[[paste0("TF_targeting_", i)]] <- TF_targeting
  
  #gene targeting
  x <- get(paste0(i, "_gene_targeting_ctrl"))
  y <- get(paste0(i, "_gene_targeting_het"))
  gene_targeting <- merge(x, y, by = "gene") #combine dataframes 
  targeting_list[[paste0("Gene_targeting_", i)]] <- gene_targeting
}
```

# Investigate targeting differences across Het cell types:
```{r constructing-het-targeting-matrix}
#grabbing all het targeting scores for TFs
TF_targeting_all_het <- targeting_list[grep("TF_", names(targeting_list))] %>%
  purrr::reduce(full_join, by = "TF") %>%
  select(., contains(c("TF", "het_edge_weight_pos")))

#grabbing colnames and setting for new dataframe generated above
names <- names(targeting_list[grep("TF_", names(targeting_list))]) %>%
  sub(".*TF_targeting_", "", .)  %>% append("TF", .)
colnames(TF_targeting_all_het) <- names

#grabbing all het targeting scores for genes
gene_targeting_all_het <- targeting_list[grep("Gene_", names(targeting_list))] %>%
  purrr::reduce(full_join, by = "gene") %>%
  select(., contains(c("gene", "het_edge_weight_pos")))

#grabbing colnames and setting for new dataframe generated above
names <- names(targeting_list[grep("Gene_", names(targeting_list))]) %>%
  sub(".*Gene_targeting_", "", .)  %>% append("gene", .)
colnames(gene_targeting_all_het) <- names
```

```{r find-top-targeted-genes-across-het-celltypes}
#identify the maximum for each row
max <- do.call(pmax, gene_targeting_all_het[,-1]) #finding max for each gene across cell types

#subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- max - gene_targeting_all_het[,-1]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)

#adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_het$gene

#sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq(1:nrow(gene_targeting_ranked))

#adding rank to targeting score dataframe
gene_targeting_all_het <- merge(select(gene_targeting_ranked, c("rank", "gene")), gene_targeting_all_het, by = "gene")
gene_targeting_all_het <- arrange(gene_targeting_all_het, rank)
```

```{r visualize-het-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_het, values_to = "targeting_score", names_to = "cell_type", cols = -c("gene", "rank"))
pivoted


png(filename = here("results/diff_targeting/kidney_gene_targeting_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
  geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Kidney Gene Targeting Score Distribution in S858R Mice") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()
```

## setting heatmap data and setbp1 input needed for the rest of the script
```{r heatmap-color-annotation}
#setting annotation colors
annotation_colors <- list("cell_type" = c("Bcell" = "#FFBE1D", "CDIC_typeA" = "#4E3801", "CDIC_typeB" = "#EEDF37", "CDPC" = "#F03F00", "DCT" = "#6D0404", "DLH" = "#AA6320", "LOH" = "#CF9400", "PCTS1" = "#FFC8C4", "PCTS2" = "#AA937E", "PST" = "#C70F0F", "PT" = "#A85A5A", "endothelial" = "#BD085E", "fibroblasts" = "#948802", "macrophages" = "#FFE196", "pericytes" = "#FF7600", "podocytes" = "#F8766D", "smcs" = "#FFE196"))
```

```{r loading-geneset}
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[,-1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")
```

## plotting targeting heatmaps
```{r visualizing-het-gene-rank-with-heatmap}
#formatting input data
data <- gene_targeting_all_het
rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_all_het_heatmap_test.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-het-gene-top100-rank-with-heatmap}
#formatting input data
data <- gene_targeting_all_het %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:3)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_targeting_het_top100_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-gene-targeting-across-het}
#formatting input data
data <- gene_targeting_all_het[gene_targeting_all_het$gene %in% setbp1_genes,]

rownames(data) <- data$gene
data <- data[, -c(1:3)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_het_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Gene targeting of Setbp1 and it's targets Across Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, width = 1000, height = 2000)
```


```{r find-top-targeted-TFs-across-het-celltypes}
#identify the maximum for each row
max <- do.call(pmax, TF_targeting_all_het[,-1]) #finding max for each TF across cell types

#subtract each value from the maximum by TF; the TF with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that TF
TF_targeting_ranked <- max - TF_targeting_all_het[,-1]
TF_targeting_ranked$rank_sum <- rowSums(TF_targeting_ranked)

#adding TF names back
TF_targeting_ranked$TF <- TF_targeting_all_het$TF

#sorting and annotating
TF_targeting_ranked <- TF_targeting_ranked %>% arrange(desc(rank_sum))
TF_targeting_ranked$rank <- seq(1:nrow(TF_targeting_ranked))

#adding rank to targeting score dataframe
TF_targeting_all_het <- merge(select(TF_targeting_ranked, c("rank", "TF")), TF_targeting_all_het, by = "TF")
TF_targeting_all_het <- arrange(TF_targeting_all_het, rank)
```

```{r visualize-het-TF-targeting-distribution}
pivoted <- pivot_longer(TF_targeting_all_het, values_to = "targeting_score", names_to = "cell_type", cols = -c("TF", "rank"))

png(filename = here("results/diff_targeting/kidney_TF_targeting_dist_het.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("TF Targeting Score Distribution in S858R Mice") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()
```

```{r visualizing-het-TF-rank-with-heatmap}
#formatting input data
data <- TF_targeting_all_het
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_all_het_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of All TFs Across Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-het-top100-TF-rank-with-heatmap}
#formatting input data
data <- TF_targeting_all_het %>% slice(1:100)
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_het_top100_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of TF Across Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-TF-targeting-across-het}
#formatting input data
data <- TF_targeting_all_het[TF_targeting_all_het$TF %in% setbp1_genes,]

rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_het_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "TF targeting of Setbp1 and it's targets Across Cell-types in Setbp1 S858R kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE)
```

# Investigate targeting differences across ctrl cell types:

```{r constructing-ctrl-targeting-matrix}
#grabbing all ctrl targeting scores for TFs
TF_targeting_all_ctrl <- targeting_list[grep("TF_", names(targeting_list))] %>%
  purrr::reduce(full_join, by = "TF") %>%
  select(., contains(c("TF", "ctrl_edge_weight_pos")))

#grabbing colnames and setting for new dataframe generated above
names <- names(targeting_list[grep("TF_", names(targeting_list))]) %>%
  sub(".*TF_targeting_", "", .)  %>% append("TF", .)
colnames(TF_targeting_all_ctrl) <- names

#grabbing all ctrl targeting scores for genes
gene_targeting_all_ctrl <- targeting_list[grep("Gene_", names(targeting_list))] %>%
  purrr::reduce(full_join, by = "gene") %>%
  select(., contains(c("gene", "ctrl_edge_weight_pos")))

#grabbing colnames and setting for new dataframe generated above
names <- names(targeting_list[grep("Gene_", names(targeting_list))]) %>%
  sub(".*Gene_targeting_", "", .)  %>% append("gene", .)
colnames(gene_targeting_all_ctrl) <- names
```

```{r find-top-targeted-genes-across-ctrl-celltypes}
#identify the maximum for each row
max <- do.call(pmax, gene_targeting_all_ctrl[,-1]) #finding max for each gene across cell types

#subtract each value from the maximum by gene; the gene with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that gene
gene_targeting_ranked <- max - gene_targeting_all_ctrl[,-1]
gene_targeting_ranked$rank_sum <- rowSums(gene_targeting_ranked)

#adding gene names back
gene_targeting_ranked$gene <- gene_targeting_all_ctrl$gene

#sorting and annotating
gene_targeting_ranked <- gene_targeting_ranked %>% arrange(desc(rank_sum))
gene_targeting_ranked$rank <- seq(1:nrow(gene_targeting_ranked))

#adding rank to targeting score dataframe
gene_targeting_all_ctrl <- merge(select(gene_targeting_ranked, c("rank", "gene")), gene_targeting_all_ctrl, by = "gene")
gene_targeting_all_ctrl <- arrange(gene_targeting_all_ctrl, rank)
```

```{r visualize-ctrl-gene-targeting-distribution}
pivoted <- pivot_longer(gene_targeting_all_ctrl, values_to = "targeting_score", names_to = "cell_type", cols = -c("gene", "rank"))
pivoted

png(filename = here("results/diff_targeting/kidney_gene_targeting_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
  geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Kidney Gene Targeting Score Distribution in Ctrl Mice") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()

summary(gene_targeting_all_ctrl)
```

```{r visualizing-ctrl-gene-rank-with-heatmap}
#formatting input data
data <- gene_targeting_all_ctrl
rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_all_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of All Genes Across Cell-types in Setbp1 Ctrl Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-gene-top100-rank-with-heatmap}
#formatting input data
data <- gene_targeting_all_ctrl %>% slice(1:100)
rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_targeting_ctrl_top100_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of top 100 Genes Across Cell-types in Setbp1 Ctrl Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-genes-targeting-across-ctrl}
data <- gene_targeting_all_ctrl[gene_targeting_all_ctrl$gene %in% setbp1_genes,]

rownames(data) <- data$gene
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_ctrl_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Gene targeting of Setbp1 and its targets Across Cell-types in Setbp1 Control Kidey Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r find-top-targeted-TFs-across-ctrl-celltypes}
#identify the maximum for each row
max <- do.call(pmax, TF_targeting_all_ctrl[,-1]) #finding max for each TF across cell types

#subtract each value from the maximum by TF; the TF with the most positive rowsum is the most variably targeted across cell types, and the cell type with a value = 0 represents the cell type with the highest targeting for that TF
TF_targeting_ranked <- max - TF_targeting_all_ctrl[,-1]
TF_targeting_ranked$rank_sum <- rowSums(TF_targeting_ranked)

#adding TF names back
TF_targeting_ranked$TF <- TF_targeting_all_ctrl$TF

#sorting and annotating
TF_targeting_ranked <- TF_targeting_ranked %>% arrange(desc(rank_sum))
TF_targeting_ranked$rank <- seq(1:nrow(TF_targeting_ranked))

#adding rank to targeting score dataframe
TF_targeting_all_ctrl <- merge(select(TF_targeting_ranked, c("rank", "TF")), TF_targeting_all_ctrl, by = "TF")
TF_targeting_all_ctrl <- arrange(TF_targeting_all_ctrl, rank)
```

```{r visualize-ctrl-TF-targeting-distribution}
pivoted <- pivot_longer(TF_targeting_all_ctrl, values_to = "targeting_score", names_to = "cell_type", cols = -c("TF", "rank"))
pivoted


png(filename = here("results/diff_targeting/kidney_TF_targeting_dist_ctrl.png"),
    width = 1000,
    height = 500)
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
  geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Kidney TF Targeting Score Distribution in Ctrl Mice") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()

summary(TF_targeting_all_ctrl)
```

```{r visualizing-ctrl-TF-rank-with-heatmap}
##formatting input data
data <- TF_targeting_all_ctrl
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_all_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of All TFs Across Cell-types in Setbp1 Control Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-top100-TF-rank-with-heatmap}
#formatting input data
data <- TF_targeting_all_ctrl %>% slice(1:100)
rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_ctrl_top100_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of top 100 TF Across Cell-types in Setbp1 Control Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-setbp1-targets-TF-targeting-across-ctrl}
data <- TF_targeting_all_ctrl[TF_targeting_all_ctrl$TF %in% setbp1_genes,]

rownames(data) <- data$TF
data <- data[, -c(1:2)]
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_ctrl_setbp1targets_across_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "TF targeting of Setbp1 and its targets Across Cell-types in Setbp1 Control Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

# Investigate targeting rank within each Het cell type

#```{r constructing-het-targeting-matrix}
TF_targeting_all_het <- merge(TF_targeting_astro[,c(1,3)], TF_targeting_excitatory[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_inhibitory[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_micro[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_mural[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_oligodendrocyte[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_opcs[,c(1,3)], by = "TF")
TF_targeting_all_het <- merge(TF_targeting_all_het, TF_targeting_fibro[,c(1,3)], by = "TF")

colnames(TF_targeting_all_het) <- c("TF", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")

gene_targeting_all_het <- merge(Gene_targeting_astro[,c(1,3)], Gene_targeting_excitatory[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_inhibitory[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_micro[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_mural[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_oligodendrocyte[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_opcs[,c(1,3)], by = "gene")
gene_targeting_all_het <- merge(gene_targeting_all_het, Gene_targeting_fibro[,c(1,3)], by = "gene")

colnames(gene_targeting_all_het) <- c("gene", "astrocytes", "excitatory", "inhibitory", "micro", "mural", "oligodendrocyte", "opcs", "fibro")
#```

```{r find-top-targeted-TFs-within-het-celltypes}
TF_targeting_all_het <- subset(TF_targeting_all_het, select = -c(rank)) #removing rank from previous portion of analysis

cell_names <- colnames(TF_targeting_all_het) %>% .[which(. != "TF")] #note: need to change for gene, grabbing cell type names
cell_names

#rank TFs by targeting for each cell type , find top 20
TF_rank_het <- list() #creating empty list to store within

for(i in cell_names){
  rank_het <- TF_targeting_all_het[ ,names(TF_targeting_all_het) %in% c("TF", i)] %>% #note: need to change TF to gene where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  TF_rank_het[[i]] <- rank_het

}

het_TF_targeting_within <- do.call(bind_rows, TF_rank_het)#collapsing list into single df using row binding

#rank TFs by targeting for each cell type for all data
TF_rank_het <- list() #creating empty list to store within

for(i in cell_names){
  rank_het <- TF_targeting_all_het[ ,names(TF_targeting_all_het) %in% c("TF", i)] %>% #note: need to change TF to gene where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  TF_rank_het[[i]] <- rank_het

}

het_all_TF_targeting_within <- do.call(bind_rows, TF_rank_het)#collapsing list into single df using row binding
```

```{r visualizing-het-TF-rank-with-heatmap}
##formatting input data
data <- het_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_top20_het_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Top 20 TFs within Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-het-TF-rank-heatmap}
##formatting input data
data <- het_all_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_het_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of all TFs within Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r het-setbp1-TF-targets-within}
data <- het_all_TF_targeting_within[het_all_TF_targeting_within$TF %in% setbp1_genes,]

##formatting input data
data <- data[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names

#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_het_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target TFs within Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


```{r find-top-targeted-genes-within-het-celltypes}
gene_targeting_all_het <- subset(gene_targeting_all_het, select = -c(rank)) #removing rank from previous portion of analysis

cell_names <- colnames(gene_targeting_all_het) %>% .[which(. != "gene")] #note: need to change for gene, grabbing cell type names
cell_names

#rank genes by targeting for each cell type , find top 20
gene_rank_het <- list() #creating empty list to store within

for(i in cell_names){
  rank_het <- gene_targeting_all_het[ ,names(gene_targeting_all_het) %in% c("gene", i)] %>% #note: need to change TF to gene where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  gene_rank_het[[i]] <- rank_het

}

het_gene_targeting_within <- do.call(bind_rows, gene_rank_het)#collapsing list into single df using row binding

#rank genes by targeting for each cell type for all data
gene_rank_het <- list() #creating empty list to store within

for(i in cell_names){
  rank_het <- gene_targeting_all_het[ ,names(gene_targeting_all_het) %in% c("gene", i)] %>% #note: need to change TF to gene where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  gene_rank_het[[i]] <- rank_het

}

het_all_gene_targeting_within <- do.call(bind_rows, gene_rank_het)#collapsing list into single df using row binding
```


```{r visualizing-het-gene-rank-with-heatmap}
##formatting input data
data <- het_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_top20_het_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Top 20 genes within Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-het-gene-rank-heatmap}
##formatting input data
data <- het_all_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_het_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of all genes within Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r het-setbp1-gene-targets-within}
data <- het_all_gene_targeting_within[het_all_gene_targeting_within$gene %in% setbp1_genes,]

##formatting input data
data <- data[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names

#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_het_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target genes within Cell-types in Setbp1 S858R Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


# Investigate targeting rank within each Ctrl cell type
```{r find-top-targeted-genes-within-ctrl-celltypes}
gene_targeting_all_ctrl <- subset(gene_targeting_all_ctrl, select = -c(rank)) #removing rank from previous portion of analysis

cell_names <- colnames(gene_targeting_all_ctrl) %>% .[which(. != "gene")] #note: need to change for gene, grabbing cell type names
cell_names

#rank genes by targeting for each cell type , find top 20
gene_rank_ctrl <- list() #creating empty list to store within

for(i in cell_names){
  rank_ctrl <- gene_targeting_all_ctrl[ ,names(gene_targeting_all_ctrl) %in% c("gene", i)] %>% #note: need to change TF to gene where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  gene_rank_ctrl[[i]] <- rank_ctrl

}

ctrl_gene_targeting_within <- do.call(bind_rows, gene_rank_ctrl)#collapsing list into single df using row binding

#rank genes by targeting for each cell type for all data
gene_rank_ctrl <- list() #creating empty list to store within

for(i in cell_names){
  rank_ctrl <- gene_targeting_all_ctrl[ ,names(gene_targeting_all_ctrl) %in% c("gene", i)] %>% #note: need to change TF to gene where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  gene_rank_ctrl[[i]] <- rank_ctrl

}

ctrl_all_gene_targeting_within <- do.call(bind_rows, gene_rank_ctrl)#collapsing list into single df using row binding
```

```{r find-top-targeted-TFs-within-ctrl-celltypes}
TF_targeting_all_ctrl <- subset(TF_targeting_all_ctrl, select = -c(rank)) #removing rank from previous portion of analysis

cell_names <- colnames(TF_targeting_all_ctrl) %>% .[which(. != "TF")] #note: need to change for TF, grabbing cell type names
cell_names

#rank TFs by targeting for each cell type , find top 20
TF_rank_ctrl <- list() #creating empty list to store within

for(i in cell_names){
  rank_ctrl <- TF_targeting_all_ctrl[ ,names(TF_targeting_all_ctrl) %in% c("TF", i)] %>% #note: need to change TF to gene where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  TF_rank_ctrl[[i]] <- rank_ctrl

}

ctrl_TF_targeting_within <- do.call(bind_rows, TF_rank_ctrl)#collapsing list into single df using row binding

#rank TFs by targeting for each cell type for all data
TF_rank_ctrl <- list() #creating empty list to store within

for(i in cell_names){
  rank_ctrl <- TF_targeting_all_ctrl[ ,names(TF_targeting_all_ctrl) %in% c("TF", i)] %>% #note: need to change TF to TF where applicable
    .[order(.[i], decreasing = TRUE),] %>%
    mutate(rank = seq(1:nrow(.))) %>%
    mutate(cell_type = i) %>%
    rename(targeting_score = i)
  TF_rank_ctrl[[i]] <- rank_ctrl

}

ctrl_all_TF_targeting_within <- do.call(bind_rows, TF_rank_ctrl)#collapsing list into single df using row binding
```

```{r visualizing-ctrl-gene-rank-with-heatmap}
##formatting input data
data <- ctrl_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_top20_ctrl_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Top 20 genes within Cell-types in Setbp1 Ctrl Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-ctrl-gene-rank-heatmap}
##formatting input data
data <- ctrl_all_gene_targeting_within[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_ctrl_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of all genes within Cell-types in Setbp1 Ctrl Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


```{r ctrl-setbp1-gene-targets-within}
#filtering based off of gene set
data <- ctrl_all_gene_targeting_within[ctrl_all_gene_targeting_within$gene %in% setbp1_genes,]

##formatting input data
data <- data[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_targeting_ctrl_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target genes within Cell-types in Setbp1 Control Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ctrl-TF-rank-with-heatmap}
##formatting input data
data <- ctrl_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_top20_ctrl_within_celltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Top 20 TFs within Cell-types in Setbp1 Ctrl Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-ALL-ctrl-TF-rank-heatmap}
##formatting input data
data <- ctrl_all_TF_targeting_within[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_ctrl_all_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of all TFs within Cell-types in Setbp1 Ctrl Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r ctrl-setbp1-TF-targets-within}
#subsetting for gene set
data <- ctrl_all_TF_targeting_within[ctrl_all_TF_targeting_within$TF %in% setbp1_genes,]

##formatting input data
data <- data[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names

#setting meta colname
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_targeting_ctrl_Setbp1targets_withincelltype_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Targeting of Setbp1 and known target TFs within Cell-types in Setbp1 Control Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

####################################

# calculating differential targeting score between conditions 
GOAL: ID genes/TFs with largest difference in targeting _between conditions within each cell type_:
* Using the combined het/ctrl dataframe for each cell type above, calculate the difference (het-ctrl) for the targeting weight where the more positive difference indicates higher gene targeting in het and more negative diff indicates higher gene targeting in ctrl. 
* The closer a value is to 0, the less difference in targeting between conditions for that cell type

```{r rearrange-data-calc-diff}
#ordering data the same
gene_targeting_all_het <- gene_targeting_all_het[order(gene_targeting_all_het["gene"]),]
gene_targeting_all_ctrl <- gene_targeting_all_ctrl[order(gene_targeting_all_ctrl["gene"]),]

# Add suffix to column names except the gene/TF column
new_colnames <- ifelse(names(gene_targeting_all_het) != "gene", paste0(names(gene_targeting_all_het), "_het"), names(gene_targeting_all_het))
names(gene_targeting_all_het) <- new_colnames
print(gene_targeting_all_het) # Print the updated dataframe

new_colnames <- ifelse(names(gene_targeting_all_ctrl) != "gene", paste0(names(gene_targeting_all_ctrl), "_ctrl"), names(gene_targeting_all_ctrl))
names(gene_targeting_all_ctrl) <- new_colnames
print(gene_targeting_all_ctrl) # Print the updated dataframe

#binding data together
combined_gene_targeting <- merge(gene_targeting_all_het, gene_targeting_all_ctrl, by = "gene")
```

```{r calculate-het-enriched-diff-targeting}
#creating empty data frame
 diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
 colnames(diff_gene_targeting) <- "gene" #this will need to be gene or TF respectively
 diff_gene_targeting$gene <- combined_gene_targeting$gene #adding gene/TF

#calc diff targeting
cell_names <- colnames(gene_targeting_all_ctrl[,-1]) %>% sub("_ctrl.*", "", .) #all cell type prefixes except gene name, which should be first column in data
for(i in cell_names){
  selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_gene_targeting[[selected_columns[1]]] - combined_gene_targeting[[selected_columns[2]]] #ensure difference is `het - control` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_gene_targeting[[diff_colname]] <- diff_col
  }
}

het_enriched <- replace(diff_gene_targeting, diff_gene_targeting[,] < 0, 0) #creating dataframe where the differential is enriched in the het condition
save(het_enriched, file = here("results/diff_targeting/kidney_het_enriched_gene.Rdata"))
```

```{r calculate-ctrl-enriched-diff-targeting}
#creating empty data frame
 diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
 colnames(diff_gene_targeting) <- "gene" #this will need to be gene or TF respectively
 diff_gene_targeting$gene <- combined_gene_targeting$gene #adding gene/TF

# calc diff targeting 
cell_names <- colnames(gene_targeting_all_ctrl[,-1]) %>% sub("_ctrl.*", "", .) #all cell type prefixes except gene name, which should be first column in data
for(i in cell_names){
  selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_gene_targeting[[selected_columns[2]]] - combined_gene_targeting[[selected_columns[1]]] #ensure difference is `control - het` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_gene_targeting[[diff_colname]] <- diff_col
  }
}

ctrl_enriched <- replace(diff_gene_targeting, diff_gene_targeting[,] < 0, 0) #creating dataframe where the differential is enriched in the ctrl condition
save(ctrl_enriched, file = here("results/diff_targeting/kidney_ctrl_enriched_gene.Rdata"))
```

```{r visualizing-all-diff-gene-het-enriched}
##formatting input data
data <- het_enriched
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_het_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of S858R enriched genes in Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-all-diff-gene-het-enriched-setbp1genes}
#filtering for gene set
data <- het_enriched[het_enriched$gene %in% setbp1_genes,]

names <- data$gene #add names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_het_Setbp1targets_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Gene Targeting of known targets of Setbp1 in S858R enriched genes of Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-genes-Setbp1Target-het-enriched}
##pathway analysis and plotting
exclude_column <- "gene" #note: this needs to be changed for TF or gene respectively, indicates which columns to pivot longer below, 
data <- het_enriched[het_enriched$gene %in% setbp1_genes,] %>% pivot_longer(., cols = which(colnames(.) != exclude_column), names_to = "cell_type", values_to =  "targeting_score") %>% .[!.$targeting_score == 0,]

for(i in cell_names){
  # grab genes/TFs from cell type i ----------
  top <- data[data$cell_type == i,]
  genes <- as.character(top$gene)
  # submit genes to pathway analysis function ---------- 
  fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
  png(paste0(here("results/diff_targeting/"), "DiffTargeting_", i, "genes_ Setbp1targets_het_enriched.png"), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted genes (Setbp1 or known targets) in Setbp1 S858R ", i)) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) + 
    theme_minimal()
  print(plot) 
  dev.off()
  print(paste0("pathways investigated and plotted in ", i))
}
``` 

```{r visualizing-all-diff-gene-ctrl-enriched}
##formatting input data
data <- ctrl_enriched
names <- data$gene #add gene names as rownames
data <- abs(data[,-1])
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_ctrl_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of Control enriched genes in kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r rearrange-data-calc-diff-TF}
#ordering data the same
TF_targeting_all_het <- TF_targeting_all_het[order(TF_targeting_all_het["TF"]),]
TF_targeting_all_ctrl <- TF_targeting_all_ctrl[order(TF_targeting_all_ctrl["TF"]),]

# Add suffix to column names except the gene/TF column
new_colnames <- ifelse(names(TF_targeting_all_het) != "TF", paste0(names(TF_targeting_all_het), "_het"), names(TF_targeting_all_het))
names(TF_targeting_all_het) <- new_colnames
print(TF_targeting_all_het) # Print the updated dataframe

new_colnames <- ifelse(names(TF_targeting_all_ctrl) != "TF", paste0(names(TF_targeting_all_ctrl), "_ctrl"), names(TF_targeting_all_ctrl))
names(TF_targeting_all_ctrl) <- new_colnames
print(TF_targeting_all_ctrl) # Print the updated dataframe

#binding data together
combined_TF_targeting <- merge(TF_targeting_all_het, TF_targeting_all_ctrl, by = "TF")
```

```{r calculate-het-enriched-diff-targeting}
#creating empty data frame
 diff_TF_targeting <- data.frame(matrix(NA, nrow = nrow(combined_TF_targeting), ncol = 1))
 colnames(diff_TF_targeting) <- "TF" #this will need to be gene or TF respectively
 diff_TF_targeting$TF <- combined_TF_targeting$TF #adding gene/TF

#calc diff targeting
cell_names <- colnames(TF_targeting_all_ctrl[,-1]) %>% sub("_ctrl.*", "", .) #all cell type prefixes except TF name, which should be first column in data
for(i in cell_names){
  selected_columns <- names(combined_TF_targeting)[startsWith(names(combined_TF_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_TF_targeting[[selected_columns[1]]] - combined_TF_targeting[[selected_columns[2]]] #ensure difference is `het - control` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_TF_targeting[[diff_colname]] <- diff_col
  }
}

het_enriched_TF <- replace(diff_TF_targeting, diff_TF_targeting[,] < 0, 0) #creating dataframe where the differential is enriched in the het condition
save(het_enriched_TF, file = here("results/diff_targeting/kidney_het_enriched_TF.Rdata"))
```

```{r calculate-ctrl-enriched-diff-targeting}
#creating empty data frame
 diff_TF_targeting <- data.frame(matrix(NA, nrow = nrow(combined_TF_targeting), ncol = 1))
 colnames(diff_TF_targeting) <- "TF" #this will need to be gene or TF respectively
 diff_TF_targeting$TF <- combined_TF_targeting$TF #adding gene/TF

# calc diff targeting 
cell_names <- colnames(TF_targeting_all_ctrl[,-1]) %>% sub("_ctrl.*", "", .) #all cell type prefixes except TF name, which should be first column in data
for(i in cell_names){
  selected_columns <- names(combined_TF_targeting)[startsWith(names(combined_TF_targeting), i)]
  # Check there are two columns with the specified prefix
  if (length(selected_columns) == 2) {
    diff_col <- combined_TF_targeting[[selected_columns[2]]] - combined_TF_targeting[[selected_columns[1]]] #ensure difference is `control - het` here
    # Create a new column name
    diff_colname <- paste0(i)
    # Add the result to the result dataframe
    diff_TF_targeting[[diff_colname]] <- diff_col
  }
}

ctrl_enriched_TF <- replace(diff_TF_targeting, diff_TF_targeting[,] < 0, 0) #creating dataframe where the differential is enriched in the ctrl condition
save(ctrl_enriched_TF, file = here("results/diff_targeting/kidney_ctrl_enriched_TF.Rdata"))
```

```{r visualizing-all-diff-TF-het-enriched}
##formatting input data
data <- het_enriched_TF
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_DIFFtargeting_het_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of S858R enriched TFs in Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualizing-all-diff-TF-het-enriched-setbp1TFs}
##formatting input data
data <- het_enriched_TF[het_enriched_TF$TF %in% setbp1_genes,]

names <- data$TF #add names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_DIFFtargeting_het_Setbp1targets_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential TF Targeting of known targets of Setbp1 in S858R enriched TFs of Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-TFs-Setbp1Target-het-enriched}
##pathway analysis and plotting
exclude_column <- "TF" #note: this needs to be changed for TF or gene respectively, indicates which columns to pivot longer below, 
data <- het_enriched_TF[het_enriched_TF$TF %in% setbp1_genes,] %>% pivot_longer(., cols = which(colnames(.) != exclude_column), names_to = "cell_type", values_to =  "targeting_score") %>% .[!.$targeting_score == 0,]

for(i in cell_names){
  # grab genes/TFs from cell type i ----------
  top <- data[data$cell_type == i,]
  genes <- as.character(top$TF)
  # submit genes to pathway analysis function ---------- 
  fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
  png(paste0(here("results/diff_targeting/"), "DiffTargeting_", i, "TFs_ Setbp1targets_het_enriched.png"), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Differentially Targeted TFs (Setbp1 or known targets) in Setbp1 S858R ", i)) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) + 
    theme_minimal()
  print(plot) 
  dev.off()
  print(paste0("pathways investigated and plotted in ", i))
}
``` 

```{r visualizing-all-diff-TF-ctrl-enriched}
##formatting input data
data <- ctrl_enriched_TF
names <- data$TF #add TF names as rownames
data <- abs(data[,-1])
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_DIFFtargeting_ctrl_enriched_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of Control enriched TFs in Kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualize-distribution-of-het-gene-difftargeting-scores}
#het gene distribution
exclude_column <- "gene"

pivoted <- pivot_longer(het_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched) != exclude_column))
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Gene targeting score distribution in S8585R") + 
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
summary(het_enriched)
```


```{r het-diff-gene-targeting-distribution-nonzero}
#het gene distribution nonzero
nonzero <- pivoted[pivoted$targeting_score!=0,]
png(filename = here("results/diff_targeting/kidney_difftargeting_het_gene_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Gene differential targeting score distribution in S8585R") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
summary(nonzero_long)

exclude_column <- "TF"
pivoted <- pivot_longer(het_enriched_TF, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched_TF) != exclude_column))
summary(het_enriched)
```

```{r control-diff-gene-targeting-distribution}
#control gene distribution
exclude_column <- "gene"
pivoted <- pivot_longer(ctrl_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(ctrl_enriched) != exclude_column))
ggplot(data=pivoted, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
  geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Gene targeting score distribution in Control") + 
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))

summary(ctrl_enriched)


nonzero <- pivoted[pivoted$targeting_score!=0,]
png(filename = here("results/diff_targeting/kidney_difftargeting_ctrl_gene_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Gene differential targeting score distribution in Control") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
nonzero_long <- abs(nonzero_long[,which(colnames(nonzero_long) != exclude_column)])
summary(nonzero_long)
```

```{r het-diff-TF-targting-dist}
#het TF distribution
exclude_column <- "TF"

pivoted <- pivot_longer(het_enriched_TF, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched_TF) != exclude_column))
ggplot(data=pivoted, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("TF targeting score distribution in S8585R") +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
summary(het_enriched)

nonzero <- pivoted[pivoted$targeting_score!=0,]
png(filename = here("results/diff_targeting/kidney_difftargeting_het_TF_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=targeting_score, group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("TF differential targeting score distribution in S8585R") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()


nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
summary(nonzero_long)
```

```{r ctrl-diff-TF-targting-dist}
exclude_column <- "TF"
pivoted <- pivot_longer(ctrl_enriched_TF, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched_TF) != exclude_column))
ggplot(data=pivoted, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("TF targeting score distribution in Control") +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))

summary(ctrl_enriched)

nonzero <- pivoted[pivoted$targeting_score!=0,]
png(filename = here("results/diff_targeting/kidney_difftargeting_ctrl_TF_distribution.png"), 
    width = 1000,
    height = 500)
ggplot(data=nonzero, aes(x=abs(targeting_score), group=cell_type, color=cell_type)) +
    geom_density(adjust=1.5, alpha=.4) +
  ggtitle("TF differential targeting score distribution in Control") +
  theme_bw() +
  scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()

nonzero_long <- pivot_wider(nonzero, names_from =cell_type, values_from = targeting_score)
nonzero_long <- abs(nonzero_long[,c(2:8)])
summary(nonzero_long)
```

```{r visualize-het-enriched-gene-top20}
#rank TFs by targeting for each cell type , find top 20
astro_rank_het <- het_enriched[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_het <- het_enriched[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_het <- het_enriched[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_het <- het_enriched[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_het <- het_enriched[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_het <- het_enriched[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_het <- het_enriched[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

het_enriched_top <- rbind(astro_rank_het, ex_rank_het, in_rank_het, micro_rank_het, mural_rank_het, oligo_rank_het, opcs_rank_het)
```

```{r visualize-het-enriched-gene-top20-heatmap}
#setting annotation colors
annotation_colors <- list("cell_type" = c("excitatory" = "#DC71FA", "inhibitory" = "#00BBDB", "oligodendrocyte" = "#7997FF", "astrocytes" = "#6968B4", "micro" = "#C216B7", "opcs" = "#00C1AA", "mural" = "#027461", "fibro" = "#0a2f6f"))
##formatting input data
data <- het_enriched_top[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/cortex_gene_DIFFtargeting_top20_het_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes within Cell-types in Setbp1 S858R Cerebral Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```


```{r visualize-het-enriched-TF-top20}
#rank TFs by targeting for each cell type , find top 20
astro_rank_het <- het_enriched_TF[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_het <- het_enriched_TF[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_het <- het_enriched_TF[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_het <- het_enriched_TF[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_het <- het_enriched_TF[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_het <- het_enriched_TF[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_het <- het_enriched_TF[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

het_enriched_TF_top <- rbind(astro_rank_het, ex_rank_het, in_rank_het, micro_rank_het, mural_rank_het, oligo_rank_het, opcs_rank_het)
```

```{r visualize-het-enriched-TF-top20-heatmap}
##formatting input data
data <- het_enriched_TF_top[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_DIFFtargeting_top20_het_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 TFs within Cell-types in Setbp1 S858R kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-top20genes-het-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- het_enriched_top[het_enriched_top$cell_type == "astrocytes",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- het_enriched_top[het_enriched_top$cell_type == "excitatory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- het_enriched_top[het_enriched_top$cell_type == "inhibitory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- het_enriched_top[het_enriched_top$cell_type == "mural",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- het_enriched_top[het_enriched_top$cell_type == "microglia",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- het_enriched_top[het_enriched_top$cell_type == "oligodendrocyte",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- het_enriched_top[het_enriched_top$cell_type == "opcs",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_genes_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 S858R opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
```

```{r GO-difftargeting-top20TFs-het-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "astrocytes",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "excitatory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "inhibitory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "mural",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "microglia",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "oligodendrocyte",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- het_enriched_TF_top[het_enriched_TF_top$cell_type == "opcs",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_TFs_ het_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 S858R opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
``` 


```{r visualize-ctrl-enriched-TF-top20}
#rank TFs by targeting for each cell type , find top 20
ctrl_enriched_TF <- ctrl_enriched_TF[,2:8] %>% abs() %>% mutate(TF= ctrl_enriched_TF$TF)
ctrl_enriched_TF <- ctrl_enriched_TF[,c(8,1,2,3,4,5,6,7)]

astro_rank_ctrl <- ctrl_enriched_TF[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_ctrl <- ctrl_enriched_TF[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_ctrl <- ctrl_enriched_TF[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_ctrl <- ctrl_enriched_TF[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_ctrl <- ctrl_enriched_TF[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_ctrl <- ctrl_enriched_TF[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl <- ctrl_enriched_TF[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

ctrl_enriched_TF_top <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl)
```

```{r visualize-ctrl-enriched-TF-top20-heatmap}
##formatting input data
data <- ctrl_enriched_TF_top[, c("TF", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$TF #add TF names as rownames
data <- data[,-1, drop = FALSE]#drop TF column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_TF_DIFFtargeting_top20_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "TFs"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 TFs within Cell-types in Setbp1 Control kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r visualize-ctrl-enriched-gene-top20}
ctrl_enriched <- ctrl_enriched[,2:8] %>% abs() %>% mutate(gene= ctrl_enriched$gene)
ctrl_enriched <- ctrl_enriched[,c(8,1,2,3,4,5,6,7)]

#rank TFs by targeting for each cell type , find top 20
astro_rank_ctrl <- ctrl_enriched[ ,c(1,2)] %>% arrange(desc(astrocytes)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "astrocytes") %>% slice(1:20) %>% rename(targeting_score = astrocytes)
ex_rank_ctrl <- ctrl_enriched[ ,c(1,3)] %>% arrange(desc(excitatory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "excitatory") %>% slice(1:20) %>% rename(targeting_score = excitatory)
in_rank_ctrl <- ctrl_enriched[ ,c(1,4)] %>% arrange(desc(inhibitory)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "inhibitory") %>% slice(1:20) %>% rename(targeting_score = inhibitory)
micro_rank_ctrl <- ctrl_enriched[ ,c(1,5)] %>% arrange(desc(microglia)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "microglia") %>% slice(1:20) %>% rename(targeting_score = microglia)
mural_rank_ctrl <- ctrl_enriched[ ,c(1,6)] %>% arrange(desc(mural)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "mural") %>% slice(1:20) %>% rename(targeting_score = mural)
oligo_rank_ctrl <- ctrl_enriched[ ,c(1,7)] %>% arrange(desc(oligodendrocyte)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "oligodendrocyte") %>% slice(1:20) %>% rename(targeting_score = oligodendrocyte)
opcs_rank_ctrl <- ctrl_enriched[ ,c(1,8)] %>% arrange(desc(opcs)) %>% mutate(rank = seq(1:nrow(.))) %>% mutate(cell_type = "opcs") %>% slice(1:20)  %>% rename(targeting_score = opcs)

ctrl_enriched_top <- rbind(astro_rank_ctrl, ex_rank_ctrl, in_rank_ctrl, micro_rank_ctrl, mural_rank_ctrl, oligo_rank_ctrl, opcs_rank_ctrl)
```


```{r visualize-ctrl-enriched-gene-top20-heatmap}
##formatting input data
data <- ctrl_enriched_top[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] = 0
names <- data$gene #add gene names as rownames
data <- data[,-1, drop = FALSE]#drop gene column
rownames(data) <- names
#setting meta colname 
meta_colname <- "cell_type"
#setting plot path
plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_top20_ctrl_heatmap.png")
#setting rowtitle
rowtitle <- "genes"
#setting columntitle
plot_title <- "Differential Targeting of Top 20 Genes within Cell-types in Setbp1 Ctrl kidney Cortex"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
```

```{r GO-difftargeting-top20genes-ctrl-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "astrocytes",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "excitatory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "inhibitory",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "mural",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "microglia",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "oligodendrocyte",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- ctrl_enriched_top[ctrl_enriched_top$cell_type == "opcs",]
genes <- as.character(top$gene)

# submit genes to pathway analysis function ---------- 
fea_result_filt <- fea(genes = genes, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_genes_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted Genes in Setbp1 Control opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
```

```{r GO-difftargeting-top20TFs-ctrl-enriched}
##pathway analysis and plotting
#astrocytes ----------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "astrocytes",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_astro_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control Astrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#excitatory ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "excitatory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_ex_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control Excitatory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#inhibitory ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "inhibitory",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_inhib_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control inhibitory Neurons")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#mural ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "mural",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_mural_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control Mural cells")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 

#microglia ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "microglia",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_microglia_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control microglia")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off()   
    
#oligodendrocytes ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "oligodendrocyte",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_oligodendrocytes_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control oligodendrocytes")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
  
#opcs ------------
top <- ctrl_enriched_TF_top[ctrl_enriched_TF_top$cell_type == "opcs",]
TFs <- as.character(top$TF)

# submit TFs to pathway analysis function ---------- 
fea_result_filt <- fea(genes = TFs, organism = "mmusculus", max_term = 1000, min_term = 1)
png(paste0(here("results/diff_targeting/DiffTargeting_opcs_TFs_ ctrl_enriched.png")), width = 1000, height = 1000)
# plot dotplot and add title based on input variable ----------
plot <- bubbleplot(fea_result_filt) +  
    ggtitle(paste0("Pathways Associated with Top 20 Differentially Targeted TFs in Setbp1 Control opcs")) + 
    theme(plot.title = element_text(hjust = 0.5, size = 12)) 
  print(plot) 
  dev.off() 
``` 

```{r}
proc.time()
```

```{r}
sessionInfo()
```

R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.5 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2           styler_1.9.0          here_1.0.1            gprofiler2_0.2.1      readr_2.1.4           circlize_0.4.15       magrittr_2.0.3       
 [8] RColorBrewer_1.1-3    ComplexHeatmap_2.10.0 ggpubr_0.6.0          ggplot2_3.4.1         tidyr_1.3.0           limma_3.50.3          dplyr_1.1.0          
[15] data.table_1.14.8     netZooR_1.2.1         matrixcalc_1.0-6      yarn_1.20.0           pandaR_1.26.0         Biobase_2.54.0        BiocGenerics_0.40.0  
[22] reticulate_1.28       igraph_1.4.1         

loaded via a namespace (and not attached):
  [1] rappdirs_0.3.3              rtracklayer_1.54.0          pbdZMQ_0.3-9                AnnotationForge_1.36.0      R.methodsS3_1.8.2          
  [6] bumphunter_1.36.0           minfi_1.40.0                bit64_4.0.5                 knitr_1.42                  R.utils_2.12.2             
 [11] DelayedArray_0.20.0         KEGGREST_1.34.0             RCurl_1.98-1.10             GEOquery_2.62.2             doParallel_1.0.17          
 [16] generics_0.1.3              GenomicFeatures_1.46.5      preprocessCore_1.56.0       callr_3.7.3                 RSQLite_2.3.0              
 [21] chron_2.3-59                bit_4.0.5                   tzdb_0.3.0                  base64url_1.4               xml2_1.3.3                 
 [26] SummarizedExperiment_1.24.0 assertthat_0.2.1            STRINGdb_2.6.5              xfun_0.37                   hms_1.1.2                  
 [31] evaluate_0.20               fansi_1.0.4                 restfulr_0.0.15             scrime_1.3.5                progress_1.2.2             
 [36] caTools_1.18.2              dbplyr_2.3.1                Rgraphviz_2.38.0            DBI_1.1.3                   htmlwidgets_1.6.1          
 [41] reshape_0.8.9               stats4_4.1.3                purrr_1.0.1                 hash_2.2.6.2                ellipsis_0.3.2             
 [46] backports_1.4.1             permute_0.9-7               annotate_1.72.0             biomaRt_2.50.3              sparseMatrixStats_1.6.0    
 [51] MatrixGenerics_1.6.0        vctrs_0.5.2                 remotes_2.4.2               penalized_0.9-52            abind_1.4-5                
 [56] cachem_1.0.7                withr_2.5.0                 vegan_2.6-4                 GenomicAlignments_1.30.0    prettyunits_1.1.1          
 [61] mclust_6.0.0                cyclocomp_1.1.0             cluster_2.1.2               IRdisplay_1.1               lazyeval_0.2.2             
 [66] crayon_1.5.2                uchardet_1.1.1              genefilter_1.76.0           edgeR_3.36.0                pkgconfig_2.0.3            
 [71] GenomeInfoDb_1.30.1         nlme_3.1-155                nnet_7.3-17                 rlang_1.0.6                 RJSONIO_1.3-1.8            
 [76] lifecycle_1.0.3             downloader_0.4              filelock_1.0.2              BiocFileCache_2.2.1         rex_1.2.1                  
 [81] GOstats_2.60.0              quantro_1.28.0              rprojroot_2.0.3             matrixStats_0.63.0          graph_1.72.0               
 [86] rngtools_1.5.2              base64_2.0.1                Matrix_1.5-3                IRkernel_1.3.2              carData_3.0-5              
 [91] Rhdf5lib_1.16.0             base64enc_0.1-3             processx_3.8.0              GlobalOptions_0.1.2         png_0.1-8                  
 [96] viridisLite_0.4.1           rjson_0.2.21                bitops_1.0-7                R.oo_1.25.0                 KernSmooth_2.23-20         
[101] rhdf5filters_1.6.0          Biostrings_2.62.0           blob_1.2.3                  DelayedMatrixStats_1.16.0   doRNG_1.8.6                
[106] shape_1.4.6                 stringr_1.5.0               nor1mix_1.3-0               R.cache_0.16.0              rstatix_0.7.2              
[111] S4Vectors_0.32.4            ggsignif_0.6.4              scales_1.2.1                memoise_2.0.1               GSEABase_1.56.0            
[116] plyr_1.8.8                  hexbin_1.28.2               gplots_3.1.3                zlibbioc_1.40.0             compiler_4.1.3             
[121] BiocIO_1.4.0                illuminaio_0.36.0           plotrix_3.8-2               clue_0.3-64                 Rsamtools_2.10.0           
[126] cli_3.6.0                   XVector_0.34.0              Category_2.60.0             ps_1.7.2                    MASS_7.3-55                
[131] mgcv_1.8-39                 tidyselect_1.2.0            stringi_1.7.12              yaml_2.3.7                  askpass_1.1                
[136] locfit_1.5-9.7              tools_4.1.3                 parallel_4.1.3              rstudioapi_0.14             uuid_1.1-0                 
[141] foreach_1.5.2               digest_0.6.31               proto_1.0.0                 quadprog_1.5-8              Rcpp_1.0.10                
[146] GenomicRanges_1.46.1        car_3.1-1                   siggenes_1.68.0             broom_1.0.3                 org.Hs.eg.db_3.14.0        
[151] httr_1.4.5                  ggdendro_0.1.23             AnnotationDbi_1.56.2        colorspace_2.1-0            XML_3.99-0.13              
[156] fs_1.6.1                    IRanges_2.28.0              splines_4.1.3               RBGL_1.70.0                 multtest_2.50.0            
[161] plotly_4.10.1               xtable_1.8-4                jsonlite_1.8.4              R6_2.5.1                    RUnit_0.4.32               
[166] gsubfn_0.7                  pillar_1.8.1                htmltools_0.5.4             glue_1.6.2                  fastmap_1.1.1              
[171] BiocParallel_1.28.3         beanplot_1.3.1              codetools_0.2-18            utf8_1.2.3                  lattice_0.20-45            
[176] tibble_3.1.8                sqldf_0.4-11                curl_5.0.0                  gtools_3.9.4                GO.db_3.14.0               
[181] openssl_2.0.5               survival_3.3-1              rmarkdown_2.20              repr_1.1.6                  desc_1.4.2                 
[186] munsell_0.5.0               GetoptLong_1.0.5            rhdf5_2.38.1                GenomeInfoDbData_1.2.7      iterators_1.0.14           
[191] RCy3_2.14.2                 HDF5Array_1.22.1            reshape2_1.4.4              gtable_0.3.1               


