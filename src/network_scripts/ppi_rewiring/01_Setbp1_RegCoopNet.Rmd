---
title: "01_Setbp1_RegCoopNet"
author: "Jordan Whitlock"
date: '2023-05-25'
output: html_document
---

Goal: Determine PPI in reference to TF-gene regulation in Setbp1 S858R mice. 

# Set up data:
Step 1. Filter regNet for only Setbp1 as a TF
Step 2. Filter PPI for proteins in Setbp1 gene set
Step 3. Map Setbp1 and the genes it regulates in the regNet to their corresponding PPI. 
Step 4. Create final data frame with Setbp1 TF, target gene, regNet scores, PPI, and coopNet scores.
Step 5. Removing self-interactions
Step 6. plotting distributions of scores for regNet and coopNet
Step 7. comparing gene regulation presence to ppi presence (using sign change as a metric)
Step 8. compare seed ppi and ppi after running PANDA

```{r loading-libraries}
set.seed(2178)
library(reshape2)
library(scales)
library(stringr)
library(dplyr)
library(cowplot)
library(ggplot2)
library(here)
library(data.table)
library(ComplexHeatmap)
library(tidyr)
library(ggridges)
library(purrr)
library(ggplot2)
library(plotly)
source(here("src/functions/functions.R"))
ptm <- proc.time()
```

```{r loading-data}
setbp1_genes <- read.csv(here("results/seurat/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1") #consider commenting out 
```

```{r combined-network-dataframe}
files <- list.files(here("results/PANDA"), full.names = TRUE)

combo_net_gene_ppi_1 <- list()

#run for loop
for(i in files){
  #load in the pandaResults
  load(i)
  name <- sub("expression_PANDA.Rdata", "", basename(i))
  #extracting-networks
  coopNet <- pandaResults@coopNet
  coopNet <- reshape2::melt(coopNet, varnames = c("ppi_1", "ppi_2"), value.name = "coopNet_score")
  
  regNet <- pandaResults@regNet
  regNet <- reshape2::melt(regNet, varnames = c("TF", "gene"), value.name = "regNet_score")
  
  #filtering-regNet-for-Setbp1TF
  filtered_regNet <- regNet[regNet$TF == "Setbp1",]
  
  #filtering-ppi-for-geneset
  filtered_coopNet<- coopNet[coopNet$ppi_1 %in% setbp1_genes,]
  colnames(filtered_coopNet) <- c("gene", "ppi_2", "coopNet_score")
  
  #grabbing-overlap
  combo <- merge(filtered_regNet, filtered_coopNet, by = "gene", all = FALSE)
  colnames(combo) <- c("gene_ppi_1", "TF", "regNet_score", "ppi_2", "coopNet_score") 
  
  #store in list
  combo_net_gene_ppi_1[[name]] <- combo
  
  #clean up env
  rm(pandaResults)
  rm(coopNet)
  rm(regNet)
  
  print(paste0(name, " filtered, combined, and saved."))
}

#save(combo_net_gene_ppi_1, file = here("results/ppi_rewiring/regNet_coopNet_combo_ppi_1_gene.Rdata"))
```

```{r removing self-interactions}
# removing relationships where gene/ppi_1 is the same as ppi_2 (example: Ncoa1 - Ncoa1)
combo_net_nondup <- list()

for(i in seq_along(combo_net_gene_ppi_1)){
  combo <- combo_net_gene_ppi_1[[i]]
  combo_nondup <- combo[as.character(combo$gene_ppi_1) != as.character(combo$ppi_2), ]
  combo_net_nondup[[i]] <- combo_nondup
}

names(combo_net_nondup) <- names(combo_net_gene_ppi_1)
```

```{r visualizing-score-distributions}
pdf(here("results/ppi_rewiring/combo_net_nondup-distribution.pdf"))

plot <- ggplot(combo_net_nondup$smcs_heterozygouskidney) +
  geom_density(aes(x = regNet_score)) +
  theme_bw() +
  labs(y = "regNet score") +
  theme(text = element_text(family = "Helvetica")) +
  ggtitle("het smcs regNet Score Distribution") 

plot

plot2 <- ggplot(combo_net_nondup$smcs_heterozygouskidney) +
  geom_density(aes(x = coopNet_score)) +
  theme_bw() +
  labs(y = "coopNet score") +
  theme(text = element_text(family = "Helvetica")) +
  ggtitle("het smcs coopNet Score Distribution")

plot2

plot3 <- ggplot(combo_net_nondup$astrocytes_heterozygouscortex) +
  geom_density(aes(x = regNet_score)) +
  theme_bw() +
  labs(y = "regNet score") +
  theme(text = element_text(family = "Helvetica")) +
  ggtitle("het astrocytes regNet Score Distribution") 

plot3

plot4 <- ggplot(combo_net_nondup$astrocytes_heterozygouscortex) +
  geom_density(aes(x = coopNet_score)) +
  theme_bw() +
  labs(y = "coopNet score") +
  theme(text = element_text(family = "Helvetica")) +
  ggtitle("het astrocytes coopNet Score Distribution")

plot4

dev.off()
```

```{r change-in-regulation-ppi}
combo_nondup <- combo_net_nondup$Bcell_controlkidney
dim(combo_nondup) 

occurrence <- table(sign(combo_nondup$regNet_score), sign(combo_nondup$coopNet_score))
occurrence

total_occurrence <- occurrence[1,1] + occurrence[1,-1] + occurrence[-1,1] + occurrence[-1,-1]
total_occurrence # adds up to dimension of original input dataframe 
```

```{r combined-network-dataframe-gene-ppi2}
files <- list.files(here("results/PANDA"), full.names = TRUE)

combo_net_gene_ppi_2 <- list()

#run for loop
for(i in files){
  #load in the pandaResults
  load(i)
  name <- sub("expression_PANDA.Rdata", "", basename(i))
  #extracting-networks
  coopNet <- pandaResults@coopNet
  coopNet <- reshape2::melt(coopNet, varnames = c("ppi_1", "ppi_2"), value.name = "coopNet_score")
  
  regNet <- pandaResults@regNet
  regNet <- reshape2::melt(regNet, varnames = c("TF", "gene"), value.name = "regNet_score")
  
  #filtering-regNet-for-Setbp1TF
  filtered_regNet <- regNet[regNet$TF == "Setbp1",]
  
  #filtering-ppi-for-geneset
  filtered_coopNet<- coopNet[coopNet$ppi_2 %in% setbp1_genes,]
  colnames(filtered_coopNet) <- c("gene", "ppi_1", "coopNet_score")
  
  #grabbing-overlap
  combo <- merge(filtered_regNet, filtered_coopNet, by = "gene", all = FALSE)
  colnames(combo) <- c("gene_ppi_2", "TF", "regNet_score", "ppi_1", "coopNet_score") 
  
  #store in list
  combo_net_gene_ppi_2[[name]] <- combo
  
  #clean up env
  rm(pandaResults)
  rm(coopNet)
  rm(regNet)
  
  print(paste0(name, " filtered, combined, and saved."))
}

#save(combo_net_gene_ppi_2, file = here("results/ppi_rewiring/regNet_coopNet_combo_ppi_2_gene.Rdata"))
```

```{r comparing-seed-ppi-to-coopNet}
seed_ppi <- read.table(file = "/data/user/jbarham3/230227_JW_Setbp1Manuscript/data/processed/ppi_inputs/mm10_ppi.txt", sep = "\t") #load in ppi data
seed_ppi$from_to <- paste(seed_ppi$from, seed_ppi$to, sep = "_")

load(files[1])
coopNet <- pandaResults@coopNet
coopNet <- reshape2::melt(coopNet, varnames = c("from", "to"), value.name = "score")
coopNet$from_to <- paste(coopNet$from, coopNet$to, sep = "_")

seed_coopNet_combo <- merge(coopNet, seed_ppi, by = "from_to", all = FALSE)
seed_coopNet_combo <- seed_coopNet_combo[,c(1,4,7)]
colnames(seed_coopNet_combo) <- c("from_to", "coopNet_score", "seed_score")

# #transforming to z score to allow comparisons 
# seed_coopNet_combo$coop_z_scores <- scale(seed_coopNet_combo$coopNet_score)
# seed_coopNet_combo$seed_z_scores <- scale(seed_coopNet_combo$seed_score)

# transforming to min-max and find difference
seed_coopNet_combo$coop_min_max <- (seed_coopNet_combo$coopNet_score - min(seed_coopNet_combo$coopNet_score)) / (max(seed_coopNet_combo$coopNet_score) - min(seed_coopNet_combo$coopNet_score))

seed_coopNet_combo$seed_min_max <- (seed_coopNet_combo$seed_score - min(seed_coopNet_combo$seed_score)) / (max(seed_coopNet_combo$seed_score) - min(seed_coopNet_combo$seed_score))

seed_coopNet_combo$min_max_diff <- seed_coopNet_combo$coop_min_max - seed_coopNet_combo$seed_min_max

# unsplit from_to and filter based off of TFs that are in the FROM column:
seed_coopNet_combo <- separate(seed_coopNet_combo, from_to, into = c("from", "to"), sep = "_")

#filter for just TFs
regNet <- pandaResults@regNet
regNet <- reshape2::melt(regNet, varnames = c("TF", "gene"), value.name = "regNet_score")


TF_list <- c("Setbp1", "Tfdp2", "Mybl1") #randomly selected TFs from GTRD(https://gtrd.biouml.org/#!table/gtrd_current.tf_links/Brief)
TFs_from <- seed_coopNet_combo[seed_coopNet_combo$from %in% TF_list,]
TFs_to <- seed_coopNet_combo[seed_coopNet_combo$to %in% TF_list,]
# genes <- seed_coopNet_combo[seed_coopNet_combo$from %in% regNet$gene,]
#filter for just genes

# taking the seed_score (from STRING values ranging from 0-999 and subtracting the absolute value of the CoopNet)
```

# Investigating regNet --> coopNet sign change:
1. Annotating sign change for both the gene-ppi_1 overlap and gene-ppi_2 overlap to see where the regNet score and coopNet score
2. Subsetting for only the sign change that was "both_positive" where the TF is Setbp1 
3. Filtering for the Banfi et al proteins
4. Wrangling back into a single dataframe
5. Assigning mechanims from Setbp1 literature
6. Filtering for protein from coopNet that is in setbp1 gene set 
```{r sign-change-assignment}
combo_net_gene_ppi_1 <- lapply(combo_net_gene_ppi_1, function(df) {
  df %>%
    mutate(annotation = case_when(
      regNet_score > 0 & coopNet_score > 0 ~ "both_positive",
      regNet_score < 0 & coopNet_score < 0 ~ "both_negative",
      regNet_score < 0 & coopNet_score > 0 ~ "neg_pos",
      regNet_score > 0 & coopNet_score < 0 ~ "pos_neg",
      TRUE ~ NA_character_
    ))
})

combo_net_gene_ppi_2 <- lapply(combo_net_gene_ppi_2, function(df) {
  df %>%
    mutate(annotation = case_when(
      regNet_score > 0 & coopNet_score > 0 ~ "both_positive",
      regNet_score < 0 & coopNet_score < 0 ~ "both_negative",
      regNet_score < 0 & coopNet_score > 0 ~ "neg_pos",
      regNet_score > 0 & coopNet_score < 0 ~ "pos_neg",
      TRUE ~ NA_character_
    ))
})
```

## filtering for proteins in literature mechanisms (Banfi et al):
```{r filtering-Banfi-lit-mech}
Banfi <- c("Akt1", "Akt", "Anp32a", "Apex1", "Apex", "Cdk2", "Hcif1", "Hcf1", "Hmg2", "Hmgb2", "Kmt2a", "Nme1", "Ppp2r1a", "Set", "Taf1a", "Tceal1", "Trex1", "Trp53", "Tp53")

filtered_gene_ppi_1 <- lapply(combo_net_gene_ppi_1, function(df) subset(df, gene_ppi_1 == Banfi))
filtered_ppi_2 <- lapply(combo_net_gene_ppi_1, function(df) subset(df, ppi_2 == Banfi))
filtered_gene_ppi_2 <- lapply(combo_net_gene_ppi_2, function(df) subset(df, gene_ppi_2 == Banfi))
filtered_ppi_1 <- lapply(combo_net_gene_ppi_2, function(df) subset(df, ppi_1 == Banfi))

# renaming columns since the interaction is not directional
for(i in seq_along(filtered_gene_ppi_1)) {
  filtered_gene_ppi_1[[i]] <- rename(filtered_gene_ppi_1[[i]], gene_ppi = gene_ppi_1)
  filtered_gene_ppi_1[[i]] <- rename(filtered_gene_ppi_1[[i]], ppi = ppi_2)
}

for(i in seq_along(filtered_ppi_2)) {
  filtered_ppi_2[[i]] <- rename(filtered_ppi_2[[i]], gene_ppi = gene_ppi_1)
  filtered_ppi_2[[i]] <- rename(filtered_ppi_2[[i]], ppi = ppi_2)
}

for(i in seq_along(filtered_gene_ppi_2)) {
  filtered_gene_ppi_2[[i]] <- rename(filtered_gene_ppi_2[[i]], gene_ppi = gene_ppi_2)
  filtered_gene_ppi_2[[i]] <- rename(filtered_gene_ppi_2[[i]], ppi = ppi_1)
} 

for(i in seq_along(filtered_ppi_1)) {
  filtered_ppi_1[[i]] <- rename(filtered_ppi_1[[i]], gene_ppi = gene_ppi_2)
  filtered_ppi_1[[i]] <- rename(filtered_ppi_1[[i]], ppi = ppi_1)
}

# combining dataframes from both lists into one single dataframe 
Banfi_combined_filtered <- mapply(function(df1, df2, df3, df4) {
  bind_rows(df1, df2, df3, df4)
}, filtered_ppi_1, filtered_ppi_2, filtered_ppi_1, filtered_ppi_2, SIMPLIFY = FALSE)

# unlisting the object and combining based on tissue
kidney <- Banfi_combined_filtered[grepl("kidney", names(Banfi_combined_filtered))]
kidney_banfi <- kidney %>%
  map_df(~ tibble::as_tibble(.x), .id = "source")

# keep unique rows
kidney_banfi <- unique(kidney_banfi)

# unlisting the object and combining based on tissue
cortex <- Banfi_combined_filtered[grepl("cortex", names(Banfi_combined_filtered))]
cortex_banfi <- cortex %>%
  map_df(~ tibble::as_tibble(.x), .id = "source")

# keep unique rows
cortex_banfi <- unique(cortex_banfi)
```

```{r annotate-mechanism}
# annotate for mechanism based off of Banfi et al (can be 'cell cycle', 'chromatin remodeling', 'DNA damage', 'phosphorylation', 'binding')
binding <- c("Kmt2a", "Hcif1") #from "epigenetic hub" paper
cell_cycle <- c("Cdk2", "Trp53", "Tp53", "Tceal1", "Set")
chromatin_remodeling <- c("Anp32a", "Taf1a", "Set")
dna_damage <- c("Apex1", "Anp32a", "Apex", "Hmg2", "Hmgb2", "Nme1", "Set", "Trex1")
phosphorylation <- c("Ppp2r1a", "Anp32a", "Set", "Akt", "Akt1")

## cortex
cortex_banfi$binding_gene <- ifelse(cortex_banfi$gene_ppi %in% binding, "binding", NA)
cortex_banfi$binding_ppi <- ifelse(cortex_banfi$ppi %in% binding, "binding", NA)

cortex_banfi$cellcycle_gene <- ifelse(cortex_banfi$gene_ppi %in% cell_cycle, "cell cycle", NA)
cortex_banfi$cellcycle_ppi <- ifelse(cortex_banfi$ppi %in% cell_cycle, "cell cycle", NA)

cortex_banfi$chromatin_remodeling_gene <- ifelse(cortex_banfi$gene_ppi %in% chromatin_remodeling, "chromatin remodeling", NA)
cortex_banfi$chromatin_remodeling_ppi <- ifelse(cortex_banfi$ppi %in% chromatin_remodeling, "chromatin remodleing", NA)

cortex_banfi$dna_damage_gene <- ifelse(cortex_banfi$gene_ppi %in% dna_damage, "DNA damage", NA)
cortex_banfi$dna_damage_ppi <- ifelse(cortex_banfi$ppi %in% dna_damage, "DNA damage", NA)

cortex_banfi$phosphorylation_gene <- ifelse(cortex_banfi$gene_ppi %in% phosphorylation, "phosphorylation", NA)
cortex_banfi$phosphorylation_ppi <- ifelse(cortex_banfi$ppi %in% phosphorylation, "phosphorylation", NA)

## kidney 
kidney_banfi$binding_gene <- ifelse(kidney_banfi$gene_ppi %in% binding, "binding", NA)
kidney_banfi$binding_ppi <- ifelse(kidney_banfi$ppi %in% binding, "binding", NA)

kidney_banfi$cellcycle_gene <- ifelse(kidney_banfi$gene_ppi %in% cell_cycle, "cell cycle", NA)
kidney_banfi$cellcycle_ppi <- ifelse(kidney_banfi$ppi %in% cell_cycle, "cell cycle", NA)

kidney_banfi$chromatin_remodeling_gene <- ifelse(kidney_banfi$gene_ppi %in% chromatin_remodeling, "chromatin remodeling", NA)
kidney_banfi$chromatin_remodeling_ppi <- ifelse(kidney_banfi$ppi %in% chromatin_remodeling, "chromatin remodleing", NA)

kidney_banfi$dna_damage_gene <- ifelse(kidney_banfi$gene_ppi %in% dna_damage, "DNA damage", NA)
kidney_banfi$dna_damage_ppi <- ifelse(kidney_banfi$ppi %in% dna_damage, "DNA damage", NA)

kidney_banfi$phosphorylation_gene <- ifelse(kidney_banfi$gene_ppi %in% phosphorylation, "phosphorylation", NA)
kidney_banfi$phosphorylation_ppi <- ifelse(kidney_banfi$ppi %in% phosphorylation, "phosphorylation", NA)

# remove columns with all NA
kidney_banfi <- kidney_banfi[, !apply(is.na(kidney_banfi), 2, all)]
cortex_banfi <- cortex_banfi[, !apply(is.na(cortex_banfi), 2, all)]

# combine mechanisms into one column
kidney_banfi$mechanism <- ifelse(is.na(kidney_banfi$cellcycle_ppi), kidney_banfi$dna_damage_ppi,
                                 ifelse(is.na(kidney_banfi$dna_damage_ppi), kidney_banfi$cellcycle_ppi, paste(kidney_banfi$cellcycle_ppi,
                                                                                                              kidney_banfi$dna_damage_ppi, sep = ",")))
cortex_banfi$mechanism <- ifelse(is.na(cortex_banfi$cellcycle_ppi), cortex_banfi$dna_damage_ppi,
                                 ifelse(is.na(cortex_banfi$dna_damage_ppi), cortex_banfi$cellcycle_ppi, paste(cortex_banfi$cellcycle_ppi,
                                                                                                              cortex_banfi$dna_damage_ppi, sep = ",")))
# remove old columns 
columns_to_remove <- c("cellcycle_ppi", "dna_damage_ppi")

cortex_banfi <- cortex_banfi[, -which(names(cortex_banfi) %in% columns_to_remove)]

kidney_banfi <- kidney_banfi[, -which(names(kidney_banfi) %in% columns_to_remove)]

# save
# write.csv(cortex_banfi, here("results/ppi_rewiring/all_mxn_cortex_banfi.csv")) 
# write.csv(kidney_banfi, here("results/ppi_rewiring/all_mxn_kidney_banfi.csv")) 
```

```{r splitting-by-condition}
kidney_banfi_het <- kidney_banfi[apply(kidney_banfi, 1, function(row) any(grepl("heterozygous", row))),]
kidney_banfi_ctrl <- kidney_banfi[apply(kidney_banfi, 1, function(row) any(grepl("control", row))),]
cortex_banfi_het <- cortex_banfi[apply(cortex_banfi, 1, function(row) any(grepl("heterozygous", row))),]
cortex_banfi_ctrl <- cortex_banfi[apply(cortex_banfi, 1, function(row) any(grepl("control", row))),]
```

```{r keeping-both-conditions}
# Cortex
# Create a new column named 'condition'
cortex_banfi$condition <- ""

# Create a new column named 'condition' and use ifelse to populate it based on cell_type
cortex_banfi$condition <- ifelse(grepl("_heterozygouscortex", cortex_banfi$source), "S858R", "WT")


# Remove "_controlcortex" or "_heterozygouscortex" from the 'cell_type' column
cortex_banfi$cell_type <- gsub("_heterozygouscortex", "", cortex_banfi$source)
cortex_banfi$cell_type <- gsub("_controlcortex", "", cortex_banfi$cell_type)

# Kidney
# Create a new column named 'condition'
kidney_banfi$condition <- ""

# Create a new column named 'condition' and use ifelse to populate it based on cell_type
kidney_banfi$condition <- ifelse(grepl("_heterozygouskidney", kidney_banfi$source), "S858R", "WT")


# Remove "_controlcortex" or "_heterozygouscortex" from the 'cell_type' column
kidney_banfi$cell_type <- gsub("_heterozygouskidney", "", kidney_banfi$source)
kidney_banfi$cell_type <- gsub("_controlkidney", "", kidney_banfi$cell_type)
```


## plot colored by annotation and grouped by mechanism
### both
```{r visualizing-mechanisms-sign-change-for-geneset-both-cortex}
# curious...going to subset for Setbp1 gene set in gene_ppi column
cortex <- cortex_banfi[cortex_banfi$gene_ppi %in% setbp1_genes,]

#removing Setbp1 because it is not a target of Setbp1 
cortex <- cortex[cortex$gene_ppi != "Setbp1",]

write.csv(cortex, file = here("results/ppi_rewiring/cortex_mechanisms.csv"))

## grab just values from cell_type, annotation, gene_ppi, and mechanism, keep rownames and then order (below) by rowname
cortex <- cortex[, c("annotation", "cell_type", "gene_ppi", "mechanism", "condition"), drop = FALSE]
  
cortex_pivot <- pivot_wider(cortex, names_from = c("cell_type", "condition"), values_from = "annotation", names_repair = "minimal")
cortex_pivot[is.na(cortex_pivot)] <- 0

rownames <- cortex_pivot$gene_ppi # add gene names as rownames
cortex_pivot <- cortex_pivot[, -1, drop = FALSE] # drop gene column

cortex_pivot <- cortex_pivot[, -1, drop = FALSE]
rownames(cortex_pivot) <- rownames


# grab meta data for plot:
meta <- as.data.frame(colnames(cortex_pivot))
meta <- t(as.data.frame(strsplit(sub("(_)(?=[^_]+$)", " ", meta$`colnames(cortex_pivot)`, perl = TRUE), " ")))
rownames(meta) <- colnames(cortex_pivot)
colnames(meta) <- c("cell_type", "condition")


# define order of annotations and colors:
annotation_colors <- list("cell_type" = c("excitatory_neurons" = "#DC71FA",
                                          "inhibitory_neurons" = "#00BBDB",
                                          "oligodendrocytes" = "#7997FF",
                                          "astrocytes" = "#6968B4",
                                          "microglia" = "#C216B7",
                                          "opcs" = "#00C1AA",
                                          "pericytes" = "#027461",
                                          "fibro_cortex" = "#0a2f6f"),
                          "condition" = c("WT" = "#644DD4", "S858R" = "#5F9EFD")) 

# set heatmap annotations:
heat.anno <- HeatmapAnnotation(df = meta, show_annotation_name = TRUE, col = annotation_colors)

# convert dataframe to matrix
mat <- as.matrix(cortex_pivot)

# plot heatmap
# Heatmap

plot <- Heatmap(mat,
  col = c("both_negative" = "red", "both_positive" = "#628D56", "neg_pos" = "#E9C61D", "pos_neg" = "#E7872B"),
  heatmap_legend_param = list(title = "regNet to CoopNet score change"),
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  column_order = NULL,
  show_row_dend = TRUE,
  show_column_dend = FALSE,
  row_names_gp = gpar(fontface = "bold", fontfamily = "Helvetica"),
  show_row_names = TRUE,
  show_column_names = FALSE,
  use_raster = TRUE,
  raster_device = c("png"),
  bottom_annotation = NULL,
  row_title_gp = gpar(fontface = "bold"),
  top_annotation = heat.anno,
)

png(here("results/ppi_rewiring/cortex_all_sign_change_heatmap.png"),
  res = 250,
  height = 1000,
  width = 2000
)
plot
dev.off()
```

```{r visualizing-mechanisms-sign-change-for-geneset-het-kidney}
# curious...going to subset for Setbp1 gene set in gene_ppi column
kidney <- kidney_banfi[kidney_banfi$gene_ppi %in% setbp1_genes,]

#removing Setbp1 because it is not a target of Setbp1 
kidney <- kidney[kidney$gene_ppi != "Setbp1",]

write.csv(kidney, file = here("results/ppi_rewiring/kidney_mechanisms.csv"))

## grab just values from cell_type, annotation, gene_ppi, and mechanism, keep rownames and then order (below) by rowname
kidney <- kidney[, c("annotation", "cell_type", "gene_ppi", "mechanism", "condition"), drop = FALSE]
  
kidney_pivot <- pivot_wider(kidney, names_from = c("cell_type", "condition"), values_from = "annotation", names_repair = "minimal")
kidney_pivot[is.na(kidney_pivot)] <- 0

rownames <- kidney_pivot$gene_ppi # add gene names as rownames
kidney_pivot <- kidney_pivot[, -1, drop = FALSE] # drop gene column

kidney_pivot <- kidney_pivot[, -1, drop = FALSE]
rownames(kidney_pivot) <- rownames


# grab meta data for plot:
meta <- as.data.frame(colnames(kidney_pivot))
meta <- t(as.data.frame(strsplit(sub("(_)(?=[^_]+$)", " ", meta$`colnames(kidney_pivot)`, perl = TRUE), " ")))
rownames(meta) <- colnames(kidney_pivot)
colnames(meta) <- c("cell_type", "condition")


# define order of annotations and colors:
annotation_colors <- list( "condition" = c(
    "WT" = "#FE6100",
    "S858R" = "#FFB000"
  ),
  "cell_type" = c(
    "Bcell" = "#FFBE1D",
    "CDIC_typeA" = "#4E3801",
    "CDIC_typeB" = "#EEDF37",
    "CDPC" = "#F03F00",
    "DCT" = "#6D0404",
    "DLH" = "#AA6320",
    "endothelial" = "#CF9400",
    "fibroblasts" = "#FFC8C4",
    "LOH" = "#AA937E",
    "macrophages" = "#C70F0F",
    "PCTS1" = "#A85A5A",
    "podocytes" = "#BD085E",
    "PST" = "#948802",
    "pericytes" = "#FFE196",
    "PCTS2" = "#FF7600",
    "PT" = "#F8766D",
    "smcs" = "#FFE196"
  )) 

# set heatmap annotations:
heat.anno <- HeatmapAnnotation(df = meta, show_annotation_name = TRUE, col = annotation_colors)

# convert dataframe to matrix
mat <- as.matrix(kidney_pivot)

# plot heatmap
# Heatmap

plot <- Heatmap(mat,
  col = c("both_negative" = "red", "both_positive" = "#628D56", "neg_pos" = "#E9C61D", "pos_neg" = "#E7872B"),
  heatmap_legend_param = list(title = "regNet to CoopNet score change"),
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  column_order = NULL,
  show_row_dend = TRUE,
  show_column_dend = FALSE,
  row_names_gp = gpar(fontface = "bold", fontfamily = "Helvetica"),
  show_row_names = TRUE,
  show_column_names = FALSE,
  use_raster = TRUE,
  raster_device = c("png"),
  bottom_annotation = NULL,
  row_title_gp = gpar(fontface = "bold"),
  top_annotation = heat.anno,
)

png(here("results/ppi_rewiring/kidney_all_sign_change_heatmap.png"),
  res = 250,
  height = 1000,
  width = 2000
)
plot
dev.off()
```

## plot based off of magnitude of regNet and coopNet score
```{r filtering-gene-ppi-for-geneset}
cortex_banfi_het <- cortex_banfi_het[cortex_banfi_het$gene_ppi %in% setbp1_genes,]
kidney_banfi_het <- kidney_banfi_het[kidney_banfi_het$gene_ppi %in% setbp1_genes,]

cortex_banfi_ctrl <- cortex_banfi_ctrl[cortex_banfi_ctrl$gene_ppi %in% setbp1_genes,]
kidney_banfi_ctrl <- kidney_banfi_ctrl[kidney_banfi_ctrl$gene_ppi %in% setbp1_genes,]
```

```{r visualizing-all-scores-banfi}
# plot the scores for regNet and coop Net
cortex_banfi_het$cell_type <- sub("_heterozygouscortex", "", cortex_banfi_het$source)

png(here("results/ppi_rewiring/cortex_het_score_quant_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

ggplot(cortex_banfi_het, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-125, -100, 0, 100, 252)),
                       name = "coopNet Score",
                       breaks = c(-200, -100, 0, 100, 200)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(angle = 45, color = "black", hjust = 1)) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold"))

dev.off()

# plot the scores for regNet and coop Net
kidney_banfi_het$cell_type <- sub("_heterozygouskidney", "", kidney_banfi_het$source)

png(here("results/ppi_rewiring/kidney_het_score_quant_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

ggplot(kidney_banfi_het, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-90, -50, 0, 50, 103)),
                       name = "coopNet Score",
                       breaks = c(-100, -50, 0, 50, 100)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(angle = 45, color = "black", hjust = 1)) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold"))

dev.off()
```

```{r visualizing-by-mechanism-scores-banfi-cortex-het}
# plot the scores for regNet and coop Net
cortex_banfi_het$cell_type <- sub("_heterozygouscortex", "", cortex_banfi_het$source) #renaming cell type
cortex_banfi_het <- cortex_banfi_het[cortex_banfi_het$gene_ppi != "Setbp1",] #removing setbp1 as gene/protein because it does not self-bind

## subsetting for each mechanism
cortex_banfi_apex1 <- cortex_banfi_het[cortex_banfi_het$mechanism == "DNA damage",]
cortex_banfi_trp53 <- cortex_banfi_het[cortex_banfi_het$mechanism == "cell cycle",]

png(here("results/ppi_rewiring/cortex_het_dna_damage_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

cor_dna <- ggplot(cortex_banfi_apex1, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-125, -100, 0, 100, 252)),
                       name = "coopNet Score",
                       breaks = c(-200, -100, 0, 100, 200)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(angle = 45, color = "black", hjust = 1)) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold"))

cor_dna

dev.off()

png(here("results/ppi_rewiring/cortex_het_cellcycle_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

cor_cell <- ggplot(cortex_banfi_trp53, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("purple", "white", "yellow"),
                       values = rescale(c(-100, 0, 150)),
                       name = "coopNet Score",
                       breaks = c(-100, 0, 150)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "none") +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold"))

cor_cell

dev.off()
```

```{r visualizing-by-mechanism-scores-banfi-kidney-het}

# plot the scores for regNet and coop Net
kidney_banfi_het$cell_type <- sub("_heterozygouskidney", "", kidney_banfi_het$source) # renaming cell type 
kidney_banfi_het <- kidney_banfi_het[kidney_banfi_het$gene_ppi != "Setbp1",] #removing setbp1 as gene/protein because it does not self-bind

## subsetting by mechanism
kidney_banfi_apex1 <- kidney_banfi_het[kidney_banfi_het$mechanism == "DNA damage",]
kidney_banfi_trp53 <- kidney_banfi_het[kidney_banfi_het$mechanism == "cell cycle",]

png(here("results/ppi_rewiring/kidney_het_dna_damage_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

kid_dna <- ggplot(kidney_banfi_apex1, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-90, -50, 0, 50, 103)),
                       name = "coopNet Score",
                       breaks = c(-100, -50, 0, 50, 100)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(angle = 45, color = "black", hjust = 1)) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold"))

kid_dna

dev.off()

png(here("results/ppi_rewiring/kidney_het_cellcycle_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

kid_cell <- ggplot(kidney_banfi_trp53, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-90, -50, 0, 50, 103)),
                       name = "coopNet Score",
                       breaks = c(-100, -50, 0, 50, 100)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "none",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_text(color = "black", face = "bold"))
  # theme(axis.title.y = element_text(color = "black", face = "bold")) +
  # theme(axis.title.x = element_blank()) +
  # theme(axis.text = element_text(face = "bold"))
  # theme(legend.title = element_text(face = "bold")) +
  # theme(legend.text = element_text(face = "bold"))

kid_cell

dev.off()
```

```{r visualizing-by-mechanism-scores-banfi-cortex-ctrl}
# plot the scores for regNet and coop Net
cortex_banfi_ctrl$cell_type <- sub("_controlcortex", "", cortex_banfi_ctrl$source) #renaming cell type
cortex_banfi_ctrl <- cortex_banfi_ctrl[cortex_banfi_ctrl$gene_ppi != "Setbp1",] #removing setbp1 as gene/protein because it does not self-bind

## subsetting for each mechanism
cortex_banfi_apex1 <- cortex_banfi_ctrl[cortex_banfi_ctrl$mechanism == "DNA damage",]
cortex_banfi_trp53 <- cortex_banfi_ctrl[cortex_banfi_ctrl$mechanism == "cell cycle",]

png(here("results/ppi_rewiring/cortex_ctrl_dna_damage_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

cor_dna_ctrl <- ggplot(cortex_banfi_apex1, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-125, -100, 0, 100, 252)),
                       name = "coopNet Score",
                       breaks = c(-200, -100, 0, 100, 200)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(angle = 45, color = "black", hjust = 1)) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold"))

cor_dna_ctrl

dev.off()

png(here("results/ppi_rewiring/cortex_ctrl_cellcycle_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

cor_cell_ctrl <- ggplot(cortex_banfi_trp53, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("purple", "white", "yellow"),
                       values = rescale(c(-100, 0, 150)),
                       name = "coopNet Score",
                       breaks = c(-100, 0, 150)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "none") +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold"))

cor_cell_ctrl

dev.off()
```

```{r visualizing-by-mechanism-scores-banfi-kidney-ctrl}

# plot the scores for regNet and coop Net
kidney_banfi_ctrl$cell_type <- sub("_controlkidney", "", kidney_banfi_ctrl$source) # renaming cell type 
kidney_banfi_ctrl <- kidney_banfi_ctrl[kidney_banfi_ctrl$gene_ppi != "Setbp1",] #removing setbp1 as gene/protein because it does not self-bind

## subsetting by mechanism
kidney_banfi_apex1 <- kidney_banfi_ctrl[kidney_banfi_ctrl$mechanism == "DNA damage",]
kidney_banfi_trp53 <- kidney_banfi_ctrl[kidney_banfi_ctrl$mechanism == "cell cycle",]

png(here("results/ppi_rewiring/kidney_ctrl_dna_damage_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

kid_dna_ctrl <- ggplot(kidney_banfi_apex1, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-90, -50, 0, 50, 103)),
                       name = "coopNet Score",
                       breaks = c(-100, -50, 0, 50, 100)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(angle = 45, color = "black", hjust = 1)) +
  theme(axis.text.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.y = element_text(color = "black", face = "bold")) +
  theme(axis.title.x = element_blank()) + 
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold"))

kid_dna_ctrl

dev.off()

png(here("results/ppi_rewiring/kidney_ctrl_cellcycle_dotplot.png"),
  res = 250,
  height = 2000,
  width = 2000)

kid_cell_ctrl <- ggplot(kidney_banfi_trp53, aes(x = cell_type, y = gene_ppi,
                             fill = coopNet_score)) +
  geom_point(aes(size = abs(regNet_score),
                 shape = ifelse(regNet_score >= 0, "Positive", "Negative")),
             color = "black") +
  scale_shape_manual(values = c(Positive = 24, Negative = 25),
                     name = "regNet Score (Shape)") +
  scale_fill_gradientn(colors = c("darkblue", "purple", "white", "yellow", "orange"),
                       values = rescale(c(-90, -50, 0, 50, 103)),
                       name = "coopNet Score",
                       breaks = c(-100, -50, 0, 50, 100)) +
  labs(x = "Cell Type", y = "Protein/Gene") +
  guides(size = guide_legend(override.aes = list(shape = 24),
                             title = "regNet Score (Magnitude)")) +
  guides(shape = guide_legend(override.aes = list(fill = NA),
                              title = "regNet Score (Direction)")) +
  theme_bw() +
  theme(legend.position = "none",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.spacing = unit(0.5, "cm")) +
  theme_bw() +
  theme_minimal() +  
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_text(color = "black", face = "bold"))
  # theme(axis.title.y = element_text(color = "black", face = "bold")) +
  # theme(axis.title.x = element_blank()) +
  # theme(axis.text = element_text(face = "bold"))
  # theme(legend.title = element_text(face = "bold")) +
  # theme(legend.text = element_text(face = "bold"))

kid_cell_ctrl

dev.off()
```

### Arranging all plots together now by tissue for each mechanism
```{r stacking-cortex}
#HET
# Arrange the plots and share a legend
plot_combined <- plot_grid(cor_cell, cor_dna, align = "v", ncol = 1, rel_heights = c(1, 3))

legend_combined <- get_legend(cor_dna)  # Extract the legend from plot1

# Add the legend to the combined plot
plot_combined_with_legend <- plot_grid(plot_combined, legend_combined, ncol = 2, rel_widths = c(4, 1))

png(here("results/ppi_rewiring/cortex_het_grouped_dotplot.png"),
  res = 250,
  height = 2000,
  width = 3000)
plot_combined_with_legend
dev.off()

#CONTROL
# Arrange the plots and share a legend
plot_combined <- plot_grid(cor_cell_ctrl, cor_dna_ctrl, align = "v", ncol = 1, rel_heights = c(1, 3))

legend_combined <- get_legend(cor_dna_ctrl)  # Extract the legend from plot1

# Add the legend to the combined plot
plot_combined_with_legend <- plot_grid(plot_combined, legend_combined, ncol = 2, rel_widths = c(4, 1))

png(here("results/ppi_rewiring/cortex_ctrl_grouped_dotplot.png"),
  res = 250,
  height = 2000,
  width = 3000)
plot_combined_with_legend
dev.off()
```

```{r stacking-kidney}
#HET
# Arrange the plots and share a legend
plot_combined <- plot_grid(kid_cell, kid_dna, align = "v", ncol = 1)

legend_combined <- get_legend(kid_dna)  # Extract the legend from plot1

# Add the legend to the combined plot
plot_combined_with_legend <- plot_grid(plot_combined, legend_combined, ncol = 2, rel_widths = c(4, 1))

png(here("results/ppi_rewiring/kidney_het_grouped_dotplot.png"),
  res = 250,
  height = 2000,
  width = 3000)
plot_combined_with_legend
dev.off()

#CONTROL
# Arrange the plots and share a legend
plot_combined <- plot_grid(kid_cell_ctrl, kid_dna_ctrl, align = "v", ncol = 1)

legend_combined <- get_legend(kid_dna_ctrl)  # Extract the legend from plot1

# Add the legend to the combined plot
plot_combined_with_legend <- plot_grid(plot_combined, legend_combined, ncol = 2, rel_widths = c(4, 1))

png(here("results/ppi_rewiring/kidney_ctrl_grouped_dotplot.png"),
  res = 250,
  height = 2000,
  width = 3000)
plot_combined_with_legend
dev.off()
```

## looking at STRING prior scores for coopNet regNet edges returned in subset above 
Investigation of initial STRING prior scores allows us to make inferences about whether the proteins may be binding. From the cooperativity network (coopNet) output that we get using PANDA, we can only infer interaction, and cannot draw any conclusions about actual protein-protein binding.  
```{r load-ppi}
mm10_ppi <- read.table(here("data/processed/ppi_inputs/mm10_ppi.txt"))
```

In order to confirm if the proteins that are "both positive" above, we wanted to see what the initial interactions were in string
```{r subset-ppi-for-het-interactions}
moi <- c("Apex1", "Tp53", "Trp53") # proteins for mechanisms of interest (and their aliases)
poi <- c("Hmga1", "Parp1", "E4f1", "Mef2c", "Mzf1", "Pbrm1", "Med1") #proteins of interest

#subsetting for interactions where Apex1/Tp53/Trp53 interact with moi or vice versa
from_to <- mm10_ppi[mm10_ppi$from %in% poi,] %>% .[.$to %in% moi,]
to_from <- mm10_ppi[mm10_ppi$to %in% poi,]  %>% .[.$from %in% moi,]

prior_evidence <- rbind(from_to, to_from)

write.csv(prior_evidence, file = here("results/ppi_rewiring/prior_evidence.csv"), row.names = FALSE)
prior_evidence
```

## looking at initial prior
In order to understand the context of altered regulation/cooperation, we investigated the S858R regNet associated with the genes regulated by Setbp1 (TF) that are also proteins in the coopNet interacting with a protein (Apex1 or Trp53) associated with a hypothesized mechanism of SGS. Specifically for those proteins that are cooperating with Apex1 or Trp53 that do not have a STRING score associated with them, or a high confidence STRING score, we wanted to see what nodes they were potentially cooperating together to interact with or regulate. 

```{r}
files <- list.files(here("results/PANDA"), full.names = TRUE)
files

# run for loop
regNet_list <- list()

for (i in files) {
  # load in the expression data files needed and rename:
  PANDA <- loadRData(i)
  # extract regNet and melt into `source`, `target` and `mor`, required format for decoupleR.
  # These equate to `TF`, `gene` and `score` respectively.
  regNet <- PANDA@regNet
  regNet <- melt(regNet)
  colnames(regNet) <- c("TF", "gene", "score")
  # #save melted output
  name <- sub("_PANDA.Rdata", "", basename(i))
  regNet_list[[name]] <- regNet
  rm(PANDA)
  rm(regNet)
  print(paste0(name, " network melted and stored in list."))
}

# Apply the function to each dataframe in the list
test <- lapply(regNet_list, function(df) df[df$score > 0,])
```

```{r filter-regNet}
# Filter the list of dataframes against mechanism proteins and gene/protein of interest
apex1_list <- lapply(test, function(df) {
  subset(df, TF == "Apex1" | gene == "Apex1")
})

trp53_list <- lapply(test, function(df) {
  subset(df, TF == "Trp53" | gene == "Trp53")
})

pbrm1_list <- lapply(test, function(df) {
  subset(df, TF == "Pbrm1" | gene == "Pbrm1")
})

mzf1_list <- lapply(test, function(df) {
  subset(df, TF == "Mzf1" | gene == "Mzf1")
})

e4f1_list <- lapply(test, function(df) {
  subset(df, TF == "E4f1" | gene == "E4f1")
})

parp1_list <- lapply(test, function(df) {
  subset(df, TF == "Parp1" | gene == "Parp1")
})

mef2c_list <- lapply(test, function(df) {
  subset(df, TF == "Mef2c" | gene == "Mef2c")
})
```

```{r find-overlap}
# find the overlapping nodes between the two for each of the following pairs: 

# Apply the function to each data frame in the list
apex1_coop_list <- lapply(apex1_list, extract_cooperator, target_value = "Apex1")
trp53_coop_list <- lapply(trp53_list, extract_cooperator, target_value = "Trp53")
mef2c_coop_list <- lapply(mef2c_list, extract_cooperator, target_value = "Mef2c")
parp1_coop_list <- lapply(parp1_list, extract_cooperator, target_value = "Parp1")
e4f1_coop_list <- lapply(e4f1_list, extract_cooperator, target_value = "E4f1")
mzf1_coop_list <- lapply(mzf1_list, extract_cooperator, target_value = "Mzf1")
pbrm1_coop_list <- lapply(pbrm1_list, extract_cooperator, target_value = "Pbrm1")

## Mef2c-Apex1 
# Create an empty list to store the results
mef2c_apex1_list <- list()

# Iterate over the names of the data frames in list1
for (name in names(mef2c_coop_list)) {
  # Get the corresponding data frames from list1 and list2
  df1 <- mef2c_coop_list[[name]]
  df2 <- apex1_coop_list[[name]]
  
  # Check if "cooperator" column exists in both data frames
  if ("cooperator" %in% names(df1) && "cooperator" %in% names(df2)) {
    # Find the overlap in the "cooperator" column
    overlap <- intersect(df1$cooperator, df2$cooperator)
    
    # Create a new data frame with the overlap stored in the "overlap" column
    result_df <- data.frame(overlap = overlap, stringsAsFactors = FALSE)
    
    # Store the result data frame in the result list with the same name
    mef2c_apex1_list[[name]] <- result_df
  }
}

## Parp1-Apex1
parp1_apex1_list <- list()

for (name in names(parp1_coop_list)) {
  df1 <- parp1_coop_list[[name]]
  df2 <- apex1_coop_list[[name]]

  if ("cooperator" %in% names(df1) && "cooperator" %in% names(df2)) {
    overlap <- intersect(df1$cooperator, df2$cooperator)
    
    result_df <- data.frame(overlap = overlap, stringsAsFactors = FALSE)
    
    parp1_apex1_list[[name]] <- result_df
  }
}

## E4f1-Apex1
e4f1_apex1_list <- list()

for (name in names(e4f1_coop_list)) {
  df1 <- e4f1_coop_list[[name]]
  df2 <- apex1_coop_list[[name]]

  if ("cooperator" %in% names(df1) && "cooperator" %in% names(df2)) {
    overlap <- intersect(df1$cooperator, df2$cooperator)
    
    result_df <- data.frame(overlap = overlap, stringsAsFactors = FALSE)
    
    e4f1_apex1_list[[name]] <- result_df
  }
}

## Mzf1-Trp53
mzf1_trp53_list <- list()

for (name in names(mzf1_coop_list)) {
  df1 <- mzf1_coop_list[[name]]
  df2 <- trp53_coop_list[[name]]

  if ("cooperator" %in% names(df1) && "cooperator" %in% names(df2)) {
    overlap <- intersect(df1$cooperator, df2$cooperator)
    
    result_df <- data.frame(overlap = overlap, stringsAsFactors = FALSE)
    
    mzf1_trp53_list[[name]] <- result_df
  }
}

## Pbrm1-Tp53
pbrm1_trp53_list <- list()

for (name in names(pbrm1_coop_list)) {
  df1 <- pbrm1_coop_list[[name]]
  df2 <- trp53_coop_list[[name]]

  if ("cooperator" %in% names(df1) && "cooperator" %in% names(df2)) {
    overlap <- intersect(df1$cooperator, df2$cooperator)
    
    result_df <- data.frame(overlap = overlap, stringsAsFactors = FALSE)
    
    pbrm1_trp53_list[[name]] <- result_df
  }
}
```

```{r save-overlap-lists}
save(pbrm1_trp53_list, file = here("results/ppi_rewiring/pbrm1_trp53_list.Rdata"))
save(mzf1_trp53_list, file = here("results/ppi_rewiring/mzf1_trp53_list.Rdata"))
save(e4f1_apex1_list, file = here("results/ppi_rewiring/e4f1_apex1_list.Rdata"))
save(parp1_apex1_list, file = here("results/ppi_rewiring/parp1_apex1_list.Rdata"))
save(mef2c_apex1_list, file = here("results/ppi_rewiring/mef2c_apex1_list.Rdata"))
```


```{r subset-het-overlaps-celltypes-interest}
pbrm1_trp53_kid <- pbrm1_trp53_list[grep("_heterozygouskidney", names(pbrm1_trp53_list))]
mzf1_trp53_kid <- mzf1_trp53_list[grep("_heterozygouskidney", names(mzf1_trp53_list))]
e4f1_apex1_kid <- e4f1_apex1_list[grep("_heterozygouskidney", names(e4f1_apex1_list))]
parp1_apex1_kid <- parp1_apex1_list[grep("_heterozygouskidney", names(parp1_apex1_list))]
mef2c_apex1_kid <- mef2c_apex1_list[grep("_heterozygouskidney", names(mef2c_apex1_list))]

pbrm1_trp53_cor <- pbrm1_trp53_list[grep("_heterozygouscortex", names(pbrm1_trp53_list))]
mzf1_trp53_cor <- mzf1_trp53_list[grep("_heterozygouscortex", names(mzf1_trp53_list))]
e4f1_apex1_cor <- e4f1_apex1_list[grep("_heterozygouscortex", names(e4f1_apex1_list))]
parp1_apex1_cor <- parp1_apex1_list[grep("_heterozygouscortex", names(parp1_apex1_list))]
mef2c_apex1_cor <- mef2c_apex1_list[grep("_heterozygouscortex", names(mef2c_apex1_list))]
```

```{r find-cts-nodes-overlapping-between-pairs}
# annotate cell type on list of lists
list_o_list <- list(pbrm1_trp53_cor, mzf1_trp53_kid, e4f1_apex1_kid, parp1_apex1_kid, mef2c_apex1_kid, mef2c_apex1_cor, parp1_apex1_cor, e4f1_apex1_cor, mzf1_trp53_cor, pbrm1_trp53_kid)

names(list_o_list) <- c("pbrm1_trp53_cor", "mzf1_trp53_kid", "e4f1_apex1_kid", "parp1_apex1_kid", "mef2c_apex1_kid", "mef2c_apex1_cor", "parp1_apex1_cor", "e4f1_apex1_cor", "mzf1_trp53_cor", "pbrm1_trp53_kid")

# Iterate over each list in the list of lists
for (i in seq_along(list_o_list)) {
  # Get the current list
  current_list <- list_o_list[[i]]
  
  # Iterate over each dataframe in the current list
  for (j in seq_along(current_list)) {
    # Get the dataframe name
    df_name <- names(current_list)[j]
    
    # Perform substitution and extract source based on dataframe name
    if (grepl("_heterozygouskidneyexpression", df_name)) {
      source <- sub("_heterozygouskidneyexpression", "", df_name)
    } else if (grepl("_heterozygouscortexexpression", df_name)) {
      source <- sub("_heterozygouscortexexpression", "", df_name)
    } else {
      source <- df_name
    }
    
    # Add source column to the dataframe
    current_list[[j]]$source <- source
  }
  
  # Update the modified list in the list of lists
  list_o_list[[i]] <- current_list
}


# bind together all cell types for each pairing:
# Iterate over each list in the list of lists
for (list_name in names(list_o_list)) {
  # Get the current list
  current_list <- list_o_list[[list_name]]
  
  # Combine all dataframes within the current list
  combined_df <- do.call(rbind, current_list)
  
  # Replace the original list with the combined dataframe
  list_o_list[[list_name]] <- combined_df
}

# subset for cell type specific genes
nondup_list <- lapply(list_o_list, function(df) {
  gene_counts <- table(df$overlap)
  single_celltype_genes <- names(gene_counts[gene_counts == 1])
  filtered_df <- df[df$overlap %in% single_celltype_genes, ]
  return(filtered_df)
})
```
The nondup_list contains a dataframe for each pairing of cell-type specific nodes that shared a positive edge in the regNet with each of the genes in the name of the slot in the list. 

```{r filtering-cts-for-setbp1-geneset}
# Create a new list to store the filtered dataframes with the same names
filtered_nondup_list <- setNames(vector("list", length(nondup_list)), names(nondup_list))

# Subset the 'nondup_list' for desired gene names in the 'overlap' column and store in the new list
for (i in seq_along(nondup_list)) {
  filtered_df <- nondup_list[[i]][nondup_list[[i]]$overlap %in% setbp1_genes, ]
  filtered_nondup_list[[i]] <- filtered_df
}

filtered_nondup_list <- lapply(names(filtered_nondup_list), function(name) {
  df <- filtered_nondup_list[[name]]
  df$pairing <- name
  return(df)
})

combined_df <- do.call(rbind, filtered_nondup_list)
rownames(combined_df) <- NULL
```

The filtered nondup_list contains a dataframe for each pairing of interest, where the cell-specific nodes were filtered against the setbp1 gene set. 
```{r}
write.csv(combined_df, file = here("results/ppi_rewiring/cts_setbp1_geneset_overlap_by_mech.csv"), row.names = FALSE)
save(filtered_nondup_list, file = here("results/ppi_rewiring/cts_setbp1_geneset_overlap_by_mech.Rdata"))
```

```{r}
fptm <- proc.time() - ptm
fptm[3] / 60
```


```{r}
sessionInfo()
```

