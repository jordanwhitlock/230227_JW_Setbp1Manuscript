---
title: "Setbp1_Clustering_04"
author: "Jordan Whitlock"
date: '2022-09-07'
output:     
  html_document:
      toc: true
      toc_depth: 2
      toc_float: true
---

This analysis comes after 'Setbp1_Integration_03.Rmd' and precedes 'Setbp1_MarkersCortex_05.Rmd' & 'Setbp1_MarkersKidney_05.Rmd'. Leiden clustering was run on supercomputer using 'Setbp1_Clustering_leiden_06.R' and 'Setbp1_Clustering_leiden_06' bash script

# *Single-nuclei analysis: Clustering*
* Finding Neighbors
* Clustering with Leiden algorithm
* Idnetify stable resolution with clustree
* Re-visualize bimodality
* Set identity as new resolution

## Code: 

Accompanying dry lab notebook for this analysis is here: https://docs.google.com/document/d/1FO_Je9oxbBFF9S_k-8tVF2t4ba88O4C77sw1v7DIFec/edit?usp=sharing

### Setting up libraries and working path:

```{r}
getwd()
.libPaths() # "/usr/local/lib/R/site-library" "/usr/local/lib/R/library" "/home/jbarham3/R/x86_64-pc-linux-gnu-library/4.1"
```

```{r, message=FALSE}
# loading in all required libraries
library(devtools)
library(magrittr)
library(readr)
library(dplyr)
library(Seurat)
library(cowplot)
library(ggplot2)
library(tidyverse)
library(harmony)
library(clustree)
library(here)
library(styler)
library(lintr)
```

### Clustering on the Harmony integrated data

#### load in the objects
```{r}
load(here("data/integrated_setbp1_kidney.Rdata"))
load(here("data/integrated_setbp1_cerebral.Rdata"))
```


#### check the active assay
It should be RNA, but need to make check the reduction used for everything downstream is set to "harmony"
```{r}
kidney_int@active.assay # RNA
cerebral_int@active.assay # RNA
```

#### Find Neighbors and Clusters

NOTE: Use LEIDEN (algorithm = 4) NOT LOUVAIN (algorithm = 1)

#find neighbors
```{r}
kidney_int <- FindNeighbors(kidney_int, dims = 1:30, reduction = "harmony")
cerebral_int <- FindNeighbors(cerebral_int, dims = 1:30, reduction = "harmony")
```

### find clusters WITH LEIDEN (algorithm = 4)
received error (described here: https://docs.google.com/document/d/1FO_Je9oxbBFF9S_k-8tVF2t4ba88O4C77sw1v7DIFec/edit?usp=sharing), need to change matrix type.

If compute power is an issue, this can be run in a job on the Cheaha supercomputer in accompanying script 'Setbp1_Clustering_leiden_04.R' and 'Setbp1_Clustering_leiden_04' bash script
```{r}
# when running the below code within the Docker HPC environment and prompted about a miniconda install respond No
for (res in c(0.5, 0.6, 0.7, 0.8, 0.9, 1)) {
  kidney_int <- FindClusters(kidney_int, graph.name = "RNA_snn", resolution = res, algorithm = 4, method = "igraph")
}

jpeg(file = here("results/seurat/kidneyint_clustree.jpeg"))
clustree(kidney_int@meta.data, prefix = "RNA_snn_res.")
dev.off()

save(kidney_int, file = here("data/kidney_leiden.Rdata"))


for (res in c(0.7, 0.8, 0.9, 1, 1.5)) {
  cerebral_int <- FindClusters(cerebral_int, graph.name = "RNA_snn", resolution = res, algorithm = 4, method = "igraph")
}

jpeg(file = here("/results/kidneyint_clustree.jpeg"))
clustree(cerebral_int@meta.data, prefix = "RNA_snn_res.")
dev.off()


save(cerebral_int, file = here("/data/cerebral_leiden.Rdata"))
```


### load in post-leiden objects:
```{r}
load(here("data/cerebral_leiden.Rdata")) # cerebral_int
load(here("data/kidney_leiden.Rdata")) # kidney_int
```

```{r}
# harmony
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.0.1") +
  ggtitle("leiden_0.1")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.0.25") +
  ggtitle("leiden_0.25")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.0.5") +
  ggtitle("leiden_0.5")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.0.6") +
  ggtitle("leiden_0.6")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.0.7") +
  ggtitle("leiden_0.7")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.0.8") +
  ggtitle("leiden_0.8")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.0.9") +
  ggtitle("leiden_0.9")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.1") +
  ggtitle("leiden_1")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.1.5") +
  ggtitle("leiden_1.5")
DimPlot(kidney_int, reduction = "umap_harmony", group.by = "RNA_snn_res.2") +
  ggtitle("leiden_2")
```

#### rechecking bimodality from early QC to see if a particular cluster is driving it:
##### Visualize the number of UMIs/transcripts per cell:
nUMI = nCount_RNA
nGene = nFeature_RNA

500 is the minimum threshold for number of UMI counts per cell.
```{r}
## colored by cluster
kidney_int@meta.data %>%
  ggplot(aes(color = RNA_snn_res.0.9, x = nCount_RNA, fill = RNA_snn_res.0.9)) +
  geom_density(alpha = 0.2) +
  scale_x_log10() +
  theme_classic() +
  ylab("Cell density") +
  geom_vline(xintercept = 500) +
  ggtitle("Kidney @ res 0.0")
cerebral_int@meta.data %>%
  ggplot(aes(color = RNA_snn_res.0.9, x = nCount_RNA, fill = RNA_snn_res.0.8)) +
  geom_density(alpha = 0.2) +
  scale_x_log10() +
  theme_classic() +
  ylab("Cell density") +
  geom_vline(xintercept = 500) +
  ggtitle("Cerebral cortex @ res 0.9")
kidney_int@meta.data %>%
  ggplot(aes(color = RNA_snn_res.0.9, x = nFeature_RNA, fill = RNA_snn_res.0.9)) +
  geom_density(alpha = 0.2) +
  scale_x_log10() +
  theme_classic() +
  ylab("Cell density") +
  geom_vline(xintercept = 500) +
  ggtitle("Kidney @ res 0.9")
cerebral_int@meta.data %>%
  ggplot(aes(color = RNA_snn_res.0.9, x = nFeature_RNA, fill = RNA_snn_res.0.8)) +
  geom_density(alpha = 0.2) +
  scale_x_log10() +
  theme_classic() +
  ylab("Cell density") +
  geom_vline(xintercept = 500) +
  ggtitle("Cerebral cortex @ res 0.9")
```

#### set the identity as Leiden with resolution 0.9 for kidney and 0.9 for cerbral cortex:
```{r}
select_resolution <- "RNA_snn_res.0.9"
cerebral_int <- SetIdent(cerebral_int, value = select_resolution)

select_resolution <- "RNA_snn_res.0.9"
kidney_int <- SetIdent(kidney_int, value = select_resolution)
```

#### plot the clustering
```{r}
plot_grid(ncol = 3, DimPlot(kidney_int, label = TRUE, reduction = "umap_harmony") + NoAxes(), DimPlot(kidney_int, group.by = "orig.ident", reduction = "umap_harmony") +
  NoAxes(), DimPlot(kidney_int, group.by = "type", reduction = "umap_harmony") + NoAxes())
plot_grid(ncol = 3, DimPlot(cerebral_int, label = TRUE, reduction = "umap_harmony") + NoAxes(), DimPlot(cerebral_int, group.by = "orig.ident", reduction = "umap_harmony") +
  NoAxes(), DimPlot(cerebral_int, group.by = "type", reduction = "umap_harmony") + NoAxes())
```

```{r}
# run style
style_file(here("src/seurat_scripts/Setbp1_Clustering_04.Rmd"))
# lintr was run as well
```
