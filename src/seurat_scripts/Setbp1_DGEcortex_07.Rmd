---
title: "Setbp1_DGEcortex_07"
author: "Jordan Whitlock"
date: '2022-09-08'
output:     
  html_document:
      toc: true
      toc_depth: 2
      toc_float: true
---

This analysis comes after 'Setbp1_CellTypesCortex_06.Rmd' and precedes 'Setbp1_PathwayAnalysisCortexKidney_08.Rmd'

# *Single-nuclei analysis: DGE cortex*

## Code: 

Accompanying dry lab notebook for this analysis is here: https://docs.google.com/document/d/1FO_Je9oxbBFF9S_k-8tVF2t4ba88O4C77sw1v7DIFec/edit?usp=sharing

#### Loading in libraries:
```{r}
library(Seurat)
library(ggplot2)
library(tidyr)
library(dplyr)
library(ComplexHeatmap)
library(circlize)
library(here)
library(styler)
library(lintr)
source(here("src/functions/functions.R"))
set.seed(2178)
```

#### Load in object:
```{r}
load(here("data/setbp1_cerebralintcelltypes.Rdata"))
```

#### checking to see if Setbp1 is even in the seurat object:

It is present in the data, but appears very similar across conditions.
```{r}
# visualize with FeaturePlot
plot <- FeaturePlot(cerebral_int_celltypes, feature = "Setbp1", reduction = "umap_harmony", split.by = "type", label = TRUE)
plot
# Vln Plot of expression
VlnPlot(object = cerebral_int_celltypes, features = "Setbp1", split.by = "type", assay = "RNA")
```

#### split violin plotting of Setbp1 across cell types:
```{r}
# grabbing the Setbp1 expression data and moving from S4 to a dataframe
setbp1_exp <- FetchData(cerebral_int_celltypes, vars = c("Setbp1", "cell_type", "type"))
colnames(setbp1_exp) <- c("Expression", "cell_type", "type")

png(
  filename = here("results/figures/cortex_setbp1_expression.png"),
  width = 1500,
  height = 1000
)
ggplot(setbp1_exp, aes(cell_type, Expression, fill = type)) +
  geom_split_violin() +
  theme_bw() +
  scale_fill_manual(values = c("control" = "#644DD4", "heterozygous" = "#5F9EFD")) +
  ggtitle("Setbp1 Expression Across Cerebral Cortex")
dev.off()
```


#### Calculating DGE by cell type: log2FC of 0.1, and plotting etc

---excitatory neurons---
```{r}
# subset seurat object for each cell type
exneuro <- subset(x = cerebral_int_celltypes, idents = "excitatory.neurons")
Idents(exneuro) <- exneuro@meta.data$type
excitatory.neurons_data <- FindAllMarkers(exneuro, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(excitatory.neurons_data, n = 5)
```



```{r}
excitatory.neurons_het <- excitatory.neurons_data[excitatory.neurons_data$p_val < 0.5 & excitatory.neurons_data$avg_log2FC > 0.1 | excitatory.neurons_data$avg_log2FC < -0.1, ]
excitatory.neurons_het <- excitatory.neurons_het[excitatory.neurons_het$cluster == "heterozygous", ]

p <- ggplot(data = excitatory.neurons_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
excitatory.neurons_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
excitatory.neurons_het$diffexpressed[excitatory.neurons_het$avg_log2FC > 0.1 & excitatory.neurons_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
excitatory.neurons_het$diffexpressed[excitatory.neurons_het$avg_log2FC < -0.1 & excitatory.neurons_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = excitatory.neurons_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(excitatory.neurons_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
excitatory.neurons_het$delabel <- NA
excitatory.neurons_het$delabel[excitatory.neurons_het$diffexpressed != "NO"] <- excitatory.neurons_het$gene[excitatory.neurons_het$diffexpressed != "NO"]
ggplot(data = excitatory.neurons_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---inhibitory neurons ---

```{r}
# subset seurat object for each cell type
inneuro <- subset(x = cerebral_int_celltypes, idents = "inhibitory.neurons")
Idents(inneuro) <- inneuro@meta.data$type
inhibitory.neurons_data <- FindAllMarkers(inneuro, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(inhibitory.neurons_data, n = 5)
```

```{r}
inhibitory.neurons_het <- inhibitory.neurons_data[inhibitory.neurons_data$p_val < 0.5 & inhibitory.neurons_data$avg_log2FC > 0.1 | inhibitory.neurons_data$avg_log2FC < -0.1, ]
inhibitory.neurons_het <- inhibitory.neurons_het[inhibitory.neurons_het$cluster == "heterozygous", ]

p <- ggplot(data = inhibitory.neurons_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
inhibitory.neurons_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
inhibitory.neurons_het$diffexpressed[inhibitory.neurons_het$avg_log2FC > 0.1 & inhibitory.neurons_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
inhibitory.neurons_het$diffexpressed[inhibitory.neurons_het$avg_log2FC < -0.1 & inhibitory.neurons_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = inhibitory.neurons_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(inhibitory.neurons_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
inhibitory.neurons_het$delabel <- NA
inhibitory.neurons_het$delabel[inhibitory.neurons_het$diffexpressed != "NO"] <- inhibitory.neurons_het$gene[inhibitory.neurons_het$diffexpressed != "NO"]
ggplot(data = inhibitory.neurons_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---astrocytes---
```{r}
# subset seurat object for each cell type
astro <- subset(x = cerebral_int_celltypes, idents = "astrocytes")
Idents(astro) <- astro@meta.data$type
astrocytes_data <- FindAllMarkers(astro, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(astrocytes_data, n = 5)
```

```{r}
astrocytes_het <- astrocytes_data[astrocytes_data$p_val < 0.5 & astrocytes_data$avg_log2FC > 0.1 | astrocytes_data$avg_log2FC < -0.1, ]
astrocytes_het <- astrocytes_het[astrocytes_het$cluster == "heterozygous", ]

p <- ggplot(data = astrocytes_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
astrocytes_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
astrocytes_het$diffexpressed[astrocytes_het$avg_log2FC > 0.1 & astrocytes_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
astrocytes_het$diffexpressed[astrocytes_het$avg_log2FC < -0.1 & astrocytes_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = astrocytes_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(astrocytes_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
astrocytes_het$delabel <- NA
astrocytes_het$delabel[astrocytes_het$diffexpressed != "NO"] <- astrocytes_het$gene[astrocytes_het$diffexpressed != "NO"]
ggplot(data = astrocytes_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---microglia---
```{r}
# subset seurat object for each cell type
micro <- subset(x = cerebral_int_celltypes, idents = "microglia")
Idents(micro) <- micro@meta.data$type
microglia_data <- FindAllMarkers(micro, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(microglia_data, n = 5)
```

```{r}
microglia_het <- microglia_data[microglia_data$p_val < 0.5 & microglia_data$avg_log2FC > 0.1 | microglia_data$avg_log2FC < -0.1, ]
microglia_het <- microglia_het[microglia_het$cluster == "heterozygous", ]

p <- ggplot(data = microglia_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
microglia_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
microglia_het$diffexpressed[microglia_het$avg_log2FC > 0.1 & microglia_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
microglia_het$diffexpressed[microglia_het$avg_log2FC < -0.1 & microglia_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = microglia_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(microglia_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
microglia_het$delabel <- NA
microglia_het$delabel[microglia_het$diffexpressed != "NO"] <- microglia_het$gene[microglia_het$diffexpressed != "NO"]
ggplot(data = microglia_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



---mural---
```{r}
# subset seurat object for each cell type
mural <- subset(x = cerebral_int_celltypes, idents = "mural.cells")
Idents(mural) <- mural@meta.data$type
mural.cells_data <- FindAllMarkers(mural, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(mural.cells_data, n = 5)
```

```{r}
mural.cells_het <- mural.cells_data[mural.cells_data$p_val < 0.5 & mural.cells_data$avg_log2FC > 0.1 | mural.cells_data$avg_log2FC < -0.1, ]
mural.cells_het <- mural.cells_het[mural.cells_het$cluster == "heterozygous", ]

p <- ggplot(data = mural.cells_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
mural.cells_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
mural.cells_het$diffexpressed[mural.cells_het$avg_log2FC > 0.1 & mural.cells_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
mural.cells_het$diffexpressed[mural.cells_het$avg_log2FC < -0.1 & mural.cells_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = mural.cells_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(mural.cells_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
mural.cells_het$delabel <- NA
mural.cells_het$delabel[mural.cells_het$diffexpressed != "NO"] <- mural.cells_het$gene[mural.cells_het$diffexpressed != "NO"]
ggplot(data = mural.cells_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```

---opcs---
```{r}
# subset seurat object for each cell type
opcs <- subset(x = cerebral_int_celltypes, idents = "oligodendrocyte.precursor.cells")
Idents(opcs) <- opcs@meta.data$type
opcs_data <- FindAllMarkers(opcs, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(opcs_data, n = 5)
```

```{r}
opcs_het <- opcs_data[opcs_data$p_val < 0.5 & opcs_data$avg_log2FC > 0.1 | opcs_data$avg_log2FC < -0.1, ]
opcs_het <- opcs_het[opcs_het$cluster == "heterozygous", ]

p <- ggplot(data = opcs_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
opcs_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
opcs_het$diffexpressed[opcs_het$avg_log2FC > 0.1 & opcs_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
opcs_het$diffexpressed[opcs_het$avg_log2FC < -0.1 & opcs_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = opcs_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(opcs_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
opcs_het$delabel <- NA
opcs_het$delabel[opcs_het$diffexpressed != "NO"] <- opcs_het$gene[opcs_het$diffexpressed != "NO"]
ggplot(data = opcs_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---oligodendrocytes---
```{r}
# subset seurat object for each cell type
oligo <- subset(x = cerebral_int_celltypes, idents = "oligodendrocytes")
Idents(oligo) <- oligo@meta.data$type
oligodendrocytes_data <- FindAllMarkers(oligo, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(oligodendrocytes_data, n = 5)
```

```{r}
oligodendrocytes_het <- oligodendrocytes_data[oligodendrocytes_data$p_val < 0.5 & oligodendrocytes_data$avg_log2FC > 0.1 | oligodendrocytes_data$avg_log2FC < -0.1, ]
oligodendrocytes_het <- oligodendrocytes_het[oligodendrocytes_het$cluster == "heterozygous", ]

p <- ggplot(data = oligodendrocytes_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
oligodendrocytes_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
oligodendrocytes_het$diffexpressed[oligodendrocytes_het$avg_log2FC > 0.1 & oligodendrocytes_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
oligodendrocytes_het$diffexpressed[oligodendrocytes_het$avg_log2FC < -0.1 & oligodendrocytes_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = oligodendrocytes_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(oligodendrocytes_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
oligodendrocytes_het$delabel <- NA
oligodendrocytes_het$delabel[oligodendrocytes_het$diffexpressed != "NO"] <- oligodendrocytes_het$gene[oligodendrocytes_het$diffexpressed != "NO"]
ggplot(data = oligodendrocytes_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```

---fibroblasts---
```{r}
# subset seurat object for each cell type
fibro <- subset(x = cerebral_int_celltypes, idents = "fibroblasts")
Idents(fibro) <- fibro@meta.data$type
fibroblasts_data <- FindAllMarkers(fibro, logfc.threshold = 0.1, test.use = "wilcox", only.pos = FALSE, assay = "RNA")
head(fibroblasts_data, n = 5)
```



```{r}
fibroblasts_het <- fibroblasts_data[fibroblasts_data$p_val < 0.5 & fibroblasts_data$avg_log2FC > 0.1 | fibroblasts_data$avg_log2FC < -0.1, ]
fibroblasts_het <- fibroblasts_het[fibroblasts_het$cluster == "heterozygous", ]

p <- ggplot(data = fibroblasts_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
fibroblasts_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
fibroblasts_het$diffexpressed[fibroblasts_het$avg_log2FC > 0.1 & fibroblasts_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
fibroblasts_het$diffexpressed[fibroblasts_het$avg_log2FC < -0.1 & fibroblasts_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = fibroblasts_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(fibroblasts_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
fibroblasts_het$delabel <- NA
fibroblasts_het$delabel[fibroblasts_het$diffexpressed != "NO"] <- fibroblasts_het$gene[fibroblasts_het$diffexpressed != "NO"]
ggplot(data = fibroblasts_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



#### saving all DEG in heterozygous as .csv for supplementary methods:
```{r}
write.csv(astrocytes_het, here("results/seurat/DEG_astrocytes.csv"), row.names = FALSE)
write.csv(excitatory.neurons_het, here("results/seurat/DEG_excitatory.neurons.csv"), row.names = FALSE)
write.csv(inhibitory.neurons_het, here("results/seurat/DEG_inhibitory.neurons.csv"), row.names = FALSE)
write.csv(microglia_het, here("results/seurat/DEG_microglia.csv"), row.names = FALSE)
write.csv(mural.cells_het, here("results/seurat/DEG_mural.cells.csv"), row.names = FALSE)
write.csv(oligodendrocytes_het, here("results/seurat/DEG_oligodendrocytes.csv"), row.names = FALSE)
write.csv(opcs_het, here("results/seurat/DEG_opcs.csv"), row.names = FALSE)
write.csv(fibroblasts_het, here("results/seurat/DEG_fibroblasts.csv"), row.names = FALSE)
```

Outputs at log2FC of 0.1, for downstream analysis 
```{r}
save(astrocytes_het, file = here("results/DEG/astrocytes_het_DEG01.Rdata"))
save(excitatory.neurons_het, file = here("results/DEG/excitatory_het_DEG01.Rdata"))
save(inhibitory.neurons_het, file = here("results/DEG/inhibitory_het_DEG01.Rdata"))
save(oligodendrocytes_het, file = here("results/DEG/oligo_het_DEG01.Rdata"))
save(opcs_het, file = here("results/DEG/opcs_het_DEG01.Rdata"))
save(mural.cells_het, file = here("results/DEG/mural_het_DEG01.Rdata"))
save(microglia_het, file = here("results/DEG/micro_het_DEG01.Rdata"))
save(fibroblasts_het, file = here("results/DEG/fibro_het_DEG01.Rdata"))
```


#### plotting histrograms of log2FC at 0.1 with pvalue <0.05 in het:

```{r}
ggplot(astrocytes_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in Astro, p-value < 0.05  ")
ggplot(excitatory.neurons_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in Ex neuro")
ggplot(inhibitory.neurons_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in In neuro, p-value < 0.05  ")
ggplot(microglia_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in Micro, p-value < 0.05  ")
ggplot(mural.cells_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in Mural, p-value < 0.05  ")
ggplot(opcs_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in Opcs, p-value < 0.05  ")
ggplot(oligodendrocytes_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in Oligodendrocytes, p-value < 0.05  ")
ggplot(fibroblasts_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in Fibroblasts, p-value < 0.05  ")
```

### For loop to generate combined DEG output at log2FC threshold of 0.1:
```{r}
# specify the cell types in the data to loop through
celltypes <- levels(cerebral_int_celltypes)

# create empty dataframe to store the loop outputs within
DEGs_cerebralcells <- data.frame()

# for loop, loops through each of the 'celltypes' in cerebral and calculates the DEG between conditions (heterozygous and control)
for (i in celltypes) {
  # subset seurat data for each cerebral cell type ----------
  celltype <- subset(cerebral_int_celltypes, idents = i)
  # change the subsetted object identity to be type (heterozygous or control) so that DEG are calculated between the two conditions ------------
  Idents(celltype) <- celltype@meta.data$type
  # calculate DEGs between conditions -----------
  DEGs <- FindAllMarkers(celltype,
    logfc.threshold = 0.1,
    test.use = "wilcox",
    only.pos = FALSE,
    assay = "RNA"
  )
  # add an additional column to the df with cell type annotation (for downstream analysis purposes) -----------
  DEGs$cell_type <- i
  # combine the dataframe generated in the for loop with the entire list of all DEGs across cell types in cerebral ----------
  DEGs_cerebralcells <- rbind(DEGs_cerebralcells, DEGs)
}

write.csv(DEGs_cerebralcells, file = here("results/seurat/DEGs_cerebralcells.csv")) #written out once then commented out

DEGs_cerebralcells <- read.csv(here("results/seurat/DEGs_cerebralcells.csv"))
```


#### Heatmap of expression of regulators and targets of Setbp1 across cell types:

Setbp1 target gene list was constructed in 'Setbp1_target_list_construction.Rmd' found in /data/user/jbarham3/jw_cellspecific/jw_cellspecific/setbp1_clean/inputs/processed/setbp1_targets/
```{r}
setbp1_genes <- read.csv(here("data/processed/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1]
setbp1_genes <- append(setbp1_genes, "Setbp1")
```


# generating seurat input for complex heatmap from DGE data
resource: 
* NormalizeData, ScaleData  was not used because of https://www.embopress.org/doi/full/10.15252/msb.20188746

```{r}
# filter DEG list for just setbp1 targets
cerebral_subset <- DEGs_cerebralcells[DEGs_cerebralcells$gene %in% setbp1_genes, ]

# grab just log2fc values from DEG matrix, keep rownames and then order (below) by rowname
genes_mat <- cerebral_subset[, c("avg_log2FC", "cell_type", "gene", "cluster"), drop = FALSE]
genes_pivot <- pivot_wider(genes_mat, names_from = c("cell_type", "cluster"), values_from = "avg_log2FC", names_repair = "minimal")
genes_pivot[is.na(genes_pivot)] <- 0
rownames <- genes_pivot$gene # add gene names as rownames
genes_pivot <- genes_pivot[, -1, drop = FALSE] # drop gene column
rownames(genes_pivot) <- rownames

# grab meta data for plot:
meta <- as.data.frame(colnames(genes_pivot))
meta.data <- t(as.data.frame(strsplit(meta$`colnames(genes_pivot)`, "_")))
rownames(meta.data) <- meta$`colnames(genes_pivot)`
colnames(meta.data) <- c("cell_type", "condition")


# define order of annotations and colors:
ordered.meta.data <- meta.data[order(rownames(meta.data)), ] # order by cell type


annotation_colors <- list("condition" = c("control" = "#644DD4", "heterozygous" = "#5F9EFD"), "cell_type" = c("excitatory.neurons" = "#DC71FA", "inhibitory.neurons" = "#00BBDB", "oligodendrocytes" = "#7997FF", "astrocytes" = "#6968B4", "microglia" = "#C216B7", "oligodendrocyte.precursor.cells" = "#00C1AA", "mural.cells" = "#027461", "fibroblasts" = "#0a2f6f"))

# set heatmap annotations:
heat.anno <- HeatmapAnnotation(df = ordered.meta.data, show_annotation_name = TRUE, col = annotation_colors)


# ensure the column order of the expression data matches row order of annotation table
genes_pivot <- genes_pivot[, rownames(ordered.meta.data), drop = FALSE]
rownames(genes_pivot) <- rownames

# convert datframe to matrix
mat <- as.matrix(genes_pivot)

# plot heatmap
# Heatmap
col_fun <- colorRamp2(c(-0.5, 0, 0.5), c("purple", "black", "yellow"))
png(
  filename = here("results/figures/cortex_DEGsetbp1_heatmap.png"),
  width = 1000,
  height = 1000
)
Heatmap(mat,
  col = col_fun,
  heatmap_legend_param = list(title = "avg_log2FC"),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  column_order = NULL,
  show_row_dend = FALSE,
  show_column_dend = FALSE,
  show_row_names = TRUE,
  show_column_names = FALSE,
  use_raster = TRUE,
  raster_device = c("png"),
  bottom_annotation = NULL,
  top_annotation = heat.anno,
  column_title = "Differential Expression of Setbp1 Targets Across Cell-types in Cerebral Cortex", row_title = "Setbp1 Targets", row_title_side = "right"
)
dev.off()
```

```{r}
# run style
style_file(here("src/seurat_scripts/Setbp1_DGEcortex_07.Rmd"))
# lintr was run as well
```
