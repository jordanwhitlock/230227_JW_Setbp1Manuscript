---
title: "Setbp1_DGEkidney_07"
author: "Jordan Whitlock"
date: '2022-09-14'
output:     
  html_document:
      toc: true
      toc_depth: 2
      toc_float: true
---

This analysis comes after 'Setbp1_CellTypesKidney_06.Rmd' and precedes 'Setbp1_PathwayAnalysisCortexKidney_08.Rmd'

# *Single-nuclei analysis: Identify DEG in Kidney data*


## Code: 

Accompanying dry lab notebook for this analysis is here: https://docs.google.com/document/d/1FO_Je9oxbBFF9S_k-8tVF2t4ba88O4C77sw1v7DIFec/edit?usp=sharing

#### Loading in libraries:
```{r}
set.seed(2178)
library(Seurat)
library(SeuratObject)
library(ggplot2)
library(tidyr)
library(dplyr)
library(ComplexHeatmap)
library(circlize)
library(here)
library(styler)
library(lintr)
source(here("src/functions/functions.R"))
```

#### Loading in the object:
```{r}
load(here("data/kidney_integrated_celltypes.Rdata"))

Idents(kidney_int_celltypes) <- "cell_type"
```

#### checking to see if Setbp1 is even in the seurat object:

It is present in the data, but appears very similar across conditions.
```{r}
# visualize with FeaturePlot
plot <- FeaturePlot(kidney_int_celltypes, feature = "Setbp1",
                    reduction = "umap_harmony",
                    split.by = "type", label = TRUE)
plot
# Vln Plot of expression
VlnPlot(kidney_int_celltypes, features = "Setbp1", split.by = "type")
```
#### split violin plotting of setbp1 across celltypes
```{r}
# grabbing the Setbp1 expression data and moving from S4 to a dataframe
setbp1_exp <- FetchData(kidney_int_celltypes, 
                        vars = c("Setbp1", "cell_type", "type"))
colnames(setbp1_exp) <- c("Expression", "cell_type", "type")

png(
  filename = here("results/figures/kidney_setbp1_splitviolin.png"),
  width = 1500,
  height = 1000
)
ggplot(setbp1_exp, aes(cell_type, Expression, fill = type)) +
  geom_split_violin() +
  theme_bw() +
  ggtitle("Setbp1 Expression across Kidney") +
  scale_fill_manual(values = c("control" = "#FE6100", "heterozygous" = "#FFB000"))
dev.off()
```




#### Calculating DGE by cell type: log2FC of 0.1

---B.lymphocytes---
```{r}
# subset seurat object for each cell type
blymph <- subset(x = kidney_int_celltypes, idents = "B.lymphocytes")
Idents(blymph) <- blymph@meta.data$type
blymph_data <- FindAllMarkers(blymph,
                              logfc.threshold = 0.1,
                              test.use = "wilcox",
                              only.pos = FALSE,
                              assay = "RNA")
head(blymph_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
blymph_het <- blymph_data[blymph_data$p_val < 0.5 & 
                            blymph_data$avg_log2FC > 0.1 | 
                            blymph_data$avg_log2FC < -0.1, ]
blymph_het <- blymph_het[blymph_het$cluster == "heterozygous", ]

p <- ggplot(data = blymph_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
blymph_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
blymph_het$diffexpressed[blymph_het$avg_log2FC > 0.1 & 
                           blymph_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
blymph_het$diffexpressed[blymph_het$avg_log2FC < -0.1 & 
                           blymph_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = blymph_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(blymph_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
blymph_het$delabel <- NA
blymph_het$delabel[blymph_het$diffexpressed != "NO"] <- blymph_het$gene[blymph_het$diffexpressed != "NO"]
ggplot(data = blymph_het, 
       aes(x = avg_log2FC,y = -log10(p_val), 
           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```

---Collecting Duct Intercalating Cells Type A---
```{r}
# subset seurat object for each cell type
CDIC.A <- subset(x = kidney_int_celltypes, idents = "CD.IC.typeA")
Idents(CDIC.A) <- CDIC.A@meta.data$type
CDIC.A_data <- FindAllMarkers(CDIC.A,
                              logfc.threshold = 0.1,
                              test.use = "wilcox",
                              only.pos = FALSE,
                              assay = "RNA")
head(CDIC.A_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
CDIC.A_het <- CDIC.A_data[CDIC.A_data$p_val < 0.5 & 
                            CDIC.A_data$avg_log2FC > 0.1 | 
                            CDIC.A_data$avg_log2FC < -0.1, ]
CDIC.A_het <- CDIC.A_het[CDIC.A_het$cluster == "heterozygous", ]

p <- ggplot(data = CDIC.A_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
CDIC.A_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
CDIC.A_het$diffexpressed[CDIC.A_het$avg_log2FC > 0.1 & 
                           CDIC.A_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
CDIC.A_het$diffexpressed[CDIC.A_het$avg_log2FC < -0.1 & 
                           CDIC.A_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = CDIC.A_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(CDIC.A_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
CDIC.A_het$delabel <- NA
CDIC.A_het$delabel[CDIC.A_het$diffexpressed != "NO"] <- CDIC.A_het$gene[CDIC.A_het$diffexpressed != "NO"]
ggplot(data = CDIC.A_het, 
       aes(x = avg_log2FC, y = -log10(p_val), 
           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---Collecting Duct Intercalating Cells Type B---
```{r}
# subset seurat object for each cell type
CDIC.B <- subset(x = kidney_int_celltypes, idents = "CD.IC.typeB")
Idents(CDIC.B) <- CDIC.B@meta.data$type
CDIC.B_data <- FindAllMarkers(CDIC.B,
                              logfc.threshold = 0.1,
                              test.use = "wilcox",
                              only.pos = FALSE,
                              assay = "RNA")
head(CDIC.B_data, n = 5)
```



```{r}
CDIC.B_het <- CDIC.B_data[CDIC.B_data$p_val < 0.5 & 
                            CDIC.B_data$avg_log2FC > 0.1 | 
                            CDIC.B_data$avg_log2FC < -0.1, ]
CDIC.B_het <- CDIC.B_het[CDIC.B_het$cluster == "heterozygous", ]

p <- ggplot(data = CDIC.B_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + 
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
CDIC.B_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
CDIC.B_het$diffexpressed[CDIC.B_het$avg_log2FC > 0.1 & 
                           CDIC.B_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
CDIC.B_het$diffexpressed[CDIC.B_het$avg_log2FC < -0.1 & 
                           CDIC.B_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = CDIC.B_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(CDIC.B_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
CDIC.B_het$delabel <- NA
CDIC.B_het$delabel[CDIC.B_het$diffexpressed != "NO"] <- CDIC.B_het$gene[CDIC.B_het$diffexpressed != "NO"]
ggplot(data = CDIC.B_het, 
       aes(x = avg_log2FC, y = -log10(p_val), 
           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



---Collecting Duct Principal Cells---
```{r}
# subset seurat object for each cell type
CD.PC <- subset(x = kidney_int_celltypes, idents = "CD.PC")
Idents(CD.PC) <- CD.PC@meta.data$type
CD.PC_data <- FindAllMarkers(CD.PC,
                             logfc.threshold = 0.1,
                             test.use = "wilcox",
                             only.pos = FALSE,
                             assay = "RNA")
head(CD.PC_data, n = 5)
```



```{r}
CD.PC_het <- CD.PC_data[CD.PC_data$p_val < 0.5 & 
                          CD.PC_data$avg_log2FC > 0.1 | 
                          CD.PC_data$avg_log2FC < -0.1, ]
CD.PC_het <- CD.PC_het[CD.PC_het$cluster == "heterozygous", ]

p <- ggplot(data = CD.PC_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + 
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
CD.PC_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
CD.PC_het$diffexpressed[CD.PC_het$avg_log2FC > 0.1 & 
                          CD.PC_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
CD.PC_het$diffexpressed[CD.PC_het$avg_log2FC < -0.1 & 
                          CD.PC_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = CD.PC_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(CD.PC_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
CD.PC_het$delabel <- NA
CD.PC_het$delabel[CD.PC_het$diffexpressed != "NO"] <- CD.PC_het$gene[CD.PC_het$diffexpressed != "NO"]
ggplot(data = CD.PC_het, 
       aes(x = avg_log2FC, y = -log10(p_val), 
           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



---Distal Convoluted Tubule---
```{r}
# subset seurat object for each cell type
DCT <- subset(x = kidney_int_celltypes, idents = "DCT")
Idents(DCT) <- DCT@meta.data$type
DCT_data <- FindAllMarkers(DCT,
                           logfc.threshold = 0.1,
                           test.use = "wilcox",
                           only.pos = FALSE,
                           assay = "RNA")
head(DCT_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
DCT_het <- DCT_data[DCT_data$p_val < 0.5 & 
                      DCT_data$avg_log2FC > 0.1 | DCT_data$avg_log2FC < -0.1, ]
DCT_het <- DCT_het[DCT_het$cluster == "heterozygous", ]

p <- ggplot(data = DCT_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + 
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
DCT_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
DCT_het$diffexpressed[DCT_het$avg_log2FC > 0.1 & DCT_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
DCT_het$diffexpressed[DCT_het$avg_log2FC < -0.1 & DCT_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = DCT_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(DCT_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
DCT_het$delabel <- NA
DCT_het$delabel[DCT_het$diffexpressed != "NO"] <- DCT_het$gene[DCT_het$diffexpressed != "NO"]
ggplot(data = DCT_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---Distal Loop of Henle---
```{r}
# subset seurat object for each cell type
DLH <- subset(x = kidney_int_celltypes, idents = "DLH")
Idents(DLH) <- DLH@meta.data$type
DLH_data <- FindAllMarkers(DLH,
                           logfc.threshold = 0.1,
                           test.use = "wilcox",
                           only.pos = FALSE,
                           assay = "RNA")
head(DLH_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
DLH_het <- DLH_data[DLH_data$p_val < 0.5 & 
                      DLH_data$avg_log2FC > 0.1 | DLH_data$avg_log2FC < -0.1, ]
DLH_het <- DLH_het[DLH_het$cluster == "heterozygous", ]

p <- ggplot(data = DLH_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + 
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
DLH_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
DLH_het$diffexpressed[DLH_het$avg_log2FC > 0.1 & DLH_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
DLH_het$diffexpressed[DLH_het$avg_log2FC < -0.1 & DLH_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = DLH_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(DLH_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
DLH_het$delabel <- NA
DLH_het$delabel[DLH_het$diffexpressed != "NO"] <- DLH_het$gene[DLH_het$diffexpressed != "NO"]
ggplot(data = DLH_het, aes(x = avg_log2FC, y = -log10(p_val), 
                           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



---Endothelial---
```{r}
# subset seurat object for each cell type
endo <- subset(x = kidney_int_celltypes, idents = "endothelial")
Idents(endo) <- endo@meta.data$type
endo_data <- FindAllMarkers(endo,
                            logfc.threshold = 0.1,
                            test.use = "wilcox",
                            only.pos = FALSE,
                            assay = "RNA")
head(endo_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
endo_het <- endo_data[endo_data$p_val < 0.5 & 
                        endo_data$avg_log2FC > 0.1 | endo_data$avg_log2FC < -0.1, ]
endo_het <- endo_het[endo_het$cluster == "heterozygous", ]

p <- ggplot(data = endo_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + 
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
endo_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
endo_het$diffexpressed[endo_het$avg_log2FC > 0.1 & 
                         endo_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
endo_het$diffexpressed[endo_het$avg_log2FC < -0.1 & 
                         endo_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = endo_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(endo_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
endo_het$delabel <- NA
endo_het$delabel[endo_het$diffexpressed != "NO"] <- endo_het$gene[endo_het$diffexpressed != "NO"]
ggplot(data = endo_het, 
       aes(x = avg_log2FC, y = -log10(p_val), 
           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



---Fibroblasts---
```{r}
# subset seurat object for each cell type
fibro <- subset(x = kidney_int_celltypes, idents = "fibroblasts")
Idents(fibro) <- fibro@meta.data$type
fibro_data <- FindAllMarkers(fibro,
                             logfc.threshold = 0.1,
                             test.use = "wilcox",
                             only.pos = FALSE,
                             assay = "RNA")
head(fibro_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
fibro_het <- fibro_data[fibro_data$p_val < 0.5 & 
                          fibro_data$avg_log2FC > 0.1 | 
                          fibro_data$avg_log2FC < -0.1, ]
fibro_het <- fibro_het[fibro_het$cluster == "heterozygous", ]

p <- ggplot(data = fibro_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + 
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
fibro_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
fibro_het$diffexpressed[fibro_het$avg_log2FC > 0.1 & 
                          fibro_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
fibro_het$diffexpressed[fibro_het$avg_log2FC < -0.1 & 
                          fibro_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = fibro_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(fibro_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
fibro_het$delabel <- NA
fibro_het$delabel[fibro_het$diffexpressed != "NO"] <- fibro_het$gene[fibro_het$diffexpressed != "NO"]
ggplot(data = fibro_het, 
       aes(x = avg_log2FC, y = -log10(p_val), 
           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---LOH---
```{r}
# subset seurat object for each cell type
LOH <- subset(x = kidney_int_celltypes, idents = "LOH")
Idents(LOH) <- LOH@meta.data$type
LOH_data <- FindAllMarkers(LOH,
                           logfc.threshold = 0.1,
                           test.use = "wilcox",
                           only.pos = FALSE,
                           assay = "RNA")
head(LOH_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
LOH_het <- LOH_data[LOH_data$p_val < 0.5 & 
                      LOH_data$avg_log2FC > 0.1 | LOH_data$avg_log2FC < -0.1, ]
LOH_het <- LOH_het[LOH_het$cluster == "heterozygous", ]

p <- ggplot(data = LOH_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + 
  geom_hline(yintercept = -log10(0.05), col = "red")
p2

# add column to data to indicate if DE or not:
LOH_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
LOH_het$diffexpressed[LOH_het$avg_log2FC > 0.1 & LOH_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
LOH_het$diffexpressed[LOH_het$avg_log2FC < -0.1 & LOH_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = LOH_het, 
            aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(LOH_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: create a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label points:
LOH_het$delabel <- NA
LOH_het$delabel[LOH_het$diffexpressed != "NO"] <- LOH_het$gene[LOH_het$diffexpressed != "NO"]
ggplot(data = LOH_het, 
       aes(x = avg_log2FC, y = -log10(p_val), 
           col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---macrophages---
```{r}
# subset seurat object for each cell type
macro <- subset(x = kidney_int_celltypes, idents = "macrophages")
Idents(macro) <- macro@meta.data$type
macro_data <- FindAllMarkers(macro,
                             logfc.threshold = 0.1,
                             test.use = "wilcox",
                             only.pos = FALSE,
                             assay = "RNA")
head(macro_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
macro_het <- macro_data[macro_data$p_val < 0.5 & macro_data$avg_log2FC > 0.1 | macro_data$avg_log2FC < -0.1, ]
macro_het <- macro_het[macro_het$cluster == "heterozygous", ]

p <- ggplot(data = macro_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
macro_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
macro_het$diffexpressed[macro_het$avg_log2FC > 0.1 & macro_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
macro_het$diffexpressed[macro_het$avg_log2FC < -0.1 & macro_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = macro_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(macro_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: ceate a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label poitns:
macro_het$delabel <- NA
macro_het$delabel[macro_het$diffexpressed != "NO"] <- macro_het$gene[macro_het$diffexpressed != "NO"]
ggplot(data = macro_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



---Proximal Convoluted Tubule Segment 1---
```{r}
# subset seurat object for each cell type
PCT.S1 <- subset(x = kidney_int_celltypes, idents = "PCT.S1")
Idents(PCT.S1) <- PCT.S1@meta.data$type
PCT.S1_data <- FindAllMarkers(PCT.S1,
                              logfc.threshold = 0.1,
                              test.use = "wilcox",
                              only.pos = FALSE,
                              assay = "RNA")
head(PCT.S1_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
PCT.S1_het <- PCT.S1_data[PCT.S1_data$p_val < 0.5 & PCT.S1_data$avg_log2FC > 0.1 | PCT.S1_data$avg_log2FC < -0.1, ]
PCT.S1_het <- PCT.S1_het[PCT.S1_het$cluster == "heterozygous", ]

p <- ggplot(data = PCT.S1_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
PCT.S1_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
PCT.S1_het$diffexpressed[PCT.S1_het$avg_log2FC > 0.1 & PCT.S1_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
PCT.S1_het$diffexpressed[PCT.S1_het$avg_log2FC < -0.1 & PCT.S1_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = PCT.S1_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(PCT.S1_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: ceate a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label poitns:
PCT.S1_het$delabel <- NA
PCT.S1_het$delabel[PCT.S1_het$diffexpressed != "NO"] <- PCT.S1_het$gene[PCT.S1_het$diffexpressed != "NO"]
ggplot(data = PCT.S1_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---podocytes---
```{r}
# subset seurat object for each cell type
podo <- subset(x = kidney_int_celltypes, idents = "podocytes")
Idents(podo) <- podo@meta.data$type
podo_data <- FindAllMarkers(podo,
                            logfc.threshold = 0.1,
                            test.use = "wilcox",
                            only.pos = FALSE,
                            assay = "RNA")
head(podo_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
podo_het <- podo_data[podo_data$p_val < 0.5 & podo_data$avg_log2FC > 0.1 | podo_data$avg_log2FC < -0.1, ]
podo_het <- podo_het[podo_het$cluster == "heterozygous", ]

p <- ggplot(data = podo_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
podo_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
podo_het$diffexpressed[podo_het$avg_log2FC > 0.1 & podo_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
podo_het$diffexpressed[podo_het$avg_log2FC < -0.1 & podo_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = podo_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(podo_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: ceate a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label poitns:
podo_het$delabel <- NA
podo_het$delabel[podo_het$diffexpressed != "NO"] <- podo_het$gene[podo_het$diffexpressed != "NO"]
ggplot(data = podo_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```


---Proximal Straight Tubule---
```{r}
# subset seurat object for each cell type
PST <- subset(x = kidney_int_celltypes, idents = "PST")
Idents(PST) <- PST@meta.data$type
PST_data <- FindAllMarkers(PST,
                           logfc.threshold = 0.1,
                           test.use = "wilcox",
                           only.pos = FALSE,
                           assay = "RNA")
head(PST_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
PST_het <- PST_data[PST_data$p_val < 0.5 & PST_data$avg_log2FC > 0.1 | PST_data$avg_log2FC < -0.1, ]
PST_het <- PST_het[PST_het$cluster == "heterozygous", ]

p <- ggplot(data = PST_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
PST_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
PST_het$diffexpressed[PST_het$avg_log2FC > 0.1 & PST_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
PST_het$diffexpressed[PST_het$avg_log2FC < -0.1 & PST_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = PST_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(PST_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: ceate a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label poitns:
PST_het$delabel <- NA
PST_het$delabel[PST_het$diffexpressed != "NO"] <- PST_het$gene[PST_het$diffexpressed != "NO"]
ggplot(data = PST_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```



---pericytes---
```{r}
# subset seurat object for each cell type
pericytes <- subset(x = kidney_int_celltypes, idents = "pericytes")
Idents(pericytes) <- pericytes@meta.data$type
pericytes_data <- FindAllMarkers(pericytes,
                                 logfc.threshold = 0.1,
                                 test.use = "wilcox",
                                 only.pos = FALSE,
                                 assay = "RNA")
head(pericytes_data, n = 5)
```



```{r}
# plotting just the DEG from Het:
pericytes_het <- pericytes_data[pericytes_data$p_val < 0.5 & pericytes_data$avg_log2FC > 0.1 | pericytes_data$avg_log2FC < -0.1, ]
pericytes_het <- pericytes_het[pericytes_het$cluster == "heterozygous", ]

p <- ggplot(data = pericytes_het, aes(x = avg_log2FC, y = -log10(p_val))) +
  geom_point() +
  theme_minimal()
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") + geom_hline(yintercept = -log10(0.05), col = "red")
p2
# add column to data to indicate if DE or not:
pericytes_het$diffexpressed <- "NO"
# if log2Foldchange > 0.1 and pvalue < 0.05, set as "UP"
pericytes_het$diffexpressed[pericytes_het$avg_log2FC > 0.1 & pericytes_het$p_val < 0.05] <- "UP"
# if log2Foldchange < -0.1 and pvalue < 0.05, set as "DOWN"
pericytes_het$diffexpressed[pericytes_het$avg_log2FC < -0.1 & pericytes_het$p_val < 0.05] <- "DOWN"
# Re-plot but this time color the points with "diffexpressed"
p <- ggplot(data = pericytes_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed)) +
  geom_point() +
  theme_minimal()
# Add lines as before...
p2 <- p + geom_vline(xintercept = c(-0.1, 0.1), col = "red") +
  geom_hline(yintercept = -log10(0.05), col = "red")
p2
x <- subset(pericytes_het, gene == "Setbp1")
p4 <- p + geom_point(data = x, colour = "black")
p4
## Change point color
# 1. by default, it is assigned to the categories in an alphabetical order):
p3 <- p2 + scale_color_manual(values = c("blue", "black", "red"))
# 2. to automate a bit: ceate a named vector: the values are the colors to be used, the names are the categories they will be assigned to:
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
p3 <- p2 + scale_colour_manual(values = mycolors)
p3
# label poitns:
pericytes_het$delabel <- NA
pericytes_het$delabel[pericytes_het$diffexpressed != "NO"] <- pericytes_het$gene[pericytes_het$diffexpressed != "NO"]
ggplot(data = pericytes_het, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
  geom_point() +
  geom_point() +
  theme_minimal()
```

#### plotting histrograms of log2FC at 0.1 with pvalue <0.05 in het:

```{r}
ggplot(blymph_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in blymph, p-value < 0.05")
ggplot(CDIC.A_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in CDIC.A, p-value < 0.05")
ggplot(CDIC.B_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in CDIC.B, p-value < 0.05")
ggplot(CD.PC_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in CDPC, p-value < 0.05")
ggplot(DCT_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in DCT, p-value < 0.05")
ggplot(DLH_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in DLH, p-value < 0.05")
ggplot(endo_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in endo, p-value < 0.05")
ggplot(fibro_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in fibro, p-value < 0.05")
ggplot(LOH_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in LOH, p-value < 0.05")
ggplot(macro_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in macro, p-value < 0.05")
ggplot(PCT.S1_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in PCT.S1, p-value < 0.05")
ggplot(podo_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in podo, p-value < 0.05")
ggplot(PST_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in PST, p-value < 0.05")
ggplot(pericytes_het, aes(x = avg_log2FC)) +
  geom_histogram() +
  ggtitle("Heterozygous -0.1 < Log2FC > 0.1 Distribution in pericytes, p-value < 0.05")
```

Outputs at log2FC of 0.1:
```{r}
save(blymph_het, file = here("results/DEG/blymph_het_DEG01.Rdata"))
save(CD.PC_het, file = here("results/DEG/CDPC_het_DEG01.Rdata"))
save(CDIC.A_het, file = here("results/DEG/CDICA_het_DEG01.Rdata"))
save(CDIC.B_het, file = here("results/DEG/CDICB_het_DEG01.Rdata"))
save(DCT_het, file = here("results/DEG/DCT_het_DEG01.Rdata"))
save(DLH_het, file = here("results/DEG/DLH_het_DEG01.Rdata"))
save(endo_het, file = here("results/DEG/endo_het_DEG01.Rdata"))
save(fibro_het, file = here("results/DEG/fibro_het_DEG01.Rdata"))
save(LOH_het, file = here("results/DEG/LOH_het_DEG01.Rdata"))
save(macro_het, file = here("results/DEG/macro_het_DEG01.Rdata"))
save(PCT.S1_het, file = here("results/DEG/PCTS1_het_DEG01.Rdata"))
save(podo_het, file = here("results/DEG/podo_het_DEG01.Rdata"))
save(PST_het, file = here("results/DEG/PST_het_DEG01.Rdata"))
save(pericytes_het, file = here("results/DEG/pericytes_het_DEG01.Rdata"))
```

#### saving all DEG in heterozygous as .csv for supplementary methods:
```{r}
write.csv(blymph_het, here("results/seurat/DEG_blymph.csv"), row.names = FALSE)
write.csv(CD.PC_het, here("results/seurat/DEG_CD.PC.csv"), row.names = FALSE)
write.csv(CDIC.A_het, here("results/seurat/DEG_CDIC.A.csv"), row.names = FALSE)
write.csv(CDIC.B_het, here("results/seurat/DEG_CDIC.B.csv"), row.names = FALSE)
write.csv(DCT_het, here("results/seurat/DEG_DCT.csv"), row.names = FALSE)
write.csv(DLH_het, here("results/seurat/DEG_DLH.csv"), row.names = FALSE)
write.csv(endo_het, here("results/seurat/DEG_endo.csv"), row.names = FALSE)
write.csv(fibro_het, here("results/seurat/DEG_fibro.csv"), row.names = FALSE)
write.csv(LOH_het, here("results/seurat/DEG_LOH.csv"), row.names = FALSE)
write.csv(macro_het, here("results/seurat/DEG_macro.csv"), row.names = FALSE)
write.csv(PCT.S1_het, here("results/seurat/DEG_PCT.S1.csv"), row.names = FALSE)
write.csv(podo_het, here("results/seurat/DEG_podo.csv"), row.names = FALSE)
write.csv(PST_het, here("results/seurat/DEG_PST.csv"), row.names = FALSE)
write.csv(pericytes_het, here("results/seurat/DEG_pericytes.csv"), row.names = FALSE)
```

### For loop to generate DEG output at log2FC threshold of 0.1 :
```{r}
# specify the cell types in the data to loop through
celltypes <- levels(kidney_int_celltypes)

# create empty dataframe to store the loop outputs within
DEGs_kidneycells <- data.frame()

# for loop, loops through each of the 'celltypes' in kidney and calulates the DEG between conditions (heterozygous and control)
for (i in celltypes) {
  # subset seurat data for each kidney cell type ----------
  celltype <- subset(kidney_int_celltypes, idents = i)
  # change the subsetted object identity to be type (heterozygous or control) so that DEG are calculated between the two conditions ------------
  Idents(celltype) <- celltype@meta.data$type
  # calculate DEGs between conditions -----------
  DEGs <- FindAllMarkers(celltype,
    logfc.threshold = 0.1,
    test.use = "wilcox",
    only.pos = FALSE,
    assay = "RNA"
  )
  # add an additional column to the df with celltype annotation (for downstream analysis purposes) -----------
  DEGs$cell_type <- i
  # combine the dataframe generated in the for loop with the entire list of all DEGs across cell types in kidney ----------
  DEGs_kidneycells <- rbind(DEGs_kidneycells, DEGs)
}

write.csv(DEGs_kidneycells, file = here("results/ts_results/seurat/DEGs_kidneycells.csv")) # written out once then commented out
# DEGs_kidneycells <- read.csv(here("results/seurat/DEGs_kidneycells.csv"))
```


#### Heatmap of expression of regulators and targets of Setbp1 across cell types:
Setbp1 target gene list was constructed in 'Setbp1_target_list_construction.Rmd' 
```{r}
setbp1_genes <- read.csv(here("data/processed/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1]
setbp1_genes <- append(setbp1_genes, "Setbp1")
```

#generating seurat input for complex heatmap from DGE data
```{r}
# filter DEG list for just setbp1 targets
kidney_subset <- DEGs_kidneycells[DEGs_kidneycells$gene %in% setbp1_genes, ]

# grab just log2fc values from DEG matrix, keep rownames and then order (below) by rowname
genes_mat <- kidney_subset[, c("avg_log2FC", "cell_type", "gene", "cluster"),
  drop = FALSE
]
genes_pivot <- pivot_wider(genes_mat,
  names_from = c("cell_type", "cluster"),
  values_from = "avg_log2FC",
  names_repair = "minimal"
)
genes_pivot[is.na(genes_pivot)] <- 0
rownames <- genes_pivot$gene # add gene names as rownames
genes_pivot <- genes_pivot[, -1, drop = FALSE] # drop gene column
rownames(genes_pivot) <- rownames

# grab meta data for plot:
meta <- as.data.frame(colnames(genes_pivot))
meta.data <- t(as.data.frame(strsplit(meta$`colnames(genes_pivot)`, "_")))
rownames(meta.data) <- meta$`colnames(genes_pivot)`
colnames(meta.data) <- c("cell_type", "condition")


# define order of annotations and colors:
ordered.meta.data <- meta.data[order(rownames(meta.data)), ] # order by cell type


annotation_colors <- list(
  "condition" = c("control" = "#FE6100", "heterozygous" = "#FFB000"),
  "cell_type" = c(
    "endothelial" = "#CF9400",
    "PST" = "#948802",
    "PCT.S1" = "#A85A5A",
    "LOH" = "#AA937E",
    "DCT" = "#6D0404",
    "CD.PC" = "#F03F00",
    "macrophages" = "#C70F0F",
    "fibroblasts" = "#FFC8C4",
    "DLH" = "#AA6320",
    "CD.IC.typeA" = "#4E3801",
    "CD.IC.typeB" = "#EEDF37",
    "podocytes" = "#BD085E",
    "pericytes" = "#FFE196",
    "B.lymphocytes" = "#FFBE1D"
  )
)

# set heatmap annotations:
heat.anno <- HeatmapAnnotation(
  df = ordered.meta.data,
  show_annotation_name = TRUE,
  col = annotation_colors
)


# ensure the column order of the expression data matches row order of annotation table
genes_pivot <- genes_pivot[, rownames(ordered.meta.data), drop = FALSE]
rownames(genes_pivot) <- rownames

# convert datframe to matrix
mat <- as.matrix(genes_pivot)

# plot heatmap
# Heatmap
col_fun <- colorRamp2(c(-1, 0, 1), c("purple", "black", "yellow"))
png(
  filename = here("results/figures/kidney_DEGsetbp1_heatmap.png"),
  width = 2000,
  height = 2000
)
Heatmap(mat,
  col = col_fun,
  heatmap_legend_param = list(title = "avg_log2FC"),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  column_order = NULL,
  show_row_dend = TRUE,
  show_column_dend = TRUE,
  show_row_names = TRUE,
  show_column_names = FALSE,
  use_raster = TRUE,
  raster_device = c("png"),
  bottom_annotation = NULL,
  top_annotation = heat.anno,
  column_title = "Differential Expression of Setbp1 Targets Across Cell-types in Kidney", row_title = "Setbp1 Targets", row_title_side = "right"
)
dev.off()
```

```{r}
sessionInfo()
```

```{r}
# run style
style_file(here("src/seurat_scripts/Setbp1_DGEkidney_07.Rmd"))
# lintr was run as well
```
