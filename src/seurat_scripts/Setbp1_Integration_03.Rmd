---
title: "Setbp1_Integration_03"
author: "Jordan Whitlock"
date: '2022-09-06'
output:     
  html_document:
      toc: true
      toc_depth: 2
      toc_float: true
---

This analysis follows 'Setbp1_DoubletFinder_02.Rmd'. 

### Loading in all required libraries
```{r}
set.seed(2178)
library(devtools)
library(magrittr)
library(SingleCellExperiment)
library(readr)
library(dplyr)
library(Matrix)
library(Seurat)
library(cowplot)
library(ggplot2)
library(tidyverse)
library(kBET)
library(DoubletFinder)
library(harmony)
library(clustree)
library(purrr)
library(edgeR)
library(here)
library(styler)
library(lintr)
```


# Load in the object after doublets are removed
```{r load-cortex-object}
load(here("data/nodoublet_setbp1_cerebral_seurat.Rdata")) # cerebral_seurat_filtered
```

```{r load-kidney-object}
load(here("data/nodoublet_setbp1_kidney_seurat.Rdata")) # kidney_seurat_filtered
```

### Normalize FindVariableFeatures and Integrate -- Harmony

#### normalize data:
```{r normalize-kidney}
kidney_seurat_filtered <- NormalizeData(kidney_seurat_filtered)
```

```{r normalize-cortex}
cerebral_seurat_filtered <- NormalizeData(cerebral_seurat_filtered)
```


#### feature selection:

```{r variable-features-kidney}
suppressWarnings(suppressMessages(kidney_seurat_filtered <- FindVariableFeatures(
  kidney_seurat_filtered,
  selection.method = "vst",
  nfeatures = 4000,
  verbose = FALSE,
  assay = "RNA"
))) # changed from std 2000 for nFeatures based on data distribution



top20_kidney <- head(VariableFeatures(kidney_seurat_filtered), 20)
LabelPoints(
  plot = VariableFeaturePlot(kidney_seurat_filtered),
  points = top20_kidney,
  repel = TRUE
)
```

```{r variable-features-cortex}
suppressWarnings(suppressMessages(cerebral_seurat_filtered <- FindVariableFeatures(
  cerebral_seurat_filtered,
  selection.method = "vst",
  nfeatures = 4000,
  verbose = FALSE,
  assay = "RNA"
))) # changed from std 2000 for nFeatures based on data distribution

top20_cerebral <- head(VariableFeatures(cerebral_seurat_filtered), 20)
LabelPoints(
  plot = VariableFeaturePlot(cerebral_seurat_filtered),
  points = top20_cerebral,
  repel = TRUE
)
```


#### scale data: z-score transformation

```{r scale-kidney}
kidney_seurat_filtered <- ScaleData(
  kidney_seurat_filtered,
  vars.to.regress = c("percent_mito", "nFeature_RNA"),
  assay = "RNA"
)
```


```{r scale-cortex}
cerebral_seurat_filtered <- ScaleData(
  cerebral_seurat_filtered,
  vars.to.regress = c("percent_mito", "nFeature_RNA"),
  assay = "RNA"
)
```

#### check dimensions with PCA
```{r PCA-elbow-cortex}
cerebral_seurat_filtered <- RunPCA(
  cerebral_seurat_filtered, 
  npcs = 50, 
  verbose = FALSE
) # has a seed already set in source code
ElbowPlot(cerebral_seurat_filtered, reduction = "pca", ndims = 50)
```

```{r PCA-elbow-kidney}
kidney_seurat_filtered <- RunPCA(
  kidney_seurat_filtered, 
  npcs = 50, 
  verbose = FALSE
) # has a seed set already in source code
ElbowPlot(kidney_seurat_filtered, reduction = "pca", ndims = 50)
```

#### visualize PCs:
plotting the first few
```{r visualize-PCs-cortex}
plot_grid(
  ncol = 3, 
  DimPlot(
    cerebral_seurat_filtered,
    reduction = "pca", group.by = "orig.ident",
    dims = 1:2
  ), 
  DimPlot(
    cerebral_seurat_filtered, 
    reduction = "pca", 
    group.by = "orig.ident", 
    dims = 3:4
  ),
  DimPlot(
    cerebral_seurat_filtered, 
    reduction = "pca", 
    group.by = "orig.ident", 
    dims = 29:30
  )
)
```

```{r visualize-PCs-kidney}
plot_grid(
  ncol = 3, 
  DimPlot(
    kidney_seurat_filtered,
    reduction = "pca", 
    group.by = "orig.ident",
    dims = 1:2
  ), 
  DimPlot(
    kidney_seurat_filtered, 
    reduction = "pca", 
    group.by = "orig.ident", 
    dims = 3:4
  ),
  DimPlot(
    kidney_seurat_filtered, 
    reduction = "pca", 
    group.by = "orig.ident", 
    dims = 29:30
  )
)
```

#### visualize tSNE:
```{r tSNE-cortex}
cerebral_seurat_filtered <- RunTSNE(
  cerebral_seurat_filtered,
  reduction = "pca",
  dims = 1:30,
  perplexity = 30,
  max_iter = 1000,
  theta = 0.5,
  eta = 200,
  num_threads = 0
)

plot_grid(
  ncol = 1, 
  DimPlot(cerebral_seurat_filtered, reduction = "tsne", group.by = "orig.ident")
)
```

```{r tSNE-kidney}
kidney_seurat_filtered <- RunTSNE(
  kidney_seurat_filtered,
  reduction = "pca",
  dims = 1:30,
  perplexity = 30,
  max_iter = 1000,
  theta = 0.5,
  eta = 200,
  num_threads = 0,
  seed.use = 1
)

plot_grid(
  ncol = 1, 
  DimPlot(kidney_seurat_filtered, reduction = "tsne", group.by = "orig.ident")
)
```

#### visualize the UMAP:
```{r kidney-UMAP}
kidney_seurat_filtered <- RunUMAP(
  kidney_seurat_filtered,
  reduction = "pca", 
  dims = 1:30, 
  n.components = 2, 
  n.neighbors = 30,
  n.epochs = 200, 
  min.dist = 0.3, 
  learning.rate = 1, 
  spread = 1 # note: has seed.use = 42 set as default
)

plot_grid(
  ncol = 1, 
  DimPlot(kidney_seurat_filtered, reduction = "umap", group.by = "orig.ident") +
  ggplot2::ggtitle(label = "Kidney_UMAP_on_PCA")
)
```

```{r cortex-UMAP}
cerebral_seurat_filtered <- RunUMAP(
  cerebral_seurat_filtered,
  reduction = "pca", 
  dims = 1:30, 
  n.components = 2, 
  n.neighbors = 30,
  n.epochs = 200, 
  min.dist = 0.3, learning.rate = 1, spread = 1
)

plot_grid(
  ncol = 1, 
  DimPlot(cerebral_seurat_filtered, reduction = "umap", group.by = "orig.ident") +
  ggplot2::ggtitle(label = "CerebralCortex_UMAP_on_PCA"))
```


### Integrate - using harmony

```{r kidney-harmony}
kidney_harmony <- RunHarmony(kidney_seurat_filtered,
  group.by.vars = "orig.ident", reduction = "pca",
  dims.use = 1:30, assay.use = "RNA"
)
```

```{r cortex-harmony}
cerebral_harmony <- RunHarmony(cerebral_seurat_filtered,
  group.by.vars = "orig.ident", reduction = "pca",
  dims.use = 1:30, assay.use = "RNA"
)
```

#### UMAP in harmony:
Here we use all PCs computed from Harmony for UMAP calculation
```{r visualize-harmony-UMAP-kidney}
kidney_int <- kidney_seurat_filtered
kidney_int[["harmony"]] <- kidney_harmony[["harmony"]]
kidney_int <- RunUMAP(
  kidney_int, 
  dims = 1:30, 
  reduction = "harmony", 
  reduction.name = "umap_harmony"
)
```

```{r visualize-harmony-UMAP-cortex}
cerebral_int <- cerebral_seurat_filtered
cerebral_int[["harmony"]] <- cerebral_harmony[["harmony"]]
cerebral_int <- RunUMAP(
  cerebral_int, 
  dims = 1:30, 
  reduction = "harmony", 
  reduction.name = "umap_harmony"
)
```


#### UMAP before and after harmony:

Visualizing the post-harmony integration UMAP compared to raw:
```{r compare-pre-postint-cortex}
# cerebral
p1 <- DimPlot(
  cerebral_seurat_filtered, 
  reduction = "umap", 
  group.by = "orig.ident"
) + ggtitle("Cerebral UMAP raw_data")
p2 <- DimPlot(
  cerebral_int, 
  reduction = "umap_harmony", 
  group.by = "orig.ident"
) + ggtitle("Cerebral UMAP Harmony")
leg <- get_legend(p1)
gridExtra::grid.arrange(
  gridExtra::arrangeGrob(p1 + NoLegend() + NoAxes(), p2 + NoLegend() +
    NoAxes(), nrow = 2),
  leg,
  ncol = 2, widths = c(8, 2)
)
```

```{r compare-pre-postint-kidney}
# kidney
p3 <- DimPlot(
  kidney_seurat_filtered, 
  reduction = "umap", 
  group.by = "orig.ident"
) +
  ggtitle("Kidney UMAP raw data")
p4 <- DimPlot(
  kidney_int, 
  reduction = "umap_harmony", 
  group.by = "orig.ident"
) +
  ggtitle("Kidney UMAP Harmony")
leg <- get_legend(p3)
gridExtra::grid.arrange(
  gridExtra::arrangeGrob(p3 + NoLegend() + NoAxes(), p4 + NoLegend() +
    NoAxes(), nrow = 2),
  leg,
  ncol = 2, widths = c(8, 2)
)
```

#### save integrated objects, can start from here:
```{r save-kidney-object}
save(kidney_int, file = here("data/integrated_setbp1_kidney.Rdata"))
```

```{r save-cortex-object}
save(cerebral_int, file = here("data/integrated_setbp1_cerebral.Rdata"))
```

```{r}
sessionInfo()
```

```{r}
# run style
style_file(here("src/seurat_scripts/Setbp1_Integration_03.Rmd"))
# lintr was run as well
```


This analysis is followed by 'Setbp1_Clustering_04.Rmd'


